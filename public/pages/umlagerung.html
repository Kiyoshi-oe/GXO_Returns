<!DOCTYPE html>
<html lang="de">
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>LVS Returns</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/GXO_logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/GXO_logo.png">
  
  <!-- Externes CSS -->
  <link rel="stylesheet" href="/css/style.css">
  
  <!-- Chart.js f√ºr Diagramme -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
  <div class="loading-logo-container">
    <div class="loading-ring-2"></div>
    <div class="loading-ring"></div>
    <img src="/images/GXO_logo.png" alt="GXO" class="loading-logo">
  </div>
  <div class="loading-text">
    <span class="gxo-text">GXO</span> <span class="returns-text">Returns</span>
  </div>
  <div class="loading-subtitle">
    <span class="loading-dots"></span>
  </div>
</div>

<!-- Image Lightbox -->
<div id="imageLightbox" class="lightbox">
  <span class="lightbox-close">&times;</span>
  <img id="lightboxImage" class="lightbox-content" src="" alt="Label Vollansicht">
</div>

<!-- Custom Modal -->
<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <span class="custom-modal-icon" id="modalIcon">‚ÑπÔ∏è</span>
      <span class="custom-modal-title" id="modalTitle">Information</span>
      <span class="custom-modal-close" id="modalClose">&times;</span>
    </div>
    <div class="custom-modal-body" id="modalBody">
      Nachricht hier
    </div>
    <div class="custom-modal-footer">
      <button class="btn btn-primary" id="modalOkBtn">OK</button>
      <button class="btn btn-ghost" id="modalCancelBtn" style="display:none;">Abbrechen</button>
    </div>
  </div>
</div>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="/images/GXO_logo.png" class="sidebar-logo-img" alt="GXO">
        <span class="sidebar-logo-text-main">Returns</span>
      </div>
    </div>

    <nav class="nav">
      <div class="nav-section-title">Ansichten</div>
      <a href="/dashboard" class="nav-item ">
        <span class="nav-icon">üìä</span>
        <span>Dashboard</span>
      </a>
      <a href="/wareneingang" class="nav-item ">
        <span class="nav-icon">üì•</span>
        <span>Wareneingang</span>
      </a>
      <a href="/lagerbestand" class="nav-item ">
        <span class="nav-icon">üì¶</span>
        <span>Lagerbestand</span>
      </a>
      <a href="/umlagerung" class="nav-item active">
        <span class="nav-icon">‚ÜîÔ∏è</span>
        <span>Umlagerung</span>
      </a>
      <a href="/archive" class="nav-item ">
        <span class="nav-icon">üóÇÔ∏è</span>
        <span>Archiv</span>
      </a>
      <a href="/suche" class="nav-item ">
        <span class="nav-icon">üîç</span>
        <span>Globale Suche</span>
      </a>
    </nav>

    <div class="nav-section-title">Administration</div>
    <a href="/ra-import" class="nav-item ">
      <span class="nav-icon">üìë</span>
      <span>RA Import</span>
    </a>
    <a href="/performance" class="nav-item ">
      <span class="nav-icon">‚ö°</span>
      <span>Performance</span>
    </a>
    <a href="/einstellungen" class="nav-item ">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span>Einstellungen</span>
    </a>
    <a href="/import" class="nav-item ">
      <span class="nav-icon">üì•</span>
      <span>Datenverwaltung</span>
    </a>

    <div class="sidebar-footer">
      <div style="font-size: 11px; color: var(--text-soft);">
        LVS Returns System<br>
        Version 1.0
      </div>
    </div>
  </aside>

  <!-- Content -->
  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title" id="topbarTitle">Umlagerung</div>
        <div class="topbar-subtitle" id="topbarSubtitle">Stellplatz Wechsel von Palette oder Karton</div>
      </div>
      <div class="topbar-right" style="display: flex; align-items: center; gap: 12px;">
        <button class="btn-icon" id="themeToggle" aria-label="Ansicht wechseln">‚òæ</button>
        <div id="currentUserDisplay" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-soft); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;" onclick="toggleUserMenu()">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--gxo-orange) 0%, #FF6B3D 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;" id="userAvatar">üë§</div>
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <span style="font-size: 13px; font-weight: 600; color: var(--text-main);" id="userName">Nicht angemeldet</span>
            <span style="font-size: 11px; color: var(--text-soft); display: none;" id="userEmail">Windows-Benutzer</span>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <section class="view" id="view-move">
        <!-- Kompakte Modus-Auswahl -->
        <div class="card" style="margin-bottom: 16px; padding: 12px 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0;">
            <div>
              <div class="card-title" style="margin-bottom: 4px;">üì¶ Umlagerung</div>
              <div class="card-subtitle" style="font-size: 11px;">Kartons von einem Stellplatz zum anderen buchen</div>
            </div>
            <div style="display: flex; gap: 8px; background: var(--bg-soft); padding: 4px; border-radius: 8px; border: 1px solid var(--border-soft);">
              <button class="btn btn-sm" id="btnMoveSingle" onclick="switchMoveMode('single')" style="padding: 6px 16px; margin: 0; border: none; background: var(--gxo-orange); color: white; font-weight: 600;">
                üì¶ Einzel
              </button>
              <button class="btn btn-sm btn-ghost" id="btnMoveBulk" onclick="switchMoveMode('bulk')" style="padding: 6px 16px; margin: 0; border: none;">
                üìã Masse
              </button>
            </div>
          </div>
        </div>

        <!-- Layout: Formular links, Historie rechts -->
        <div class="move-layout">
          <!-- Linke Spalte: Formulare -->
          <div>
            <!-- Einzelbuchung -->
            <div id="moveSingleView" class="card" style="margin-bottom: 0;">
              <div class="card-header" style="margin-bottom: 12px;">
                <div>
                  <div class="card-title" style="font-size: 14px;">Einzelne Karton umlagern</div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label style="font-size: 11px;">Quell-Stellplatz</label>
                  <div class="searchable-dropdown" id="moveFromLocationDropdown">
                    <input type="text" id="moveFromLocation" placeholder="Stellplatz w√§hlen..." autocomplete="off" style="padding: 6px 9px; font-size: 12px;">
                    <div class="searchable-dropdown-list" id="moveFromLocationList"></div>
                  </div>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <label style="font-size: 11px;">Kartons ausw√§hlen</label>
                    <div style="display: flex; gap: 8px; font-size: 11px;">
                      <button type="button" class="btn btn-ghost btn-sm" onclick="selectAllCartons()" style="padding: 4px 8px; font-size: 10px;">Alle ausw√§hlen</button>
                      <button type="button" class="btn btn-ghost btn-sm" onclick="deselectAllCartons()" style="padding: 4px 8px; font-size: 10px;">Alle abw√§hlen</button>
                    </div>
                  </div>
                  <div id="moveCartonList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-soft); border-radius: 6px; padding: 8px; background: var(--bg-card);">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">
                      Bitte zuerst Quell-Stellplatz w√§hlen
                    </div>
                  </div>
                  <div id="moveCartonCount" style="margin-top: 6px; font-size: 11px; color: var(--text-soft); display: none;">
                    <span id="selectedCartonCount">0</span> Kartons ausgew√§hlt
                  </div>
                </div>
                <div class="form-group">
                  <label style="font-size: 11px;">Ziel-Stellplatz</label>
                  <div class="searchable-dropdown" id="moveToLocationDropdown">
                    <input type="text" id="moveToLocation" placeholder="Stellplatz..." autocomplete="off" style="padding: 6px 9px; font-size: 12px;">
                    <div class="searchable-dropdown-list" id="moveToLocationList"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label style="font-size: 11px;">Grund (optional)</label>
                  <input type="text" id="moveReason" placeholder="z.B. Inventur..." style="padding: 6px 9px; font-size: 12px;">
                </div>
              </div>

              <div id="moveSinglePreview" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-soft); border-radius: 8px; border-left: 4px solid var(--gxo-orange); font-size: 12px;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px;">Vorschau:</div>
                <div id="moveSinglePreviewContent"></div>
              </div>

              <div style="margin-top: 14px; display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="clearMoveForm()" style="padding: 6px 14px; font-size: 12px;">Zur√ºcksetzen</button>
                <button class="btn btn-primary btn-sm" id="btnExecuteSingleMove" onclick="executeSingleMove()" disabled style="padding: 6px 14px; font-size: 12px;">
                  ‚úÖ Durchf√ºhren
                </button>
              </div>
            </div>

            <!-- Massenbuchung -->
            <div id="moveBulkView" class="card" style="display: none; margin-bottom: 0;">
              <div class="card-header" style="margin-bottom: 12px;">
                <div>
                  <div class="card-title" style="font-size: 14px;">Massen-Umlagerung</div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label style="font-size: 11px;">Quell-Stellplatz</label>
                  <div class="searchable-dropdown" id="moveBulkFromLocationDropdown">
                    <input type="text" id="moveBulkFromLocation" placeholder="Stellplatz w√§hlen..." autocomplete="off" style="padding: 6px 9px; font-size: 12px;">
                    <div class="searchable-dropdown-list" id="moveBulkFromLocationList"></div>
                  </div>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label style="font-size: 11px;">Ziel-Stellplatz</label>
                  <div class="searchable-dropdown" id="moveBulkToLocationDropdown">
                    <input type="text" id="moveBulkToLocation" placeholder="Stellplatz w√§hlen..." autocomplete="off" style="padding: 6px 9px; font-size: 12px;">
                    <div class="searchable-dropdown-list" id="moveBulkToLocationList"></div>
                  </div>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label style="font-size: 11px;">Grund (optional)</label>
                  <input type="text" id="moveBulkReason" placeholder="z.B. Umorganisation, Inventur..." style="padding: 6px 9px; font-size: 12px;">
                </div>
              </div>

              <div id="moveBulkPreview" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-soft); border-radius: 8px; border-left: 4px solid var(--gxo-orange); font-size: 12px;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px;">Vorschau:</div>
                <div id="moveBulkPreviewContent"></div>
              </div>

              <div style="margin-top: 14px; display: flex; justify-content: flex-end; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="clearMoveForm()" style="padding: 6px 14px; font-size: 12px;">Zur√ºcksetzen</button>
                <button class="btn btn-primary btn-sm" id="btnExecuteBulkMove" onclick="executeBulkMove()" disabled style="padding: 6px 14px; font-size: 12px;">
                  ‚úÖ Durchf√ºhren
                </button>
              </div>
            </div>
          </div>

          <!-- Rechte Spalte: Historie -->
          <div class="card" style="margin-bottom: 0; height: 421px;">
            <div class="card-header" style="margin-bottom: 12px;">
              <div>
                <div class="card-title" style="font-size: 14px;">üìã Historie</div>
                <div class="card-subtitle" style="font-size: 11px;">Letzte Umlagerungen</div>
              </div>
              <div class="card-actions">
                <button class="btn btn-secondary btn-sm" onclick="loadMovementHistory()" style="padding: 4px 10px; font-size: 11px;">
                  üîÑ
                </button>
              </div>
            </div>
            
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
              <table class="data-table" style="font-size: 11px; width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; z-index: 10; background: var(--bg-soft);">
                  <tr>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">Datum</th>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">Von</th>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">Nach</th>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">Karton ID</th>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">OLPN / Tracking</th>
                    <th style="padding: 8px 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-soft); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border-soft);">Grund</th>
                  </tr>
                </thead>
                <tbody id="movementHistoryBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">
                      üîÑ Lade Historie...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section
    </main>
  </div>
</div>

<!-- Loading Screen Management -->
<script>
  (function() {
    let loadingScreenHidden = false;
    let dataLoadingComplete = false;
    let minDisplayTimeElapsed = false;
    const minDisplayTime = 2000;
    const startTime = Date.now();
    
    function hideLoadingScreen() {
      if (loadingScreenHidden) return;
      
      const elapsed = Date.now() - startTime;
      if (elapsed < minDisplayTime || !dataLoadingComplete) {
        setTimeout(hideLoadingScreen, 100);
        return;
      }
      
      loadingScreenHidden = true;
      
      try {
        const loadingScreen = document.getElementById("loadingScreen");
        if (loadingScreen) {
          loadingScreen.style.transition = "opacity 0.6s ease, visibility 0.6s ease";
          loadingScreen.style.opacity = "0";
          loadingScreen.style.visibility = "hidden";
          
          setTimeout(() => {
            loadingScreen.style.pointerEvents = "none";
            loadingScreen.style.display = "none";
            loadingScreen.style.zIndex = "-1";
          }, 600);
        }
      } catch (err) {
        console.error("Fehler beim Ausblenden:", err);
      }
    }
    
    setTimeout(() => {
      minDisplayTimeElapsed = true;
      hideLoadingScreen();
    }, minDisplayTime);
    
    window.addEventListener('load', () => {
      setTimeout(() => {
        dataLoadingComplete = true;
        hideLoadingScreen();
      }, 500);
    });
    
    setTimeout(() => {
      dataLoadingComplete = true;
      minDisplayTimeElapsed = true;
      hideLoadingScreen();
    }, 5000);
    
    window.hideLoadingScreen = hideLoadingScreen;
  })();
</script>


</div>

<script>
  const navItems = document.querySelectorAll(".nav-item");
  const views = document.querySelectorAll(".view");
  const topbarTitle = document.getElementById("topbarTitle");
  const topbarSubtitle = document.getElementById("topbarSubtitle");
  const themeToggle = document.getElementById("themeToggle");

  const viewMeta = {
    dashboard: {
      title: "Dashboard",
      subtitle: "√úberblick √ºber Lager und Retouren"
    },
    inventory: {
      title: "Lagerbestand",
      subtitle: "Stellpl√§tze mit Anzahl der Paletten und Kartons aus der Datenbank"
    },
    inbound: {
      title: "Wareneingang",
      subtitle: "Einfache Erfassung neuer Paletten und Kartons"
    },
    move: {
      title: "Umlagerung",
      subtitle: "Stellplatz Wechsel von Palette oder Karton"
    },
    archive: {
      title: "Archiv",
      subtitle: "√úbersicht archivierter Best√§nde"
    },
    ra: {
      title: "RA Import",
      subtitle: "Layout f√ºr den sp√§teren Abgleich mit Excel Bericht"
    },
    settings: {
      title: "Einstellungen",
      subtitle: "Carrier-Konfiguration und Dropdown-Optionen verwalten"
    },
    export: {
      title: "Export",
      subtitle: "Lagerbestand als Excel-Datei exportieren"
    }
  };

  function applyTheme(theme) {
    const t = theme === "light" ? "light" : "dark";
    document.body.setAttribute("data-theme", t);
    localStorage.setItem("lvsTheme", t);
    themeToggle.textContent = t === "light" ? "‚òÄ" : "‚òæ";
  }

  const savedTheme = localStorage.getItem("lvsTheme") || "dark";
  applyTheme(savedTheme);

  themeToggle.addEventListener("click", () => {
    const current = document.body.getAttribute("data-theme") || "dark";
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
  });

  // Warehouse Management System
  let warehouseData = [];
  let warehouseAreas = [];
  let expandedLocations = new Set();
  
  // Filter-Variablen
  let activeFilters = {
    location: null,
    area: [],
    cartons: { operator: 'all', value: null },
    date: { operator: 'all', value: null },
    status: { active: true, inactive: true }
  };
  
  // Excel-Filter-Variablen
  let excelSortState = {
    column: null,
    direction: null // 'asc' oder 'desc'
  };
  
  let excelTextFilters = {
    location: null,
    area: null
  };
  
  let excelNumberFilters = {
    cartons: null
  };
  
  let excelValueFilters = {
    location: [],
    area: [],
    status: []
  };
  
  // Filter-Dropdowns √∂ffnen/schlie√üen
  function toggleFilter(filterName) {
    const dropdown = document.getElementById(`filter-${filterName}`);
    if (!dropdown) return;
    
    const allDropdowns = document.querySelectorAll('.filter-dropdown');
    const allButtons = document.querySelectorAll('.filter-btn');
    
    // Alle anderen Dropdowns schlie√üen
    allDropdowns.forEach(d => {
      if (d !== dropdown) {
        d.style.display = 'none';
      }
    });
    
    // Alle Buttons deaktivieren
    allButtons.forEach(b => b.classList.remove('active'));
    
    // Aktuelles Dropdown umschalten
    if (dropdown.style.display === 'none' || !dropdown.style.display) {
      dropdown.style.display = 'block';
      const btn = dropdown.previousElementSibling;
      if (btn) btn.classList.add('active');
      
      // Bereich-Filter-Optionen f√ºllen
      if (filterName === 'area') {
        populateAreaFilterOptions();
      }
      
      // Kartons-Operator-√Ñnderung
      if (filterName === 'cartons') {
        const operator = document.getElementById('filter-cartons-operator');
        const valueInput = document.getElementById('filter-cartons-value');
        if (operator && valueInput) {
          const updateVisibility = () => {
            valueInput.style.display = ['gt', 'lt', 'eq'].includes(operator.value) ? 'block' : 'none';
          };
          operator.onchange = () => {
            updateVisibility();
            applyFilters();
          };
          updateVisibility();
        }
      }
      
      // Datum-Operator-√Ñnderung
      if (filterName === 'date') {
        const operator = document.getElementById('filter-date-operator');
        const valueInput = document.getElementById('filter-date-value');
        if (operator && valueInput) {
          const updateVisibility = () => {
            valueInput.style.display = ['before', 'after'].includes(operator.value) ? 'block' : 'none';
          };
          operator.onchange = () => {
            updateVisibility();
            applyFilters();
          };
          updateVisibility();
        }
      }
    } else {
      dropdown.style.display = 'none';
      const btn = dropdown.previousElementSibling;
      if (btn) btn.classList.remove('active');
    }
    
    // Klick au√üerhalb schlie√üt Dropdown
    setTimeout(() => {
      const closeHandler = (e) => {
        if (!dropdown.contains(e.target) && !dropdown.previousElementSibling?.contains(e.target)) {
          dropdown.style.display = 'none';
          const btn = dropdown.previousElementSibling;
          if (btn) btn.classList.remove('active');
          document.removeEventListener('click', closeHandler);
        }
      };
      document.addEventListener('click', closeHandler);
    }, 10);
  }
  
  // Bereich-Filter-Optionen f√ºllen
  function populateAreaFilterOptions() {
    const container = document.getElementById('filter-area-options');
    if (!container) return;
    
    const uniqueAreas = [...new Set(warehouseData.map(l => l.area).filter(a => a))].sort();
    container.innerHTML = uniqueAreas.map(area => `
      <label style="display: block; padding: 4px 8px; cursor: pointer;">
        <input type="checkbox" value="${area}" ${activeFilters.area.includes(area) ? 'checked' : ''} onchange="applyFilters()" style="margin-right: 6px;">${area}
      </label>
    `).join('');
  }
  
  // Filter anwenden
  function applyFilters() {
    try {
      // Location-Filter
      const locationInput = document.getElementById('filter-location-input');
      activeFilters.location = locationInput?.value.trim() || null;
      
      // Area-Filter
      const areaCheckboxes = document.querySelectorAll('#filter-area input[type="checkbox"]:checked:not([value="all"])');
      activeFilters.area = Array.from(areaCheckboxes).map(cb => cb.value);
      const allAreaChecked = document.querySelector('#filter-area input[value="all"]')?.checked;
      if (allAreaChecked) {
        activeFilters.area = [];
      }
      
      // Cartons-Filter
      const cartonsOperator = document.getElementById('filter-cartons-operator')?.value || 'all';
      const cartonsValue = document.getElementById('filter-cartons-value')?.value || null;
      activeFilters.cartons = { operator: cartonsOperator, value: cartonsValue };
      
      // Date-Filter
      const dateOperator = document.getElementById('filter-date-operator')?.value || 'all';
      const dateValue = document.getElementById('filter-date-value')?.value || null;
      activeFilters.date = { operator: dateOperator, value: dateValue };
      
      // Status-Filter
      const statusActive = document.querySelector('#filter-status input[value="active"]')?.checked ?? true;
      const statusInactive = document.querySelector('#filter-status input[value="inactive"]')?.checked ?? true;
      const statusAll = document.querySelector('#filter-status input[value="all"]')?.checked ?? true;
      activeFilters.status = {
        active: statusAll || statusActive,
        inactive: statusAll || statusInactive
      };
      
      // Filter-Icons aktualisieren
      updateFilterIcons();
      
      // Tabelle neu rendern
      renderWarehouseTable();
    } catch (err) {
      console.error("Fehler beim Anwenden der Filter:", err);
    }
  }
  
  // Filter l√∂schen
  function clearFilter(filterName) {
    try {
      if (filterName === 'location') {
        const input = document.getElementById('filter-location-input');
        if (input) input.value = '';
        activeFilters.location = null;
      } else if (filterName === 'area') {
        document.querySelectorAll('#filter-area input[type="checkbox"]').forEach(cb => {
          cb.checked = cb.value === 'all';
        });
        activeFilters.area = [];
      } else if (filterName === 'cartons') {
        const operator = document.getElementById('filter-cartons-operator');
        const value = document.getElementById('filter-cartons-value');
        if (operator) operator.value = 'all';
        if (value) {
          value.value = '';
          value.style.display = 'none';
        }
        activeFilters.cartons = { operator: 'all', value: null };
      } else if (filterName === 'date') {
        const operator = document.getElementById('filter-date-operator');
        const value = document.getElementById('filter-date-value');
        if (operator) operator.value = 'all';
        if (value) {
          value.value = '';
          value.style.display = 'none';
        }
        activeFilters.date = { operator: 'all', value: null };
      } else if (filterName === 'status') {
        document.querySelectorAll('#filter-status input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
        });
        activeFilters.status = { active: true, inactive: true };
      }
      
      updateFilterIcons();
    } catch (err) {
      console.error("Fehler beim L√∂schen des Filters:", err);
    }
  }
  
  // Filter-Icons aktualisieren (anzeigen wenn Filter aktiv)
  function updateFilterIcons() {
    try {
      const hasLocationFilter = activeFilters.location && activeFilters.location.length > 0;
      const hasAreaFilter = activeFilters.area.length > 0;
      const hasCartonsFilter = activeFilters.cartons.operator !== 'all';
      const hasDateFilter = activeFilters.date.operator !== 'all';
      const hasStatusFilter = !(activeFilters.status.active && activeFilters.status.inactive);
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (hasLocationFilter) {
        const btn = document.querySelector('#filter-location')?.previousElementSibling;
        if (btn) btn.classList.add('active');
      }
      if (hasAreaFilter) {
        const btn = document.querySelector('#filter-area')?.previousElementSibling;
        if (btn) btn.classList.add('active');
      }
      if (hasCartonsFilter) {
        const btn = document.querySelector('#filter-cartons')?.previousElementSibling;
        if (btn) btn.classList.add('active');
      }
      if (hasDateFilter) {
        const btn = document.querySelector('#filter-date')?.previousElementSibling;
        if (btn) btn.classList.add('active');
      }
      if (hasStatusFilter) {
        const btn = document.querySelector('#filter-status')?.previousElementSibling;
        if (btn) btn.classList.add('active');
      }
    } catch (err) {
      console.error("Fehler beim Aktualisieren der Filter-Icons:", err);
    }
  }
  
  async function loadWarehouse() {
    console.log("üè≠ Lade Lagerbestand...");
    
    try {
      // Areas laden
      const areasResponse = await fetch("/api/warehouse/areas");
      if (areasResponse.ok) {
        warehouseAreas = await areasResponse.json();
        updateAreaFilter();
      }
      
      // Stellpl√§tze laden
      await filterWarehouse();
      
    } catch (err) {
      console.error("Fehler beim Laden des Lagerbestands:", err);
      showWarehouseError("Fehler beim Laden der Daten");
    }
  }
  
  function updateAreaFilter() {
    const areaFilter = document.getElementById("warehouseAreaFilter");
    if (!areaFilter) return;
    
    // Bestehende Optionen behalten, nur neue hinzuf√ºgen
    const currentValue = areaFilter.value;
    areaFilter.innerHTML = '<option value="all">Gesamtes Lager</option>';
    
    warehouseAreas.forEach(area => {
      const option = document.createElement("option");
      option.value = area;
      option.textContent = area;
      areaFilter.appendChild(option);
    });
    
    // Vorherige Auswahl wiederherstellen
    if (currentValue) {
      areaFilter.value = currentValue;
    }
  }
  
  async function filterWarehouse() {
    const area = document.getElementById("warehouseAreaFilter")?.value || "all";
    const activeOnly = document.getElementById("warehouseActiveFilter")?.value || "true";
    const search = document.getElementById("warehouseSearch")?.value || "";
    
    const tbody = document.getElementById("warehouseBody");
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="7" class="muted">Lagerdaten werden geladen...</td></tr>';
    
    try {
      const params = new URLSearchParams({ area, active_only: activeOnly, search });
      const response = await fetch(`/api/warehouse/locations?${params}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      warehouseData = await response.json();
      renderWarehouseTable();
      
    } catch (err) {
      console.error("Fehler beim Filtern:", err);
      showWarehouseError("Fehler beim Laden der Daten");
    }
  }
  
  function renderWarehouseTable() {
    const tbody = document.getElementById("warehouseBody");
    if (!tbody) return;
    
      tbody.innerHTML = "";

    if (!warehouseData || warehouseData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="muted">Keine Stellpl√§tze gefunden</td></tr>';
      updateWarehouseStats([]);
        return;
      }

    // Daten filtern (Excel-Filter + alte Filter)
    let filteredData = warehouseData.filter(location => {
      // Excel Text-Filter: Location
      if (excelTextFilters.location) {
        const filter = excelTextFilters.location;
        const value = (location.code || '').toLowerCase();
        const searchValue = (filter.value || '').toLowerCase();
        
        if (filter.operator === 'equals' && value !== searchValue) return false;
        if (filter.operator === 'not-equals' && value === searchValue) return false;
        if (filter.operator === 'begins' && !value.startsWith(searchValue)) return false;
        if (filter.operator === 'ends' && !value.endsWith(searchValue)) return false;
        if (filter.operator === 'contains' && !value.includes(searchValue)) return false;
        if (filter.operator === 'not-contains' && value.includes(searchValue)) return false;
      }
      
      // Excel Werte-Filter: Location
      if (excelValueFilters.location && excelValueFilters.location.length > 0) {
        if (!excelValueFilters.location.includes(location.code)) return false;
      }
      
      // Excel Text-Filter: Area
      if (excelTextFilters.area) {
        const filter = excelTextFilters.area;
        const value = (location.area || '').toLowerCase();
        const searchValue = (filter.value || '').toLowerCase();
        
        if (filter.operator === 'equals' && value !== searchValue) return false;
        if (filter.operator === 'not-equals' && value === searchValue) return false;
        if (filter.operator === 'begins' && !value.startsWith(searchValue)) return false;
        if (filter.operator === 'ends' && !value.endsWith(searchValue)) return false;
        if (filter.operator === 'contains' && !value.includes(searchValue)) return false;
        if (filter.operator === 'not-contains' && value.includes(searchValue)) return false;
      }
      
      // Excel Werte-Filter: Area
      if (excelValueFilters.area && excelValueFilters.area.length > 0) {
        if (!excelValueFilters.area.includes(location.area)) return false;
      }
      
      // Excel Zahlen-Filter: Cartons
      if (excelNumberFilters.cartons) {
        const filter = excelNumberFilters.cartons;
        const cartons = location.total_cartons || 0;
        
        if (filter.operator === 'equals' && cartons !== filter.value) return false;
        if (filter.operator === 'not-equals' && cartons === filter.value) return false;
        if (filter.operator === 'greater' && cartons <= filter.value) return false;
        if (filter.operator === 'less' && cartons >= filter.value) return false;
        if (filter.operator === 'greater-equal' && cartons < filter.value) return false;
        if (filter.operator === 'less-equal' && cartons > filter.value) return false;
      }
      
      // Excel Datum-Filter
      if (excelTextFilters.date) {
        const filter = excelTextFilters.date;
        const bookedDate = location.last_booked_at ? new Date(location.last_booked_at) : null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (filter.operator === 'empty' && bookedDate) return false;
        if (filter.operator === 'not-empty' && !bookedDate) return false;
        if (filter.operator === 'today' && bookedDate) {
          const todayEnd = new Date(today);
          todayEnd.setHours(23, 59, 59, 999);
          if (bookedDate < today || bookedDate > todayEnd) return false;
        }
        if (filter.operator === 'this-week' && bookedDate) {
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          if (bookedDate < weekStart) return false;
        }
        if (filter.operator === 'this-month' && bookedDate) {
          if (bookedDate.getMonth() !== today.getMonth() || bookedDate.getFullYear() !== today.getFullYear()) return false;
        }
      }
      
      // Excel Werte-Filter: Status
      if (excelValueFilters.status && excelValueFilters.status.length > 0) {
        const status = location.is_active ? 'Aktiv' : 'Inaktiv';
        if (!excelValueFilters.status.includes(status)) return false;
      }
      
      // Alte Filter (f√ºr Kompatibilit√§t)
      if (activeFilters.location) {
        const searchTerm = activeFilters.location.toLowerCase();
        const code = (location.code || '').toLowerCase();
        const description = (location.description || '').toLowerCase();
        if (!code.includes(searchTerm) && !description.includes(searchTerm)) {
          return false;
        }
      }
      
      if (activeFilters.area.length > 0) {
        if (!activeFilters.area.includes(location.area)) {
          return false;
        }
      }
      
      const cartons = location.total_cartons || 0;
      const cartonsFilter = activeFilters.cartons;
      if (cartonsFilter.operator === 'empty' && cartons !== 0) return false;
      if (cartonsFilter.operator === 'not-empty' && cartons === 0) return false;
      if (cartonsFilter.operator === 'gt' && cartonsFilter.value && cartons <= parseInt(cartonsFilter.value)) return false;
      if (cartonsFilter.operator === 'lt' && cartonsFilter.value && cartons >= parseInt(cartonsFilter.value)) return false;
      if (cartonsFilter.operator === 'eq' && cartonsFilter.value && cartons !== parseInt(cartonsFilter.value)) return false;
      
      const dateFilter = activeFilters.date;
      if (dateFilter.operator !== 'all' && location.last_booked_at) {
        const bookedDate = new Date(location.last_booked_at);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (dateFilter.operator === 'empty') return false;
        if (dateFilter.operator === 'not-empty') return true;
        if (dateFilter.operator === 'today') {
          const todayEnd = new Date(today);
          todayEnd.setHours(23, 59, 59, 999);
          if (bookedDate < today || bookedDate > todayEnd) return false;
        }
        if (dateFilter.operator === 'this-week') {
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          if (bookedDate < weekStart) return false;
        }
        if (dateFilter.operator === 'this-month') {
          if (bookedDate.getMonth() !== today.getMonth() || bookedDate.getFullYear() !== today.getFullYear()) return false;
        }
        if (dateFilter.operator === 'before' && dateFilter.value) {
          const filterDate = new Date(dateFilter.value);
          if (bookedDate >= filterDate) return false;
        }
        if (dateFilter.operator === 'after' && dateFilter.value) {
          const filterDate = new Date(dateFilter.value);
          if (bookedDate <= filterDate) return false;
        }
      } else if (dateFilter.operator === 'empty' && location.last_booked_at) {
        return false;
      } else if (dateFilter.operator === 'not-empty' && !location.last_booked_at) {
        return false;
      }
      
      if (!activeFilters.status.active && location.is_active) return false;
      if (!activeFilters.status.inactive && !location.is_active) return false;
      
      return true;
    });
    
    // Sortierung anwenden
    if (excelSortState.column && excelSortState.direction) {
      filteredData.sort((a, b) => {
        let aVal, bVal;
        
        if (excelSortState.column === 'location') {
          aVal = (a.code || '').toLowerCase();
          bVal = (b.code || '').toLowerCase();
        } else if (excelSortState.column === 'area') {
          aVal = (a.area || '').toLowerCase();
          bVal = (b.area || '').toLowerCase();
        } else if (excelSortState.column === 'cartons') {
          aVal = a.total_cartons || 0;
          bVal = b.total_cartons || 0;
        } else if (excelSortState.column === 'date') {
          aVal = a.last_booked_at ? new Date(a.last_booked_at).getTime() : 0;
          bVal = b.last_booked_at ? new Date(b.last_booked_at).getTime() : 0;
        } else if (excelSortState.column === 'status') {
          aVal = a.is_active ? 'Aktiv' : 'Inaktiv';
          bVal = b.is_active ? 'Aktiv' : 'Inaktiv';
        } else {
          return 0;
        }
        
        if (typeof aVal === 'string' && typeof bVal === 'string') {
          return excelSortState.direction === 'asc' 
            ? aVal.localeCompare(bVal, 'de')
            : bVal.localeCompare(aVal, 'de');
        } else {
          return excelSortState.direction === 'asc' 
            ? aVal - bVal
            : bVal - aVal;
        }
      });
    }

    if (filteredData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="muted">Keine Eintr√§ge gefunden (Filter aktiv)</td></tr>';
      updateWarehouseStats([]);
      return;
    }

    filteredData.forEach(location => {
      const tr = document.createElement("tr");
      tr.className = "warehouse-location-row";
      tr.dataset.locationId = location.id;
      tr.style.cursor = "pointer";
      tr.style.transition = "background 0.2s ease";
      
      const isExpanded = expandedLocations.has(location.id);
      const hasCartons = location.carton_count > 0;
      
        tr.innerHTML = `
        <td style="text-align: center;">
          ${hasCartons ? (isExpanded ? '‚ñº' : '‚ñ∂') : ''}
        </td>
        <td>
          <div style="font-weight: 600;">${location.code}</div>
          <div style="font-size: 11px; color: var(--text-muted);">${location.description || ''}</div>
          </td>
        <td>
          <span class="pill">${location.area || 'Unbekannt'}</span>
        </td>
        <td>
          <strong style="color: ${location.total_cartons > 0 ? 'var(--gxo-orange)' : 'var(--text-muted)'};">
            ${location.total_cartons || 0}
          </strong>
          ${location.carton_count > 0 ? `<span style="font-size: 11px; color: var(--text-muted);"> (${location.carton_count} Eintr√§ge)</span>` : ''}
        </td>
        <td>
          ${location.last_booked_at ? formatDateTime(location.last_booked_at) : '-'}
        </td>
        <td>
          ${location.is_active ? '<span class="pill pill-success">Aktiv</span>' : '<span class="pill">Inaktiv</span>'}
        </td>
          <td class="table-actions">
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); viewLocationDetails(${location.id})">
            üëÅÔ∏è
          </button>
          </td>
        `;
      
      // Click-Handler f√ºr Expand/Collapse
      if (hasCartons) {
        tr.addEventListener("click", () => toggleLocationDetails(location.id, tr));
      }
      
        tbody.appendChild(tr);
      
      // Wenn expanded, Details-Zeile hinzuf√ºgen
      if (isExpanded) {
        const detailsTr = document.createElement("tr");
        detailsTr.className = "warehouse-details-row";
        detailsTr.id = `details-${location.id}`;
        detailsTr.innerHTML = `
          <td colspan="7" style="padding: 0; background: var(--bg-soft);">
            <div style="padding: 16px;">
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Lade Details...</div>
            </div>
          </td>
        `;
        tbody.appendChild(detailsTr);
        
        // Details laden
        loadLocationDetails(location.id);
      }
    });
    
    // Statistiken aktualisieren basierend auf gefilterten Daten
    updateWarehouseStats(filteredData);
  }
  
  function updateWarehouseStats(data = null) {
    const statsData = data || warehouseData;
    const totalLocations = statsData.length;
    const occupiedLocations = statsData.filter(l => (l.total_cartons || 0) > 0).length;
    const totalCartons = statsData.reduce((sum, l) => sum + (l.total_cartons || 0), 0);
    const utilization = totalLocations > 0 ? Math.round((occupiedLocations / totalLocations) * 100) : 0;
    
    document.getElementById("statTotalLocations").textContent = totalLocations;
    document.getElementById("statOccupiedLocations").textContent = occupiedLocations;
    document.getElementById("statTotalCartons").textContent = totalCartons;
    document.getElementById("statUtilization").textContent = utilization + "%";
  }
  
  async function toggleLocationDetails(locationId, row) {
    if (expandedLocations.has(locationId)) {
      // Collapse
      expandedLocations.delete(locationId);
      const detailsRow = document.getElementById(`details-${locationId}`);
      if (detailsRow) {
        detailsRow.remove();
      }
      // Icon aktualisieren
      row.querySelector("td").textContent = "‚ñ∂";
    } else {
      // Expand
      expandedLocations.add(locationId);
      
      // Icon aktualisieren
      row.querySelector("td").textContent = "‚ñº";
      
      // Details-Zeile hinzuf√ºgen
      const detailsTr = document.createElement("tr");
      detailsTr.className = "warehouse-details-row";
      detailsTr.id = `details-${locationId}`;
      detailsTr.innerHTML = `
        <td colspan="7" style="padding: 0; background: var(--bg-soft);">
          <div style="padding: 16px;">
            <div style="font-size: 12px; color: var(--text-muted);">Lade Details...</div>
          </div>
        </td>
      `;
      
      // Nach der aktuellen Zeile einf√ºgen
      row.parentNode.insertBefore(detailsTr, row.nextSibling);
      
      // Details laden
      await loadLocationDetails(locationId);
    }
  }
  
  async function loadLocationDetails(locationId) {
    try {
      const response = await fetch(`/api/warehouse/locations/${locationId}/details`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      const detailsRow = document.getElementById(`details-${locationId}`);
      
      if (!detailsRow) return;
      
      const detailsHtml = `
        <div style="padding: 16px; background: var(--bg-soft);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0; font-size: 14px; color: var(--text-main);">
              üì¶ ${data.cartons.length} Eintr√§ge auf ${data.location.code}
            </h4>
            <span style="font-size: 13px; color: var(--text-muted);">
              Gesamt: <strong style="color: var(--gxo-orange);">${data.total_cartons}</strong> Kartons
            </span>
          </div>
          
          <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
            <table style="width: 100%; font-size: 11px; background: var(--bg-card); border-radius: 8px; overflow: hidden; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; z-index: 10; background: var(--bg-main);">
                <tr>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">ID</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">CW</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Datum</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Carrier</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Tracking Nr.</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">OLPN</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">DN</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">SHI</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Planned</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Actual</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Customer ID</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Customer Name</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">ASN/RA</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Area</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Land</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Ship Status</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Ignore</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Kommentar</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Gebucht am</th>
                  <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Von</th>
                  <th style="padding: 8px; text-align: center; border-bottom: 2px solid var(--border-soft); white-space: nowrap;">Aktion</th>
                </tr>
              </thead>
              <tbody>
                ${data.cartons.map(carton => `
                  <tr style="border-bottom: 1px solid var(--border-soft); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-soft)'" onmouseout="this.style.background=''">
                    <td style="padding: 6px 8px; font-size: 10px; color: var(--text-muted);">#${carton.id || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.cw || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.aufgenommen_am ? new Date(carton.aufgenommen_am).toLocaleDateString('de-DE') : '-'}</td>
                    <td style="padding: 6px 8px;">${carton.carrier_name || '-'}</td>
                    <td style="padding: 6px 8px; font-family: monospace; font-size: 10px;">${carton.carrier_tracking_nr || '-'}</td>
                    <td style="padding: 6px 8px; font-family: monospace; font-size: 10px;">${carton.olpn || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.dn || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.shi || '-'}</td>
                    <td style="padding: 6px 8px; text-align: center;">${carton.planned_carton || '-'}</td>
                    <td style="padding: 6px 8px; text-align: center;"><strong style="color: var(--gxo-orange);">${carton.actual_carton || 0}</strong></td>
                    <td style="padding: 6px 8px; font-family: monospace; font-size: 10px;">${carton.customer_id || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.customer_name || '-'}</td>
                    <td style="padding: 6px 8px; font-family: monospace; font-size: 10px;">${carton.asn_ra_no || '-'}</td>
                    <td style="padding: 6px 8px;"><span class="pill" style="font-size: 10px;">${carton.area || '-'}</span></td>
                    <td style="padding: 6px 8px;">${carton.land || '-'}</td>
                    <td style="padding: 6px 8px;">${carton.ship_status || '-'}</td>
                    <td style="padding: 6px 8px; text-align: center;">${carton.ignore_flag ? '‚úÖ' : '‚ùå'}</td>
                    <td style="padding: 6px 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${carton.kommentar || ''}">${carton.kommentar || '-'}</td>
                    <td style="padding: 6px 8px; font-size: 10px; color: var(--text-muted);">${formatDateTime(carton.created_at)}</td>
                    <td style="padding: 6px 8px; font-size: 10px; color: var(--text-muted);">${carton.added_by || '-'}</td>
                    <td style="padding: 6px 8px; text-align: center;">
                      <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); editInboundEntry(${carton.id}, ${data.location.id})" style="padding: 4px 8px; font-size: 11px;" title="Bearbeiten">
                        ‚úèÔ∏è
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      detailsRow.innerHTML = `<td colspan="7" style="padding: 0;">${detailsHtml}</td>`;
      
    } catch (err) {
      console.error("Fehler beim Laden der Details:", err);
      const detailsRow = document.getElementById(`details-${locationId}`);
      if (detailsRow) {
        detailsRow.innerHTML = `
          <td colspan="7" style="padding: 16px; background: var(--bg-soft);">
            <div style="color: var(--text-muted);">Fehler beim Laden der Details</div>
          </td>
        `;
      }
    }
  }
  
  function showWarehouseError(message) {
    const tbody = document.getElementById("warehouseBody");
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">${message}</td></tr>`;
    }
  }
  
  function refreshWarehouse() {
    expandedLocations.clear();
    loadWarehouse();
    showCustomModal("‚úì Lagerbestand aktualisiert", "success");
  }
  
  // ========== EXCEL-FILTER FUNKTIONEN ==========
  
  // Excel-Filter-Men√º √∂ffnen/schlie√üen
  function toggleExcelFilter(column) {
    const menu = document.getElementById(`excel-filter-${column}`);
    if (!menu) return;
    
    const header = menu.closest('th');
    if (!header) return;
    
    // Alle anderen Men√ºs schlie√üen
    document.querySelectorAll('.excel-filter-menu').forEach(m => {
      if (m !== menu) m.style.display = 'none';
    });
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-valuefilter-submenu').forEach(m => m.style.display = 'none');
    
    // Aktuelles Men√º umschalten
    if (menu.style.display === 'none' || !menu.style.display) {
      menu.style.display = 'block';
      
      // Position berechnen (relativ zum Header)
      const rect = header.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.top = (rect.bottom + 4) + 'px';
      menu.style.left = rect.left + 'px';
      menu.style.zIndex = '10000';
      
      // Sicherstellen, dass Men√º nicht au√üerhalb des Viewports ist
      setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
          menu.style.left = (window.innerWidth - menuRect.width - 10) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
          menu.style.top = (rect.top - menuRect.height - 4) + 'px';
        }
      }, 0);
      
      // Werte-Filter-Listen f√ºllen
      if (['location', 'area', 'status'].includes(column)) {
        populateValueFilterList(column);
      }
    } else {
      menu.style.display = 'none';
    }
    
    // Klick au√üerhalb schlie√üt Men√º
    setTimeout(() => {
      const closeHandler = (e) => {
        if (!menu.contains(e.target) && !e.target.closest(`.excel-filter-header`)) {
          menu.style.display = 'none';
          document.removeEventListener('click', closeHandler);
        }
      };
      document.addEventListener('click', closeHandler);
    }, 10);
  }
  
  // Spalte sortieren
  function sortColumn(column, direction) {
    excelSortState.column = column;
    excelSortState.direction = direction;
    
    // Sortier-Indikator aktualisieren
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.removeAttribute('data-sort');
    });
    const header = document.querySelector(`#excel-filter-${column}`)?.closest('th');
    if (header) {
      header.setAttribute('data-sort', direction);
    }
    
    // Men√º schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Textfilter anzeigen
  function showTextFilter(column) {
    const submenu = document.getElementById(`excel-textfilter-${column}`);
    if (!submenu) return;
    
    const menu = submenu.closest('.excel-filter-menu');
    if (!menu) return;
    
    // Alle anderen Submen√ºs schlie√üen
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => {
      if (m !== submenu) m.style.display = 'none';
    });
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-valuefilter-submenu').forEach(m => m.style.display = 'none');
    
    if (submenu.style.display === 'none' || !submenu.style.display) {
      submenu.style.display = 'block';
      
      // Position berechnen (rechts neben dem Hauptmen√º)
      const menuRect = menu.getBoundingClientRect();
      submenu.style.position = 'fixed';
      submenu.style.top = menuRect.top + 'px';
      submenu.style.left = (menuRect.right + 4) + 'px';
      submenu.style.zIndex = '10001';
      
      // Sicherstellen, dass Submen√º nicht au√üerhalb des Viewports ist
      setTimeout(() => {
        const submenuRect = submenu.getBoundingClientRect();
        if (submenuRect.right > window.innerWidth) {
          submenu.style.left = (menuRect.left - submenuRect.width - 4) + 'px';
        }
      }, 0);
    } else {
      submenu.style.display = 'none';
    }
  }
  
  // Textfilter setzen (Legacy - ruft die erweiterte Version auf)
  function setTextFilter(column, operator) {
    setTextFilter(column, operator, 'warehouse');
  }
  
  // Textfilter anwenden
  function applyTextFilter(column, operator) {
    const input = document.getElementById('excel-filter-input-value');
    if (!input) return;
    
    const value = input.value.trim();
    
    if (value) {
      excelTextFilters[column] = { operator, value };
    } else {
      delete excelTextFilters[column];
    }
    
    // Modal schlie√üen
    closeFilterInputModal();
    
    // Filter-Indikator aktualisieren
    updateExcelFilterIndicators();
    
    // Men√º schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Filter-Input-Modal schlie√üen
  function closeFilterInputModal() {
    const modal = document.querySelector('.excel-filter-input-modal');
    if (modal) modal.remove();
  }
  
  // Zahlenfilter anzeigen
  function showNumberFilter(column) {
    const submenu = document.getElementById(`excel-numberfilter-${column}`);
    if (!submenu) return;
    
    const menu = submenu.closest('.excel-filter-menu');
    if (!menu) return;
    
    // Alle anderen Submen√ºs schlie√üen
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => {
      if (m !== submenu) m.style.display = 'none';
    });
    document.querySelectorAll('.excel-valuefilter-submenu').forEach(m => m.style.display = 'none');
    
    if (submenu.style.display === 'none' || !submenu.style.display) {
      submenu.style.display = 'block';
      
      // Position berechnen (rechts neben dem Hauptmen√º)
      const menuRect = menu.getBoundingClientRect();
      submenu.style.position = 'fixed';
      submenu.style.top = menuRect.top + 'px';
      submenu.style.left = (menuRect.right + 4) + 'px';
      submenu.style.zIndex = '10001';
      
      // Sicherstellen, dass Submen√º nicht au√üerhalb des Viewports ist
      setTimeout(() => {
        const submenuRect = submenu.getBoundingClientRect();
        if (submenuRect.right > window.innerWidth) {
          submenu.style.left = (menuRect.left - submenuRect.width - 4) + 'px';
        }
      }, 0);
    } else {
      submenu.style.display = 'none';
    }
  }
  
  // Zahlenfilter setzen
  function setNumberFilter(column, operator) {
    // Submen√º schlie√üen
    document.getElementById(`excel-numberfilter-${column}`).style.display = 'none';
    
    // Eingabefeld-Modal anzeigen
    const operatorLabels = {
      'equals': 'Ist gleich',
      'not-equals': 'Ist nicht gleich',
      'greater': 'Gr√∂√üer als',
      'less': 'Kleiner als',
      'greater-equal': 'Gr√∂√üer oder gleich',
      'less-equal': 'Kleiner oder gleich'
    };
    
    const label = operatorLabels[operator] || operator;
    const currentValue = excelNumberFilters[column]?.operator === operator ? excelNumberFilters[column].value : '';
    
    const modalHtml = `
      <div class="excel-filter-input-modal">
        <div class="excel-filter-input-content">
          <div class="excel-filter-input-header">
            <span>${label}</span>
            <button onclick="closeFilterInputModal()" class="excel-filter-close-btn">√ó</button>
          </div>
          <div class="excel-filter-input-body">
            <input type="number" id="excel-filter-input-value" placeholder="Zahl eingeben..." value="${currentValue}" autofocus step="any">
            <div class="excel-filter-input-actions">
              <button onclick="applyNumberFilter('${column}', '${operator}')" class="excel-filter-apply-btn">√úbernehmen</button>
              <button onclick="closeFilterInputModal()" class="excel-filter-cancel-btn">Abbrechen</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Altes Modal entfernen falls vorhanden
    const oldModal = document.querySelector('.excel-filter-input-modal');
    if (oldModal) oldModal.remove();
    
    // Neues Modal hinzuf√ºgen
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Enter-Taste unterst√ºtzen
    document.getElementById('excel-filter-input-value').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        applyNumberFilter(column, operator);
      } else if (e.key === 'Escape') {
        closeFilterInputModal();
      }
    });
  }
  
  // Zahlenfilter anwenden
  function applyNumberFilter(column, operator) {
    const input = document.getElementById('excel-filter-input-value');
    if (!input) return;
    
    const value = input.value.trim();
    
    if (value === '') {
      delete excelNumberFilters[column];
    } else {
      const numValue = parseFloat(value);
      if (isNaN(numValue)) {
        alert('Bitte geben Sie eine g√ºltige Zahl ein.');
        return;
      }
      excelNumberFilters[column] = { operator, value: numValue };
    }
    
    // Modal schlie√üen
    closeFilterInputModal();
    
    // Filter-Indikator aktualisieren
    updateExcelFilterIndicators();
    
    // Men√º schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Werte-Filter anzeigen
  function showValueFilter(column) {
    const submenu = document.getElementById(`excel-valuefilter-${column}`);
    if (!submenu) return;
    
    const menu = submenu.closest('.excel-filter-menu');
    if (!menu) return;
    
    // Alle anderen Submen√ºs schlie√üen
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-valuefilter-submenu').forEach(m => {
      if (m !== submenu) m.style.display = 'none';
    });
    
    if (submenu.style.display === 'none' || !submenu.style.display) {
      submenu.style.display = 'flex';
      populateValueFilterList(column);
    } else {
      submenu.style.display = 'none';
    }
  }
  
  // Werte-Filter-Liste f√ºllen
  function populateValueFilterList(column) {
    const container = document.getElementById(`excel-checkbox-list-${column}`);
    if (!container || !warehouseData || warehouseData.length === 0) return;
    
    let uniqueValues = [];
    
    if (column === 'location') {
      uniqueValues = [...new Set(warehouseData.map(l => l.code).filter(v => v))].sort();
    } else if (column === 'area') {
      uniqueValues = [...new Set(warehouseData.map(l => l.area).filter(v => v))].sort();
    } else if (column === 'status') {
      uniqueValues = ['Aktiv', 'Inaktiv'];
    }
    
    const selectedValues = excelValueFilters[column] || [];
    
    container.innerHTML = `
      <label style="display: flex; align-items: center; padding: 4px 8px; cursor: pointer;">
        <input type="checkbox" id="excel-select-all-${column}" ${selectedValues.length === 0 || selectedValues.length === uniqueValues.length ? 'checked' : ''} onchange="toggleSelectAll('${column}')" style="margin-right: 8px;">
        <span>Alles ausw√§hlen</span>
      </label>
      ${uniqueValues.map(value => `
        <label style="display: flex; align-items: center; padding: 4px 8px; cursor: pointer;">
          <input type="checkbox" value="${value}" ${selectedValues.length === 0 || selectedValues.includes(value) ? 'checked' : ''} style="margin-right: 8px;">
          <span>${value || '(Leere)'}</span>
        </label>
      `).join('')}
    `;
  }
  
  // Alle ausw√§hlen/abw√§hlen
  function toggleSelectAll(column) {
    const selectAll = document.getElementById(`excel-select-all-${column}`);
    const checkboxes = document.querySelectorAll(`#excel-checkbox-list-${column} input[type="checkbox"]:not(#excel-select-all-${column})`);
    
    checkboxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
  }
  
  // Werte-Filter-Liste filtern (Suche)
  function filterValueList(column) {
    const searchTerm = document.getElementById(`excel-search-${column}`)?.value.toLowerCase() || '';
    const labels = document.querySelectorAll(`#excel-checkbox-list-${column} label`);
    
    labels.forEach(label => {
      const text = label.textContent.toLowerCase();
      if (text.includes('Alles ausw√§hlen')) return;
      label.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
  }
  
  // Werte-Filter anwenden
  function applyValueFilter(column) {
    const checkboxes = document.querySelectorAll(`#excel-checkbox-list-${column} input[type="checkbox"]:not(#excel-select-all-${column}):checked`);
    const selectedValues = Array.from(checkboxes).map(cb => cb.value);
    
    excelValueFilters[column] = selectedValues;
    
    // Filter-Indikator aktualisieren
    updateExcelFilterIndicators();
    
    // Men√ºs schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    document.getElementById(`excel-valuefilter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Datum-Filter setzen
  function setDateFilter(column, operator) {
    excelTextFilters[column] = { operator, value: null };
    
    // Filter-Indikator aktualisieren
    updateExcelFilterIndicators();
    
    // Men√º schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Spalten-Filter l√∂schen
  function clearColumnFilter(column) {
    if (excelTextFilters[column]) {
      delete excelTextFilters[column];
    }
    if (excelNumberFilters[column]) {
      delete excelNumberFilters[column];
    }
    if (excelValueFilters[column]) {
      excelValueFilters[column] = [];
    }
    
    // Filter-Indikator aktualisieren
    updateExcelFilterIndicators();
    
    // Men√º schlie√üen
    document.getElementById(`excel-filter-${column}`).style.display = 'none';
    
    // Tabelle neu rendern
    renderWarehouseTable();
  }
  
  // Alle Filter l√∂schen
  function clearAllFilters() {
    // Excel-Filter zur√ºcksetzen
    excelSortState = { column: null, direction: null };
    excelTextFilters = { location: null, area: null, date: null };
    excelNumberFilters = { cartons: null };
    excelValueFilters = { location: [], area: [], status: [] };
    
    // Alte Filter zur√ºcksetzen
    activeFilters = {
      location: null,
      area: [],
      cartons: { operator: 'all', value: null },
      date: { operator: 'all', value: null },
      status: { active: true, inactive: true }
    };
    
    // Sortier-Indikatoren entfernen
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.removeAttribute('data-sort');
    });
    
    // Filter-Indikatoren aktualisieren
    updateExcelFilterIndicators();
    
    // Alle Men√ºs schlie√üen
    document.querySelectorAll('.excel-filter-menu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-valuefilter-submenu').forEach(m => m.style.display = 'none');
    
    // Tabelle neu rendern
    renderWarehouseTable();
    
    showCustomModal("‚úì Alle Filter wurden gel√∂scht", "success");
  }
  
  // ========== OVERALL INVENTORY ANSICHT ==========
  
  let overallInventoryData = [];
  let overallSortState = { column: null, direction: null };
  let overallFilters = {};
  
  // Overall Inventory laden
  async function loadOverallInventory() {
    const tbody = document.getElementById("overallInventoryBody");
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="22" class="muted">Lade Eintr√§ge...</td></tr>';
    
    try {
      const response = await fetch("/api/warehouse/all-entries?limit=10000");
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      overallInventoryData = await response.json();
      renderOverallInventory();
      updateOverallStats();
    } catch (err) {
      console.error("Fehler beim Laden der Overall-Ansicht:", err);
      tbody.innerHTML = '<tr><td colspan="22" class="muted">Fehler beim Laden der Daten</td></tr>';
    }
  }
  
  // Overall Inventory rendern
  function renderOverallInventory() {
    const tbody = document.getElementById("overallInventoryBody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    if (!overallInventoryData || overallInventoryData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="22" class="muted">Keine Eintr√§ge gefunden</td></tr>';
      return;
    }
    
    // Filter anwenden
    let filteredData = overallInventoryData.filter(entry => {
      for (const [column, filter] of Object.entries(overallFilters)) {
        if (!filter) continue;
        
        const value = entry[column];
        const filterValue = filter.value;
        
        if (filter.type === 'text') {
          const val = (value || '').toLowerCase();
          const searchVal = (filterValue || '').toLowerCase();
          
          if (filter.operator === 'equals' && val !== searchVal) return false;
          if (filter.operator === 'not-equals' && val === searchVal) return false;
          if (filter.operator === 'begins' && !val.startsWith(searchVal)) return false;
          if (filter.operator === 'ends' && !val.endsWith(searchVal)) return false;
          if (filter.operator === 'contains' && !val.includes(searchVal)) return false;
          if (filter.operator === 'not-contains' && val.includes(searchVal)) return false;
        } else if (filter.type === 'number') {
          const numVal = parseFloat(value) || 0;
          const numFilter = parseFloat(filterValue) || 0;
          
          if (filter.operator === 'equals' && numVal !== numFilter) return false;
          if (filter.operator === 'not-equals' && numVal === numFilter) return false;
          if (filter.operator === 'greater' && numVal <= numFilter) return false;
          if (filter.operator === 'less' && numVal >= numFilter) return false;
          if (filter.operator === 'greater-equal' && numVal < numFilter) return false;
          if (filter.operator === 'less-equal' && numVal > numFilter) return false;
        } else if (filter.type === 'value') {
          if (!filter.values.includes(value)) return false;
        }
      }
      return true;
    });
    
    // Sortierung anwenden
    if (overallSortState.column && overallSortState.direction) {
      filteredData.sort((a, b) => {
        let aVal = a[overallSortState.column];
        let bVal = b[overallSortState.column];
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = (bVal || '').toLowerCase();
          return overallSortState.direction === 'asc' 
            ? aVal.localeCompare(bVal, 'de')
            : bVal.localeCompare(aVal, 'de');
        } else {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
          return overallSortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });
    }
    
    // Tabelle rendern
    filteredData.forEach(entry => {
      const tr = document.createElement("tr");
      tr.className = "data-row";
      tr.style.borderBottom = "1px solid var(--border-soft)";
      
      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        try {
          return new Date(dateStr).toLocaleDateString('de-DE');
        } catch (e) {
          return dateStr;
        }
      };
      
      const formatDateTime = (dateStr) => {
        if (!dateStr) return '-';
        try {
          return new Date(dateStr).toLocaleString('de-DE');
        } catch (e) {
          return dateStr;
        }
      };
      
      tr.innerHTML = `
        <td style="padding: 6px 8px; font-size: 11px;">
          <div style="font-weight: 600;">${entry.location_code || '-'}</div>
          ${entry.location_description ? `<div style="font-size: 10px; color: var(--text-muted);">${entry.location_description}</div>` : ''}
        </td>
        <td style="padding: 6px 8px; font-size: 11px; color: var(--text-muted);">#${entry.id || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.cw || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${formatDate(entry.aufgenommen_am)}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.carrier_name || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px; font-family: monospace;">${entry.carrier_tracking_nr || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px; font-family: monospace;">${entry.olpn || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.dn || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.shi || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.planned_carton || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px; color: ${entry.actual_carton > 0 ? 'var(--gxo-orange)' : 'var(--text-muted)'}; font-weight: ${entry.actual_carton > 0 ? '600' : 'normal'};">
          ${entry.actual_carton || '-'}
        </td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.customer_id || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.customer_name || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.asn_ra_no || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">
          ${entry.area ? `<span class="pill">${entry.area}</span>` : '-'}
        </td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.land || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.ship_status || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px; text-align: center;">
          ${entry.ignore_flag ? '<span style="color: var(--gxo-orange);">‚úó</span>' : '-'}
        </td>
        <td style="padding: 6px 8px; font-size: 11px;">${entry.kommentar || '-'}</td>
        <td style="padding: 6px 8px; font-size: 11px; color: var(--text-muted);">${formatDateTime(entry.created_at)}</td>
        <td style="padding: 6px 8px; font-size: 11px; color: var(--text-muted);">${entry.added_by || '-'}</td>
        <td style="padding: 6px 8px; text-align: center;">
          <button class="btn btn-ghost btn-sm" onclick="showInboundEntryDetails(${entry.id})" title="Details anzeigen">
            ‚úèÔ∏è
          </button>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
  }
  
  // Overall Stats aktualisieren
  function updateOverallStats() {
    const total = overallInventoryData.length;
    const totalCartons = overallInventoryData.reduce((sum, e) => sum + (e.actual_carton || 0), 0);
    const uniqueLocations = new Set(overallInventoryData.filter(e => e.location_code).map(e => e.location_code)).size;
    
    document.getElementById("overallStatTotal").textContent = total;
    document.getElementById("overallStatCartons").textContent = totalCartons;
    document.getElementById("overallStatLocations").textContent = uniqueLocations;
  }
  
  // Overall Filter-Men√º √∂ffnen
  function toggleOverallFilter(column) {
    const menu = document.getElementById(`overall-filter-${column}`);
    if (!menu) return;
    
    const header = menu.closest('th');
    if (!header) return;
    
    // Alle anderen Men√ºs schlie√üen
    document.querySelectorAll('#overallInventoryTable .excel-filter-menu').forEach(m => {
      if (m !== menu) m.style.display = 'none';
    });
    
    if (menu.style.display === 'none' || !menu.style.display) {
      menu.style.display = 'block';
      
      // Position berechnen
      const rect = header.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.top = (rect.bottom + 4) + 'px';
      menu.style.left = rect.left + 'px';
      menu.style.zIndex = '10000';
      
      // Men√º-Inhalt generieren (vereinfacht - nur Sortierung und Textfilter)
      const columnLabels = {
        'location_code': 'Stellplatz',
        'id': 'ID',
        'cw': 'CW',
        'aufgenommen_am': 'Datum',
        'carrier_name': 'Carrier',
        'carrier_tracking_nr': 'Tracking Nr.',
        'olpn': 'OLPN',
        'dn': 'DN',
        'shi': 'SHI',
        'planned_carton': 'Planned',
        'actual_carton': 'Actual',
        'customer_id': 'Customer ID',
        'customer_name': 'Customer Name',
        'asn_ra_no': 'ASN/RA',
        'area': 'Area',
        'land': 'Land',
        'ship_status': 'Ship Status',
        'ignore_flag': 'Ignore',
        'kommentar': 'Kommentar',
        'created_at': 'Gebucht am',
        'added_by': 'Von'
      };
      
      const label = columnLabels[column] || column;
      
      menu.innerHTML = `
        <div class="excel-filter-menu-item" onclick="overallSortColumn('${column}', 'asc')">
          <span>Aufsteigend sortieren</span>
          <span style="font-size: 12px;">‚Üë</span>
        </div>
        <div class="excel-filter-menu-item" onclick="overallSortColumn('${column}', 'desc')">
          <span>Absteigend sortieren</span>
          <span style="font-size: 12px;">‚Üì</span>
        </div>
        <div class="excel-filter-divider"></div>
        <div class="excel-filter-menu-item" onclick="overallShowTextFilter('${column}')">
          <span>Textfilter</span>
          <span>‚ñ∂</span>
        </div>
        <div id="overall-textfilter-${column}" class="excel-textfilter-submenu" style="display: none;">
          <div onclick="overallSetTextFilter('${column}', 'equals')">Ist gleich...</div>
          <div onclick="overallSetTextFilter('${column}', 'not-equals')">Ist nicht gleich...</div>
          <div onclick="overallSetTextFilter('${column}', 'begins')">Beginnt mit...</div>
          <div onclick="overallSetTextFilter('${column}', 'ends')">Endet mit...</div>
          <div onclick="overallSetTextFilter('${column}', 'contains')">Enth√§lt...</div>
          <div onclick="overallSetTextFilter('${column}', 'not-contains')">Enth√§lt nicht...</div>
        </div>
        ${['planned_carton', 'actual_carton', 'id'].includes(column) ? `
        <div class="excel-filter-menu-item" onclick="overallShowNumberFilter('${column}')">
          <span>Zahlenfilter</span>
          <span>‚ñ∂</span>
        </div>
        <div id="overall-numberfilter-${column}" class="excel-numberfilter-submenu" style="display: none;">
          <div onclick="overallSetNumberFilter('${column}', 'equals')">Ist gleich...</div>
          <div onclick="overallSetNumberFilter('${column}', 'not-equals')">Ist nicht gleich...</div>
          <div onclick="overallSetNumberFilter('${column}', 'greater')">Gr√∂√üer als...</div>
          <div onclick="overallSetNumberFilter('${column}', 'less')">Kleiner als...</div>
          <div onclick="overallSetNumberFilter('${column}', 'greater-equal')">Gr√∂√üer oder gleich...</div>
          <div onclick="overallSetNumberFilter('${column}', 'less-equal')">Kleiner oder gleich...</div>
        </div>
        ` : ''}
        <div class="excel-filter-divider"></div>
        <div class="excel-filter-menu-item" onclick="overallClearColumnFilter('${column}')">
          <span>Filter aus '${label}' entfernen</span>
        </div>
      `;
      
      setTimeout(() => {
        const closeHandler = (e) => {
          if (!menu.contains(e.target) && !e.target.closest(`.excel-filter-header`)) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeHandler);
          }
        };
        document.addEventListener('click', closeHandler);
      }, 10);
    } else {
      menu.style.display = 'none';
    }
  }
  
  // Overall Spalte sortieren
  function overallSortColumn(column, direction) {
    overallSortState.column = column;
    overallSortState.direction = direction;
    
    document.querySelectorAll('#overallInventoryTable th[data-sort]').forEach(th => {
      th.removeAttribute('data-sort');
    });
    const header = document.querySelector(`#overall-filter-${column}`)?.closest('th');
    if (header) header.setAttribute('data-sort', direction);
    
    document.getElementById(`overall-filter-${column}`).style.display = 'none';
    renderOverallInventory();
  }
  
  // Overall Textfilter anzeigen
  function overallShowTextFilter(column) {
    const submenu = document.getElementById(`overall-textfilter-${column}`);
    if (!submenu) return;
    
    const menu = submenu.closest('.excel-filter-menu');
    if (!menu) return;
    
    // Alle anderen Submen√ºs schlie√üen
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => {
      if (m !== submenu) m.style.display = 'none';
    });
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => m.style.display = 'none');
    
    if (submenu.style.display === 'none' || !submenu.style.display) {
      submenu.style.display = 'block';
      
      // Position berechnen (rechts neben dem Hauptmen√º)
      const menuRect = menu.getBoundingClientRect();
      submenu.style.position = 'fixed';
      submenu.style.top = menuRect.top + 'px';
      submenu.style.left = (menuRect.right + 4) + 'px';
      submenu.style.zIndex = '10001';
      
      // Sicherstellen, dass Submen√º nicht au√üerhalb des Viewports ist
      setTimeout(() => {
        const submenuRect = submenu.getBoundingClientRect();
        if (submenuRect.right > window.innerWidth) {
          submenu.style.left = (menuRect.left - submenuRect.width - 4) + 'px';
        }
      }, 0);
    } else {
      submenu.style.display = 'none';
    }
  }
  
  // Overall Textfilter setzen
  function overallSetTextFilter(column, operator) {
    const submenu = document.getElementById(`overall-textfilter-${column}`);
    if (submenu) submenu.style.display = 'none';
    setTextFilter(column, operator, 'overall');
  }
  
  // Overall Zahlenfilter anzeigen
  function overallShowNumberFilter(column) {
    const submenu = document.getElementById(`overall-numberfilter-${column}`);
    if (!submenu) return;
    
    const menu = submenu.closest('.excel-filter-menu');
    if (!menu) return;
    
    // Alle anderen Submen√ºs schlie√üen
    document.querySelectorAll('.excel-textfilter-submenu').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.excel-numberfilter-submenu').forEach(m => {
      if (m !== submenu) m.style.display = 'none';
    });
    
    if (submenu.style.display === 'none' || !submenu.style.display) {
      submenu.style.display = 'block';
      
      // Position berechnen (rechts neben dem Hauptmen√º)
      const menuRect = menu.getBoundingClientRect();
      submenu.style.position = 'fixed';
      submenu.style.top = menuRect.top + 'px';
      submenu.style.left = (menuRect.right + 4) + 'px';
      submenu.style.zIndex = '10001';
      
      // Sicherstellen, dass Submen√º nicht au√üerhalb des Viewports ist
      setTimeout(() => {
        const submenuRect = submenu.getBoundingClientRect();
        if (submenuRect.right > window.innerWidth) {
          submenu.style.left = (menuRect.left - submenuRect.width - 4) + 'px';
        }
      }, 0);
    } else {
      submenu.style.display = 'none';
    }
  }
  
  // Overall Zahlenfilter setzen
  function overallSetNumberFilter(column, operator) {
    const submenu = document.getElementById(`overall-numberfilter-${column}`);
    if (submenu) submenu.style.display = 'none';
    setNumberFilter(column, operator, 'overall');
  }
  
  // Overall Spalten-Filter l√∂schen
  function overallClearColumnFilter(column) {
    delete overallFilters[column];
    document.getElementById(`overall-filter-${column}`).style.display = 'none';
    updateOverallFilterIndicators();
    renderOverallInventory();
  }
  
  // Overall Filter-Indikatoren aktualisieren
  function updateOverallFilterIndicators() {
    document.querySelectorAll('#overallInventoryTable th[data-filter-active]').forEach(th => {
      th.removeAttribute('data-filter-active');
    });
    
    Object.keys(overallFilters).forEach(column => {
      if (overallFilters[column]) {
        const header = document.querySelector(`#overall-filter-${column}`)?.closest('th');
        if (header) header.setAttribute('data-filter-active', 'true');
      }
    });
  }
  
  // Alle Overall-Filter l√∂schen
  function clearAllOverallFilters() {
    overallSortState = { column: null, direction: null };
    overallFilters = {};
    document.querySelectorAll('#overallInventoryTable th[data-sort]').forEach(th => {
      th.removeAttribute('data-sort');
    });
    document.querySelectorAll('#overallInventoryTable .excel-filter-menu').forEach(m => m.style.display = 'none');
    renderOverallInventory();
    showCustomModal("‚úì Alle Filter wurden gel√∂scht", "success");
  }
  
  // Tab-Wechsel f√ºr Lagerbestand
  function switchInventoryTab(tabName) {
    // Alle Tab-Contents verstecken
    document.querySelectorAll('.inventory-tab-content').forEach(content => {
      content.style.display = 'none';
    });
    
    // Alle Tab-Buttons deaktivieren
    document.querySelectorAll('.inventory-tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Gew√§hlten Tab aktivieren
    const content = document.getElementById(`inventory-tab-content-${tabName}`);
    const button = document.getElementById(`inventory-tab-${tabName}`);
    
    if (content) {
      content.style.display = 'block';
    }
    if (button) {
      button.classList.add('active');
    }
    
    // Daten laden wenn n√∂tig
    if (tabName === 'overall' && typeof loadOverallInventory === 'function') {
      loadOverallInventory();
    } else if (tabName === 'locations' && typeof loadWarehouse === 'function') {
      loadWarehouse();
    }
  }
  
  // Textfilter setzen (erweitert f√ºr Overall)
  function setTextFilter(column, operator, context = 'warehouse') {
    // Submen√º schlie√üen falls vorhanden
    if (context === 'overall') {
      const submenu = document.getElementById(`overall-textfilter-${column}`);
      if (submenu) submenu.style.display = 'none';
    } else {
      const submenu = document.getElementById(`excel-textfilter-${column}`);
      if (submenu) submenu.style.display = 'none';
    }
    
    const operatorLabels = {
      'equals': 'Ist gleich',
      'not-equals': 'Ist nicht gleich',
      'begins': 'Beginnt mit',
      'ends': 'Endet mit',
      'contains': 'Enth√§lt',
      'not-contains': 'Enth√§lt nicht'
    };
    
    const label = operatorLabels[operator] || operator;
    const currentValue = context === 'overall' 
      ? (overallFilters[column]?.operator === operator ? (overallFilters[column].value || '') : '')
      : (excelTextFilters[column]?.operator === operator ? (excelTextFilters[column].value || '') : '');
    
    // Verf√ºgbare Werte f√ºr Autocomplete sammeln
    const suggestions = getColumnSuggestions(column, context);
    
    const modalHtml = `
      <div class="excel-filter-input-modal">
        <div class="excel-filter-input-content">
          <div class="excel-filter-input-header">
            <span>${label}</span>
            <button onclick="closeFilterInputModal()" class="excel-filter-close-btn">√ó</button>
          </div>
          <div class="excel-filter-input-body">
            <div style="position: relative;">
              <input type="text" id="excel-filter-input-value" placeholder="Wert eingeben..." value="${currentValue}" autofocus autocomplete="off">
              <div id="excel-filter-autocomplete" class="excel-filter-autocomplete" style="display: none;"></div>
            </div>
            <div class="excel-filter-input-actions">
              <button onclick="applyTextFilter('${column}', '${operator}', '${context}')" class="excel-filter-apply-btn">√úbernehmen</button>
              <button onclick="closeFilterInputModal()" class="excel-filter-cancel-btn">Abbrechen</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const oldModal = document.querySelector('.excel-filter-input-modal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const inputElement = document.getElementById('excel-filter-input-value');
    const autocompleteDiv = document.getElementById('excel-filter-autocomplete');
    let selectedIndex = -1;
    
    if (inputElement) {
      // Autocomplete beim Tippen
      inputElement.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase().trim();
        if (value.length === 0) {
          autocompleteDiv.style.display = 'none';
          return;
        }
        
        // Passende Vorschl√§ge filtern
        const filtered = suggestions.filter(s => 
          s.toLowerCase().includes(value) && s.toLowerCase() !== value
        ).slice(0, 10); // Maximal 10 Vorschl√§ge
        
        if (filtered.length > 0) {
          autocompleteDiv.innerHTML = filtered.map((suggestion, idx) => 
            `<div class="excel-filter-autocomplete-item" data-index="${idx}" onclick="selectAutocompleteSuggestion('${suggestion.replace(/'/g, "\\'")}')">${highlightMatch(suggestion, value)}</div>`
          ).join('');
          autocompleteDiv.style.display = 'block';
          selectedIndex = -1;
        } else {
          autocompleteDiv.style.display = 'none';
        }
      });
      
      // Tastatur-Navigation
      inputElement.addEventListener('keydown', (e) => {
        const items = autocompleteDiv.querySelectorAll('.excel-filter-autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateAutocompleteSelection(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateAutocompleteSelection(items, selectedIndex);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            selectAutocompleteSuggestion(items[selectedIndex].textContent);
          } else {
            applyTextFilter(column, operator, context);
          }
        } else if (e.key === 'Escape') {
          autocompleteDiv.style.display = 'none';
          closeFilterInputModal();
        }
      });
      
      // Autocomplete schlie√üen wenn au√üerhalb geklickt wird
      document.addEventListener('click', (e) => {
        if (!inputElement.contains(e.target) && !autocompleteDiv.contains(e.target)) {
          autocompleteDiv.style.display = 'none';
        }
      }, { once: false });
      
      // Focus setzen
      setTimeout(() => inputElement.focus(), 100);
    }
  }
  
  // Vorschl√§ge f√ºr eine Spalte sammeln
  function getColumnSuggestions(column, context = 'warehouse') {
    const suggestions = new Set();
    
    if (context === 'overall') {
      if (overallInventoryData && overallInventoryData.length > 0) {
        overallInventoryData.forEach(row => {
          const value = row[column];
          if (value !== null && value !== undefined && value !== '') {
            suggestions.add(String(value));
          }
        });
      }
    } else {
      if (warehouseData && warehouseData.length > 0) {
        warehouseData.forEach(location => {
          if (location.cartons && location.cartons.length > 0) {
            location.cartons.forEach(carton => {
              const value = carton[column];
              if (value !== null && value !== undefined && value !== '') {
                suggestions.add(String(value));
              }
            });
          }
        });
      }
    }
    
    return Array.from(suggestions).sort();
  }
  
  // Text-Hervorhebung f√ºr Autocomplete
  function highlightMatch(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }
  
  // Autocomplete-Auswahl aktualisieren
  function updateAutocompleteSelection(items, selectedIndex) {
    items.forEach((item, idx) => {
      if (idx === selectedIndex) {
        item.classList.add('selected');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('selected');
      }
    });
  }
  
  // Autocomplete-Vorschlag ausw√§hlen
  function selectAutocompleteSuggestion(value) {
    const input = document.getElementById('excel-filter-input-value');
    if (input) {
      input.value = value;
      const autocompleteDiv = document.getElementById('excel-filter-autocomplete');
      if (autocompleteDiv) autocompleteDiv.style.display = 'none';
      input.focus();
    }
  }
  
  // Textfilter anwenden (erweitert)
  function applyTextFilter(column, operator, context = 'warehouse') {
    const input = document.getElementById('excel-filter-input-value');
    if (!input) return;
    
    const value = input.value.trim();
    
    if (context === 'overall') {
      if (value) {
        overallFilters[column] = { type: 'text', operator, value };
      } else {
        delete overallFilters[column];
      }
      closeFilterInputModal();
      const menu = document.getElementById(`overall-filter-${column}`);
      if (menu) menu.style.display = 'none';
      updateOverallFilterIndicators();
      renderOverallInventory();
    } else {
      if (value) {
        excelTextFilters[column] = { operator, value };
      } else {
        delete excelTextFilters[column];
      }
      closeFilterInputModal();
      updateExcelFilterIndicators();
      const menu = document.getElementById(`excel-filter-${column}`);
      if (menu) menu.style.display = 'none';
      renderWarehouseTable();
    }
  }
  
  // Zahlenfilter setzen (erweitert)
  function setNumberFilter(column, operator, context = 'warehouse') {
    const operatorLabels = {
      'equals': 'Ist gleich',
      'not-equals': 'Ist nicht gleich',
      'greater': 'Gr√∂√üer als',
      'less': 'Kleiner als',
      'greater-equal': 'Gr√∂√üer oder gleich',
      'less-equal': 'Kleiner oder gleich'
    };
    
    const label = operatorLabels[operator] || operator;
    const currentValue = context === 'overall'
      ? (overallFilters[column]?.value || '')
      : (excelNumberFilters[column]?.operator === operator ? excelNumberFilters[column].value : '');
    
    const modalHtml = `
      <div class="excel-filter-input-modal">
        <div class="excel-filter-input-content">
          <div class="excel-filter-input-header">
            <span>${label}</span>
            <button onclick="closeFilterInputModal()" class="excel-filter-close-btn">√ó</button>
          </div>
          <div class="excel-filter-input-body">
            <input type="number" id="excel-filter-input-value" placeholder="Zahl eingeben..." value="${currentValue}" autofocus step="any">
            <div class="excel-filter-input-actions">
              <button onclick="applyNumberFilter('${column}', '${operator}', '${context}')" class="excel-filter-apply-btn">√úbernehmen</button>
              <button onclick="closeFilterInputModal()" class="excel-filter-cancel-btn">Abbrechen</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const oldModal = document.querySelector('.excel-filter-input-modal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    document.getElementById('excel-filter-input-value').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        applyNumberFilter(column, operator, context);
      } else if (e.key === 'Escape') {
        closeFilterInputModal();
      }
    });
  }
  
  // Zahlenfilter anwenden (erweitert)
  function applyNumberFilter(column, operator, context = 'warehouse') {
    const input = document.getElementById('excel-filter-input-value');
    if (!input) return;
    
    const value = input.value.trim();
    
    if (context === 'overall') {
      if (value === '') {
        delete overallFilters[column];
      } else {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) {
          alert('Bitte geben Sie eine g√ºltige Zahl ein.');
          return;
        }
        overallFilters[column] = { type: 'number', operator, value: numValue };
      }
      closeFilterInputModal();
      const menu = document.getElementById(`overall-filter-${column}`);
      if (menu) menu.style.display = 'none';
      updateOverallFilterIndicators();
      renderOverallInventory();
    } else {
      if (value === '') {
        delete excelNumberFilters[column];
      } else {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) {
          alert('Bitte geben Sie eine g√ºltige Zahl ein.');
          return;
        }
        excelNumberFilters[column] = { operator, value: numValue };
      }
      closeFilterInputModal();
      updateExcelFilterIndicators();
      document.getElementById(`excel-filter-${column}`).style.display = 'none';
      renderWarehouseTable();
    }
  }
  
  // Filter-Indikatoren aktualisieren
  function updateExcelFilterIndicators() {
    document.querySelectorAll('th[data-filter-active]').forEach(th => {
      th.removeAttribute('data-filter-active');
    });
    
    Object.keys(excelTextFilters).forEach(column => {
      if (excelTextFilters[column]) {
        const header = document.querySelector(`#excel-filter-${column}`)?.closest('th');
        if (header) header.setAttribute('data-filter-active', 'true');
      }
    });
    
    Object.keys(excelNumberFilters).forEach(column => {
      if (excelNumberFilters[column]) {
        const header = document.querySelector(`#excel-filter-${column}`)?.closest('th');
        if (header) header.setAttribute('data-filter-active', 'true');
      }
    });
    
    Object.keys(excelValueFilters).forEach(column => {
      if (excelValueFilters[column] && excelValueFilters[column].length > 0) {
        const header = document.querySelector(`#excel-filter-${column}`)?.closest('th');
        if (header) header.setAttribute('data-filter-active', 'true');
      }
    });
  }
  
  function viewLocationDetails(locationId) {
    const location = warehouseData.find(l => l.id === locationId);
    if (!location) return;
    
    showCustomModal(`üìç ${location.code}\n${location.description || ''}\nArea: ${location.area || 'Unbekannt'}\nKartons: ${location.total_cartons || 0}`, "info");
  }
  
  async function editInboundEntry(entryId, locationId) {
    try {
      let entry = null;
      
      // Wenn locationId vorhanden, aus Stellplatz-Details laden
      if (locationId) {
        const response = await fetch(`/api/warehouse/locations/${locationId}/details`);
        if (response.ok) {
          const data = await response.json();
          entry = data.cartons.find(c => c.id === entryId);
        }
      }
      
      // Falls nicht gefunden, direkt aus API laden
      if (!entry) {
        const response = await fetch(`/api/inbound-simple/${entryId}`);
        if (response.ok) {
          entry = await response.json();
        } else {
          // Fallback: Aus Liste laden
          const listResponse = await fetch("/api/inbound-simple");
          if (listResponse.ok) {
            const data = await listResponse.json();
            entry = data.find(e => e.id === entryId);
          }
        }
      }
      
      if (!entry) {
        showCustomModal("‚ùå Eintrag nicht gefunden", "error");
        return;
      }
      
      // Modal HTML erstellen - ALLE Felder
      const modalHtml = `
        <div style="max-width: 1000px; width: 100%;">
          <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text-main);">üì¶ Eintrag #${entry.id} bearbeiten</h3>
          
          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-soft); border-radius: 8px; font-size: 12px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div><strong>Gebucht am:</strong> ${formatDateTime(entry.created_at)}</div>
              <div><strong>Von:</strong> ${entry.added_by || '-'}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">CW</label>
              <input type="text" id="editCw" value="${entry.cw || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Aufgenommen am</label>
              <input type="date" id="editAufgenommenAm" value="${entry.aufgenommen_am ? entry.aufgenommen_am.split('T')[0] : ''}" lang="de-DE" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Carrier Name</label>
              <input type="text" id="editCarrierName" value="${entry.carrier_name || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Area</label>
              <input type="text" id="editArea" value="${entry.area || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Land</label>
              <input type="text" id="editLand" value="${entry.land || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Ship Status</label>
              <input type="text" id="editShipStatus" value="${entry.ship_status || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Stage</label>
              <input type="text" id="editStage" value="${entry.stage || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Last Stage</label>
              <input type="text" id="editLastStage" value="${entry.last_stage || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Planned Carton</label>
              <input type="number" id="editPlannedCarton" value="${entry.planned_carton || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Actual Carton <span style="color: var(--gxo-orange);">*</span></label>
              <input type="number" id="editActualCarton" value="${entry.actual_carton || ''}" min="0" required style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">OLPN</label>
              <input type="text" id="editOlpn" value="${entry.olpn || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: monospace;">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Carrier Tracking Number</label>
              <input type="text" id="editTrackingNr" value="${entry.carrier_tracking_nr || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: monospace;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">DN</label>
              <input type="text" id="editDn" value="${entry.dn || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">SHI</label>
              <input type="text" id="editShi" value="${entry.shi || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Customer ID</label>
              <input type="text" id="editCustomerId" value="${entry.customer_id || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: monospace;">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Customer Name</label>
              <input type="text" id="editCustomerName" value="${entry.customer_name || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">ASN/RA Nummer</label>
              <input type="text" id="editAsnRaNo" value="${entry.asn_ra_no || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: monospace;">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">MH Status</label>
              <input type="text" id="editMhStatus" value="${entry.mh_status || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Neue RA</label>
              <input type="text" id="editNeueRa" value="${entry.neue_ra || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">New Reopen RA</label>
              <input type="text" id="editNewReopenRa" value="${entry.new_reopen_ra || ''}" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Kommentar</label>
              <textarea id="editKommentar" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); resize: vertical;">${entry.kommentar || ''}</textarea>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Ignore Flag</label>
              <select id="editIgnoreFlag" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
                <option value="0" ${entry.ignore_flag == 0 ? 'selected' : ''}>Nein</option>
                <option value="1" ${entry.ignore_flag == 1 ? 'selected' : ''}>Ja</option>
              </select>
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Grund f√ºr √Ñnderung <span style="color: var(--gxo-orange);">*</span></label>
            <textarea id="editChangeReason" rows="2" placeholder="Bitte geben Sie einen Grund f√ºr die √Ñnderung an..." required style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main); resize: vertical;"></textarea>
          </div>
        </div>
      `;
      
      // Modal anzeigen mit Custom-Buttons
      showEditModal(modalHtml, async () => {
        // ALLE Felder auslesen
        const cw = document.getElementById("editCw").value;
        const aufgenommenAm = document.getElementById("editAufgenommenAm").value;
        const carrierName = document.getElementById("editCarrierName").value;
        const area = document.getElementById("editArea").value;
        const land = document.getElementById("editLand").value;
        const shipStatus = document.getElementById("editShipStatus").value;
        const stage = document.getElementById("editStage").value;
        const lastStage = document.getElementById("editLastStage").value;
        const plannedCarton = document.getElementById("editPlannedCarton").value;
        const actualCarton = document.getElementById("editActualCarton").value;
        const olpn = document.getElementById("editOlpn").value;
        const trackingNr = document.getElementById("editTrackingNr").value;
        const dn = document.getElementById("editDn").value;
        const shi = document.getElementById("editShi").value;
        const customerId = document.getElementById("editCustomerId").value;
        const customerName = document.getElementById("editCustomerName").value;
        const asnRaNo = document.getElementById("editAsnRaNo").value;
        const mhStatus = document.getElementById("editMhStatus").value;
        const neueRa = document.getElementById("editNeueRa").value;
        const newReopenRa = document.getElementById("editNewReopenRa").value;
        const kommentar = document.getElementById("editKommentar").value;
        const ignoreFlag = document.getElementById("editIgnoreFlag").value;
        const changeReason = document.getElementById("editChangeReason").value;
        
        if (!changeReason || changeReason.trim() === "") {
          showCustomModal("‚ùå Bitte geben Sie einen Grund f√ºr die √Ñnderung an", "error");
          return false;
        }
        
        if (actualCarton && parseInt(actualCarton) < 0) {
          showCustomModal("‚ùå Actual Carton darf nicht negativ sein", "error");
          return false;
        }
        
        if (plannedCarton && parseInt(plannedCarton) < 0) {
          showCustomModal("‚ùå Planned Carton darf nicht negativ sein", "error");
          return false;
        }
        
        // Update senden - ALLE Felder
        try {
          const updateResponse = await fetch(`/api/inbound-simple/${entryId}`, {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json',
              'x-user': currentWindowsUser || 'System'
            },
            body: JSON.stringify({
              cw: cw ? cw.trim() : null,
              aufgenommen_am: aufgenommenAm || null,
              carrier_name: carrierName ? carrierName.trim() : null,
              area: area ? area.trim() : null,
              land: land ? land.trim() : null,
              ship_status: shipStatus ? shipStatus.trim() : null,
              stage: stage ? stage.trim() : null,
              last_stage: lastStage ? lastStage.trim() : null,
              planned_carton: plannedCarton ? parseInt(plannedCarton) : null,
              actual_carton: actualCarton ? parseInt(actualCarton) : null,
              olpn: olpn ? olpn.trim() : null,
              carrier_tracking_nr: trackingNr ? trackingNr.trim() : null,
              dn: dn ? dn.trim() : null,
              shi: shi ? shi.trim() : null,
              customer_id: customerId ? customerId.trim() : null,
              customer_name: customerName ? customerName.trim() : null,
              asn_ra_no: asnRaNo ? asnRaNo.trim() : null,
              mh_status: mhStatus ? mhStatus.trim() : null,
              neue_ra: neueRa ? neueRa.trim() : null,
              new_reopen_ra: newReopenRa ? newReopenRa.trim() : null,
              kommentar: kommentar || null,
              ignore_flag: ignoreFlag === "1" ? 1 : 0,
              change_reason: changeReason,
              addedBy: currentWindowsUser || 'System'
            })
          });
          
          if (!updateResponse.ok) {
            let errorMessage = `HTTP ${updateResponse.status}: ${updateResponse.statusText}`;
            try {
              const contentType = updateResponse.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                const errorData = await updateResponse.json();
                errorMessage = errorData.error || errorData.message || errorMessage;
              } else {
                const text = await updateResponse.text();
                console.error("‚ùå Server antwortete mit HTML statt JSON:", text.substring(0, 200));
                errorMessage = `Server-Fehler (${updateResponse.status}). Bitte Server-Logs pr√ºfen.`;
              }
            } catch (parseErr) {
              console.error("‚ùå Fehler beim Parsen der Fehlerantwort:", parseErr);
              errorMessage = `Fehler beim Verarbeiten der Server-Antwort (${updateResponse.status})`;
            }
            throw new Error(errorMessage);
          }
          
          showCustomModal("‚úì Eintrag erfolgreich aktualisiert", "success");
          
          // Details neu laden wenn locationId vorhanden
          if (locationId) {
            await loadLocationDetails(locationId);
            // Lagerbestand aktualisieren
            await loadWarehouse();
          }
          
          // Inbound-Liste aktualisieren
          await loadInboundList();
          
          return true;
        } catch (err) {
          showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
          return false;
        }
      });
      
    } catch (err) {
      console.error("Fehler beim Laden des Eintrags:", err);
      showCustomModal("‚ùå Fehler beim Laden des Eintrags", "error");
    }
  }
  
  function showEditModal(content, onSave) {
    // Modal-Overlay erstellen
    const overlay = document.createElement("div");
    overlay.id = "editModalOverlay";
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    
    // Modal-Content erstellen
    const modal = document.createElement("div");
    modal.style.cssText = `
      background: var(--bg-card);
      border-radius: 14px;
      padding: 24px;
      max-width: 95%;
      width: 1100px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    `;
    
    modal.innerHTML = content + `
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-ghost" id="editModalCancel" style="padding: 10px 20px;">Abbrechen</button>
        <button class="btn btn-primary" id="editModalSave" style="padding: 10px 20px;">Speichern</button>
      </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Event-Handler
    const closeModal = () => {
      document.body.removeChild(overlay);
    };
    
    document.getElementById("editModalCancel").onclick = closeModal;
    
    document.getElementById("editModalSave").onclick = async () => {
      const result = await onSave();
      if (result) {
        closeModal();
      }
    };
    
    // ESC-Taste schlie√üt Modal
    const escHandler = (e) => {
      if (e.key === "Escape") {
        closeModal();
        document.removeEventListener("keydown", escHandler);
      }
    };
    document.addEventListener("keydown", escHandler);
    
    // Klick au√üerhalb schlie√üt Modal
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        closeModal();
      }
    };
  }
  
  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('de-DE', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Legacy function f√ºr Kompatibilit√§t
  async function loadInventory() {
    await loadWarehouse();
  }

  /* Globale Variablen */
  let carriersData = [];
  let currentWindowsUser = "Unbekannt";
  let currentCarrier = null;
  let areaOptions = [];
  let landOptions = [];
  let isBulkMode = false;
  let bulkDefaults = {};
  let bulkSavedCount = 0;
  
  async function loadCarriers() {
    const container = document.getElementById("carrierButtonsGrid");
    if (!container) return;

    container.innerHTML = '<span class="muted">Carrier werden geladen...</span>';

    try {
      const response = await fetch("/api/carriers");
      if (!response.ok) {
        throw new Error("Code " + response.status);
      }
      const data = await response.json();
      carriersData = data;
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = '<span class="muted">Noch keine Carrier Stammdaten vorhanden</span>';
        return;
      }

      // Carrier Icons Mapping
      const carrierIcons = {
        "DPD": "üì¶",
        "Geodis": "üöö",
        "DHL": "üìÆ",
        "BRT": "üöõ",
        "FedEx": "‚úàÔ∏è",
        "Zalando Ware": "üõçÔ∏è",
        "Postnord": "üì¨",
        "Lost and Found": "üîç",
        "Lost & Found": "üîç",
        "Dachser": "üè≠",
        "DACHSER": "üè≠",
        "Duwensee": "üö¢"
      };

      data.forEach(car => {
        const card = document.createElement("div");
        card.className = "carrier-card";
        card.setAttribute("data-carrier-id", car.id);
        
        // Markiere aktiven Carrier
        if (currentCarrier && currentCarrier.id === car.id) {
          card.classList.add("active");
        }
        
        const icon = carrierIcons[car.name] || "üìã";
        const countryText = car.country ? `(${car.country})` : "";
        
        card.innerHTML = `
          <div class="carrier-card-icon">${icon}</div>
          <div class="carrier-card-name">${car.display_name}</div>
          ${countryText ? `<div class="carrier-card-country">${countryText}</div>` : ''}
        `;
        
        card.addEventListener("click", () => {
          // Entferne active von allen Karten
          document.querySelectorAll('.carrier-card').forEach(c => c.classList.remove('active'));
          // Markiere diese Karte
          card.classList.add('active');
          selectCarrier(car);
        });

        container.appendChild(card);
      });
    } catch (err) {
      console.error("Fehler beim Laden der Carrier", err);
      container.innerHTML = '<span class="muted">Fehler beim Laden der Carrier Stammdaten</span>';
    }
  }

  async function selectCarrier(carrier) {
    currentCarrier = carrier;
    
    // Pr√ºfen ob wir auf der Einstellungsseite sind
    const isSettingsPage = document.getElementById("settingsContent") && 
                          document.getElementById("settingsContent").style.display !== "none";
    
    if (!isSettingsPage) {
      // Nur auf der Wareneingang-Seite: Ansicht wechseln
      const carrierSelectionView = document.getElementById("carrierSelectionView");
      const inboundDetailView = document.getElementById("inboundDetailView");
      if (carrierSelectionView) carrierSelectionView.style.display = "none";
      if (inboundDetailView) inboundDetailView.style.display = "block";
      
      // Letzte Eintr√§ge Tabelle ausblenden
      const inboundListSection = document.getElementById("inboundListSection");
      if (inboundListSection) {
        inboundListSection.style.display = "none";
      }
    }
    
    // Carrier Name anzeigen
    document.getElementById("selectedCarrierName").textContent = carrier.display_name;
    
    // ERST alle Felder anzeigen (Reset)
    resetAllFieldsVisibility();
    
    // Dropdowns laden
    await loadDropdownOptions();
    
    // Felder vorausf√ºllen
    const areaInput = document.getElementById("areaInput");
    const stageInput = document.getElementById("stageInput");
    const lastStageInput = document.getElementById("lastStageInput");
    const landInput = document.getElementById("landInput");
    const shipStatusInput = document.getElementById("shipStatusInput");
    const carrierNameInput = document.getElementById("carrierNameInput");
    const addedByInput = document.getElementById("addedByInput");

    if (carrierNameInput) carrierNameInput.value = carrier.display_name || carrier.name || "";
    if (shipStatusInput && carrier.default_ship_status) shipStatusInput.value = carrier.default_ship_status;
    
    // Searchable Dropdowns vorausf√ºllen
    if (areaInput && carrier.default_area) {
      const areaOption = areaOptions.find(opt => opt.option_value === carrier.default_area);
      if (areaOption) {
        areaInput.value = areaOption.option_label;
        areaInput.setAttribute('data-value', areaOption.option_value);
      }
    }
    
    if (landInput && carrier.country) {
      const landOption = landOptions.find(opt => opt.option_value === carrier.country);
      if (landOption) {
        landInput.value = landOption.option_label;
        landInput.setAttribute('data-value', landOption.option_value);
      }
    }
    
    // Added By mit Windows Benutzer f√ºllen
    if (addedByInput) {
      addedByInput.value = currentWindowsUser;
      addedByInput.readOnly = true;
    }
    
    // Label-Bilder und Hilfetext setzen
    const labelImagesContainer = document.getElementById("labelImagesContainer");
    const labelImagesGrid = document.getElementById("labelImagesGrid");
    const labelHelpText = document.getElementById("labelHelpText");
    
    if (carrier.label_image && labelImagesGrid && labelImagesContainer) {
      // Unterst√ºtzt mehrere Bilder (komma-separiert)
      const images = carrier.label_image.split(',').map(img => img.trim()).filter(img => img);
      
      if (images.length > 0) {
        labelImagesGrid.innerHTML = '';
        
        images.forEach((imagePath, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'label-image-wrapper';
          
          const img = document.createElement('img');
          img.src = imagePath;
          img.alt = `Label Beispiel ${index + 1}`;
          img.className = 'label-image-thumbnail';
          
          // Fehlerbehandlung
          img.onerror = () => {
            wrapper.remove();
            if (labelImagesGrid.children.length === 0) {
              labelImagesContainer.style.display = "none";
            }
          };
          
          wrapper.appendChild(img);
          labelImagesGrid.appendChild(wrapper);
        });
        
        labelImagesContainer.style.display = "block";
      } else {
        labelImagesContainer.style.display = "none";
      }
    } else if (labelImagesContainer) {
      labelImagesContainer.style.display = "none";
    }
    
    // Label Help Text nur √ºberschreiben, wenn vorhanden und nicht leer
    if (carrier.label_help_text && carrier.label_help_text.trim() !== "" && labelHelpText) {
      labelHelpText.innerHTML = carrier.label_help_text.replace(/\n/g, '<br>');
    }
    // Sonst bleiben die Standard-Informationen aus dem HTML erhalten
    
    // CW und Datum automatisch setzen
    setDefaultDateAndCW();
    
    // Felder ein-/ausblenden basierend auf visible_fields
    applyVisibleFields(carrier);
  }
  
  function resetAllFieldsVisibility() {
    // Zeige erstmal alle Felder an
    const allInputIds = [
      'cwInput', 'aufgenommenInput', 'ignoreInput', 'areaInput', 'stageInput',
      'lastStageInput', 'carrierNameInput', 'landInput', 'shipStatusInput',
      'plannedCartonInput', 'actualCartonInput', 'olpnInput', 'dnInput',
      'shiInput', 'carrierTrackingInput', 'customerIdInput', 'customerNameInput',
      'asnInput', 'kommentarInput', 'addedByInput'
    ];
    
    allInputIds.forEach(inputId => {
      const inputElement = document.getElementById(inputId);
      if (inputElement) {
        let parent = inputElement.closest('.form-group');
        if (!parent) {
          parent = inputElement.closest('.searchable-dropdown')?.parentElement;
        }
        if (parent) {
          parent.style.display = '';
        }
      }
    });
  }

  function applyVisibleFields(carrier) {
    console.log("applyVisibleFields aufgerufen f√ºr Carrier:", carrier.display_name);
    console.log("visible_fields (raw):", carrier.visible_fields);
    
    // Alle Felder und ihre parent form-group
    const fieldMapping = {
      'cw': 'cwInput',
      'aufgenommen_am': 'aufgenommenInput',
      'ignore': 'ignoreInput',
      'area': 'areaInput',
      'stage': 'stageInput',
      'last_stage': 'lastStageInput',
      'carrier_name': 'carrierNameInput',
      'land': 'landInput',
      'ship_status': 'shipStatusInput',
      'planned_carton': 'plannedCartonInput',
      'actual_carton': 'actualCartonInput',
      'olpn': 'olpnInput',
      'dn': 'dnInput',
      'shi': 'shiInput',
      'carrier_tracking_nr': 'carrierTrackingInput',
      'customer_id': 'customerIdInput',
      'customer_name': 'customerNameInput',
      'asn_ra_no': 'asnInput',
      'kommentar': 'kommentarInput',
      'added_by': 'addedByInput'
    };
    
    let visibleFields = [];
    if (carrier.visible_fields) {
      try {
        visibleFields = JSON.parse(carrier.visible_fields);
        console.log("Geparste visible_fields:", visibleFields);
      } catch (e) {
        console.error("Fehler beim Parsen von visible_fields:", e);
        // Fallback: Alle Felder anzeigen
        visibleFields = Object.keys(fieldMapping);
      }
    } else {
      // Fallback: Alle Felder anzeigen
      visibleFields = Object.keys(fieldMapping);
      console.log("Keine visible_fields gefunden, zeige alle Felder");
    }
    
    // Alle Felder durchgehen und ein-/ausblenden
    Object.keys(fieldMapping).forEach(fieldKey => {
      const inputId = fieldMapping[fieldKey];
      const inputElement = document.getElementById(inputId);
      
      if (inputElement) {
        // Finde die parent form-group oder searchable-dropdown
        let parent = inputElement.closest('.form-group');
        if (!parent) {
          parent = inputElement.closest('.searchable-dropdown')?.parentElement;
        }
        
        if (parent) {
          if (visibleFields.includes(fieldKey)) {
            parent.style.display = '';
            parent.style.visibility = 'visible';
            console.log(`‚úì Zeige Feld: ${fieldKey}`, parent);
          } else {
            parent.style.display = 'none';
            parent.style.visibility = 'hidden';
            console.log(`‚úó Verstecke Feld: ${fieldKey}`, parent);
          }
        } else {
          console.warn(`‚ö†Ô∏è Kein Parent gefunden f√ºr: ${fieldKey} (Input: ${inputId})`);
        }
      } else {
        console.warn(`‚ö†Ô∏è Input-Element nicht gefunden: ${inputId} f√ºr Feld: ${fieldKey}`);
      }
    });
  }

  function backToCarrierSelection() {
    // Zur√ºck zur Carrier-Auswahl auf der Wareneingang-Seite
    const carrierSelectionView = document.getElementById("carrierSelectionView");
    const inboundDetailView = document.getElementById("inboundDetailView");
    const inboundListSection = document.getElementById("inboundListSection");
    
    if (carrierSelectionView) carrierSelectionView.style.display = "block";
    if (inboundDetailView) inboundDetailView.style.display = "none";
    if (inboundListSection) inboundListSection.style.display = "block";
    
    // Formular zur√ºcksetzen
    clearInboundForm();
    
    // Entferne active Markierung von allen Carrier-Karten
    document.querySelectorAll('.carrier-card').forEach(c => c.classList.remove('active'));
    
    // Bulk-Modus zur√ºcksetzen
    if (isBulkMode) {
      switchToSingleMode();
      bulkDefaults = {};
      bulkSavedCount = 0;
    }
    
    currentCarrier = null;
    clearInboundForm();
  }

  async function loadDropdownOptions() {
    try {
      // Area Optionen laden
      const areaResponse = await fetch("/api/dropdown-options/area");
      if (areaResponse.ok) {
        areaOptions = await areaResponse.json();
        initSearchableDropdown('area', areaOptions);
      }

      // Land Optionen laden
      const landResponse = await fetch("/api/dropdown-options/land");
      if (landResponse.ok) {
        landOptions = await landResponse.json();
        initSearchableDropdown('land', landOptions);
      }
      
      // Stellpl√§tze laden und Dropdowns initialisieren
      await initLocationDropdown('location');
      await initLocationDropdown('bulkLocation');
    } catch (err) {
      console.error("Fehler beim Laden der Dropdown-Optionen:", err);
    }
  }
  
  async function initLocationDropdown(prefix) {
    try {
      const input = document.getElementById(`${prefix}Input`);
      const list = document.getElementById(`${prefix}DropdownList`);
      
      if (!input || !list) return;
      
      // Stellpl√§tze laden
      const response = await fetch("/api/warehouse/locations?active_only=true");
      if (!response.ok) return;
      
      const locations = await response.json();
      
      // Dropdown initialisieren
      let selectedValue = '';
      let selectedLabel = '';
      
      const renderOptions = (filter = '') => {
        list.innerHTML = '';
        
        const filtered = locations.filter(loc => 
          loc.code.toLowerCase().includes(filter.toLowerCase()) ||
          (loc.description && loc.description.toLowerCase().includes(filter.toLowerCase()))
        );
        
        if (filtered.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'searchable-dropdown-empty';
          empty.textContent = 'Keine Stellpl√§tze gefunden';
          list.appendChild(empty);
          return;
        }
        
        filtered.forEach(loc => {
          const item = document.createElement('div');
          item.className = 'searchable-dropdown-item';
          item.innerHTML = `
            <div style="font-weight: 600;">${loc.code}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${loc.description || ''} ${loc.area ? '‚Ä¢ ' + loc.area : ''}</div>
          `;
          item.setAttribute('data-value', loc.id);
          item.setAttribute('data-label', loc.code);
          
          item.addEventListener('click', () => {
            selectedValue = loc.id;
            selectedLabel = loc.code;
            input.value = loc.code;
            input.setAttribute('data-value', loc.id);
            input.setAttribute('data-area', loc.area || '');
            list.classList.remove('active');
            input.blur();
            
            // Area automatisch setzen, wenn Stellplatz einen Bereich hat
            if (loc.area) {
              // F√ºr Single-Modus
              const areaInput = document.getElementById('areaInput');
              if (areaInput) {
                areaInput.value = loc.area;
                areaInput.setAttribute('data-value', loc.area);
                console.log(`‚úÖ Area automatisch gesetzt: ${loc.area} (von Stellplatz ${loc.code})`);
              }
              
              // F√ºr Bulk-Modus
              const bulkAreaInput = document.getElementById('bulkAreaInput');
              if (bulkAreaInput) {
                bulkAreaInput.value = loc.area;
                bulkAreaInput.setAttribute('data-value', loc.area);
                console.log(`‚úÖ Area automatisch gesetzt (Bulk): ${loc.area} (von Stellplatz ${loc.code})`);
                
                // Area auch in bulkDefaults speichern, falls bereits vorhanden
                if (typeof bulkDefaults !== 'undefined') {
                  bulkDefaults.area = loc.area;
                }
              }
            }
          });
          
          list.appendChild(item);
        });
      };
      
      input.addEventListener('focus', () => {
        renderOptions();
        list.classList.add('active');
      });
      
      input.addEventListener('input', (e) => {
        renderOptions(e.target.value);
        list.classList.add('active');
      });
      
      // Au√üerhalb klicken schlie√üt Dropdown
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          list.classList.remove('active');
        }
      });
      
    } catch (err) {
      console.error(`Fehler beim Initialisieren des Location-Dropdowns (${prefix}):`, err);
    }
  }

  function initSearchableDropdownSettings(fieldName, options) {
    const input = document.getElementById(`${fieldName}Select`);
    const list = document.getElementById(`${fieldName}DropdownList`);
    
    if (!input || !list) return;
    
    let selectedValue = '';
    let selectedLabel = '';
    
    // Liste mit Optionen f√ºllen
    const renderOptions = (filter = '') => {
      list.innerHTML = '';
      
      const filtered = options.filter(opt => 
        opt.option_label.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'searchable-dropdown-empty';
        empty.textContent = 'Keine Ergebnisse gefunden';
        list.appendChild(empty);
        return;
      }
      
      filtered.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'searchable-dropdown-item';
        item.textContent = opt.option_label;
        item.setAttribute('data-value', opt.option_value);
        
        if (opt.option_value === selectedValue) {
          item.classList.add('selected');
        }
        
        item.addEventListener('click', () => {
          selectedValue = opt.option_value;
          selectedLabel = opt.option_label;
          input.value = opt.option_label;
          input.setAttribute('data-value', opt.option_value);
          list.classList.remove('active');
          
          // Trigger change event f√ºr Settings
          if (fieldName === 'settingsCarrier') {
            loadCarrierSettings(opt.option_value);
          }
        });
        
        list.appendChild(item);
      });
    };
    
    // Input Events
    input.addEventListener('focus', () => {
      renderOptions(input.value);
      list.classList.add('active');
    });
    
    input.addEventListener('input', () => {
      renderOptions(input.value);
      list.classList.add('active');
    });
    
    input.addEventListener('blur', (e) => {
      setTimeout(() => {
        list.classList.remove('active');
        if (!selectedValue && input.value) {
          input.value = '';
        } else if (selectedValue) {
          input.value = selectedLabel;
        }
      }, 200);
    });
    
    // Schlie√üen bei Klick au√üerhalb
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !list.contains(e.target)) {
        list.classList.remove('active');
      }
    });
    
    // Initial rendern
    renderOptions();
  }

  function initSearchableDropdown(fieldName, options) {
    const input = document.getElementById(`${fieldName}Input`);
    const list = document.getElementById(`${fieldName}DropdownList`);
    
    if (!input || !list) return;
    
    let selectedValue = '';
    let selectedLabel = '';
    
    // Liste mit Optionen f√ºllen
    const renderOptions = (filter = '') => {
      list.innerHTML = '';
      
      const filtered = options.filter(opt => 
        opt.option_label.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'searchable-dropdown-empty';
        empty.textContent = 'Keine Ergebnisse gefunden';
        list.appendChild(empty);
        return;
      }
      
      filtered.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'searchable-dropdown-item';
        item.textContent = opt.option_label;
        item.setAttribute('data-value', opt.option_value);
        
        if (opt.option_value === selectedValue) {
          item.classList.add('selected');
        }
        
        item.addEventListener('click', () => {
          selectedValue = opt.option_value;
          selectedLabel = opt.option_label;
          input.value = opt.option_label;
          input.setAttribute('data-value', opt.option_value);
          list.classList.remove('active');
        });
        
        list.appendChild(item);
      });
    };
    
    // Input Events
    input.addEventListener('focus', () => {
      renderOptions(input.value);
      list.classList.add('active');
    });
    
    input.addEventListener('input', () => {
      renderOptions(input.value);
      list.classList.add('active');
    });
    
    input.addEventListener('blur', (e) => {
      // Verz√∂gerung, damit Click auf Item noch funktioniert
      setTimeout(() => {
        list.classList.remove('active');
        // Wenn kein g√ºltiger Wert, zur√ºcksetzen
        if (!selectedValue && input.value) {
          input.value = '';
        } else if (selectedValue) {
          input.value = selectedLabel;
        }
      }, 200);
    });
    
    // Initial rendern
    renderOptions();
    
    // Schlie√üen bei Klick au√üerhalb
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !list.contains(e.target)) {
        list.classList.remove('active');
      }
    });
  }

  /* Windows Benutzer automatisch erkennen */
  async function loadCurrentWindowsUser() {
    try {
      const response = await fetch("/api/current-user");
      if (response.ok) {
        const result = await response.json();
        currentWindowsUser = result.username;
        currentWindowsDisplayName = result.displayName || result.username;
        currentProfilePicturePath = result.profilePicturePath || null;
        updateUserDisplay();
        
        console.log("üë§ Windows Benutzer erkannt:", currentWindowsUser);
        console.log("üë§ Vollst√§ndiger Name:", currentWindowsDisplayName);
        console.log("üíª Computer:", result.computerName);
        console.log("üñºÔ∏è Profilbild:", currentProfilePicturePath ? "Verf√ºgbar" : "Nicht verf√ºgbar");
        
        // Added By Feld automatisch f√ºllen falls bereits sichtbar
        const addedByInput = document.getElementById("addedByInput");
        if (addedByInput) {
          addedByInput.value = currentWindowsUser;
          addedByInput.readOnly = true;
        }
        
        return currentWindowsUser;
      } else {
        console.error("‚ùå Fehler beim Laden des Windows-Benutzers");
        currentWindowsUser = "Unbekannt";
        currentWindowsDisplayName = null;
        currentProfilePicturePath = null;
        updateUserDisplay();
        return currentWindowsUser;
      }
    } catch (err) {
      console.error("‚ùå Fehler beim Laden des Windows-Benutzers:", err);
      currentWindowsUser = "Unbekannt";
      currentWindowsDisplayName = null;
      currentProfilePicturePath = null;
      updateUserDisplay();
      return currentWindowsUser;
    }
  }

  // Globale Variable f√ºr Display Name und Profilbild
  let currentWindowsDisplayName = null;
  let currentProfilePicturePath = null;
  
  function updateUserDisplay() {
    const userNameEl = document.getElementById("userName");
    const userEmailEl = document.getElementById("userEmail");
    const userAvatarEl = document.getElementById("userAvatar");
    
    if (userNameEl) {
      // Verwende Display Name falls verf√ºgbar, sonst Benutzername
      const displayText = currentWindowsDisplayName || currentWindowsUser || "Nicht angemeldet";
      
      // Ersten Buchstaben f√ºr Avatar verwenden (vom Display Name oder Benutzername)
      const firstLetter = displayText && displayText.length > 0 
        ? displayText.charAt(0).toUpperCase() 
        : '?';
      
      if (userAvatarEl) {
        // Pr√ºfe ob Profilbild verf√ºgbar ist
        if (currentProfilePicturePath) {
          // Profilbild anzeigen
          userAvatarEl.innerHTML = `<img src="${currentProfilePicturePath}" 
            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
            onerror="this.parentElement.textContent='${firstLetter}'; this.parentElement.style.background='linear-gradient(135deg, var(--gxo-orange) 0%, #FF6B3D 100%)';" />`;
          userAvatarEl.style.background = 'transparent';
        } else {
          // Fallback: Ersten Buchstaben anzeigen
          userAvatarEl.textContent = firstLetter;
          userAvatarEl.style.background = 'linear-gradient(135deg, var(--gxo-orange) 0%, #FF6B3D 100%)';
        }
      }
      
      // Nur den Windows-Benutzernamen (Display-Name) anzeigen
      userNameEl.textContent = displayText;
      
      // E-Mail-Element ausblenden
      if (userEmailEl) {
        userEmailEl.style.display = "none";
      }
    }
    
    // Fallback f√ºr alte Anzeige (falls Element noch existiert)
    const display = document.getElementById("currentUserDisplay");
    if (display && !userNameEl) {
      display.textContent = `üë§ ${currentWindowsDisplayName || currentWindowsUser}`;
    }
  }
  
  // Benutzer-Men√º ein/ausblenden
  function toggleUserMenu() {
    // Kann sp√§ter erweitert werden mit einem Dropdown-Men√º
    console.log("Benutzer-Men√º geklickt");
  }
  
  window.toggleUserMenu = toggleUserMenu;

  function getCurrentWeek() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const diff = now - start + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    const week = Math.floor(diff / oneWeek) + 1;
    return week;
  }

  function setDefaultDateAndCW() {
    // Aktuelles Datum setzen
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById("aufgenommenInput");
    if (dateInput) {
      dateInput.value = today;
    }
    
    // Aktuelle CW setzen
    const currentWeek = getCurrentWeek();
    const cwInput = document.getElementById("cwInput");
    if (cwInput) {
      cwInput.value = currentWeek.toString();
    }
  }

  // Mode Switch Funktionen
  function switchToSingleMode() {
    isBulkMode = false;
    document.getElementById("btnSingleMode").classList.add("active");
    document.getElementById("btnBulkMode").classList.remove("active");
    document.getElementById("inboundDetailView").querySelector(".card").style.display = "block";
    document.getElementById("bulkModeView").style.display = "none";
  }

  function switchToBulkMode() {
    isBulkMode = true;
    document.getElementById("btnBulkMode").classList.add("active");
    document.getElementById("btnSingleMode").classList.remove("active");
    document.getElementById("inboundDetailView").querySelector(".card").style.display = "none";
    document.getElementById("bulkModeView").style.display = "block";
    
    // Bulk-Felder initialisieren
    initBulkMode();
  }

  async function initBulkMode() {
    console.log("üöÄ initBulkMode gestartet");
    
    // Dropdowns f√ºr Bulk-Modus laden
    await loadDropdownOptions();
    
    // Bulk-Felder dynamisch generieren
    renderBulkFields();
    
    // Z√§hler zur√ºcksetzen
    bulkSavedCount = 0;
    document.getElementById("bulkSavedCount").textContent = bulkSavedCount;
    document.getElementById("bulkEntryNumber").textContent = "1";
    
    // Formular ausblenden bis Defaults gesetzt sind
    document.getElementById("bulkEntryForm").style.display = "none";
    
    console.log("‚úÖ initBulkMode abgeschlossen");
  }
  
  function renderBulkFields() {
    if (!currentCarrier) {
      console.warn("‚ö†Ô∏è renderBulkFields: currentCarrier ist nicht gesetzt!");
      return;
    }
    
    console.log("üîß renderBulkFields aufgerufen f√ºr:", currentCarrier.display_name);
    
    // Feste und variable Felder aus Carrier-Konfiguration laden
    const bulkFixedFields = currentCarrier.bulk_fixed_fields ? JSON.parse(currentCarrier.bulk_fixed_fields) : ["cw", "aufgenommen_am", "area", "location_id", "land", "carrier_name"];
    const bulkVariableFields = currentCarrier.bulk_variable_fields ? JSON.parse(currentCarrier.bulk_variable_fields) : ["carrier_tracking_nr", "olpn", "planned_carton", "actual_carton", "dn", "customer_id", "asn_ra_no", "kommentar"];
    
    console.log("üìã Feste Felder:", bulkFixedFields);
    console.log("‚úèÔ∏è Variable Felder:", bulkVariableFields);
    
    // Feld-Definitionen
    const fieldDefinitions = {
      cw: { label: "CW (fest)", type: "text", placeholder: "z.B. CW 47", id: "bulkCwInput" },
      aufgenommen_am: { label: "Datum (fest)", type: "date", id: "bulkDateInput" },
      area: { label: "Area (fest)", type: "dropdown", id: "bulkAreaInput", dropdownId: "bulkAreaDropdown" },
      location_id: { label: "üìç Stellplatz (fest)", type: "location", id: "bulkLocationInput", dropdownId: "bulkLocationDropdown", required: true },
      land: { label: "Land (fest)", type: "dropdown", id: "bulkLandInput", dropdownId: "bulkLandDropdown" },
      carrier_name: { label: "Carrier Name (fest)", type: "text", id: "bulkCarrierNameInput", readonly: true },
      ship_status: { label: "Ship Status (fest)", type: "text", id: "bulkShipStatusInput" },
      ignore: { label: "Ignore (fest)", type: "select", id: "bulkIgnoreInput", options: [{value: "0", label: "Nein"}, {value: "1", label: "Ja"}] },
      carrier_tracking_nr: { label: "Carrier Tracking Number", type: "text", placeholder: "z.B. 882826466627", id: "bulkTrackingInput" },
      olpn: { label: "OLPN", type: "text", placeholder: "00050197980027746580", id: "bulkOlpnInput" },
      planned_carton: { label: "Planned Carton", type: "number", placeholder: "z.B. 2", id: "bulkPlannedInput" },
      actual_carton: { label: "Actual Carton Count", type: "number", placeholder: "z.B. 2", id: "bulkActualInput" },
      dn: { label: "DN", type: "text", placeholder: "0 falls nicht vorhanden", id: "bulkDnInput" },
      shi: { label: "SHI", type: "text", id: "bulkShiInput" },
      customer_id: { label: "Customer ID", type: "text", placeholder: "z.B. 20062673", id: "bulkCustomerIdInput" },
      customer_name: { label: "Customer Name", type: "text", placeholder: "z.B. Zalando", id: "bulkCustomerNameInput" },
      asn_ra_no: { label: "ASN RA Nummer", type: "text", placeholder: "z.B. 70378154", id: "bulkAsnInput" },
      kommentar: { label: "Kommentar", type: "text", placeholder: "Optionaler Kommentar", id: "bulkKommentarInput" }
    };
    
    // Feste Felder Container finden und leeren
    const fixedContainer = document.querySelector("#bulkModeView .card .form-grid");
    if (fixedContainer) {
      fixedContainer.innerHTML = "";
      
      // Stelle sicher, dass location_id immer in den festen Feldern ist
      if (!bulkFixedFields.includes("location_id")) {
        bulkFixedFields.push("location_id");
        console.log("‚úÖ location_id zu festen Feldern hinzugef√ºgt");
      }
      
      bulkFixedFields.forEach(fieldId => {
        const field = fieldDefinitions[fieldId];
        if (!field) {
          console.warn(`‚ö†Ô∏è Feld-Definition nicht gefunden f√ºr: ${fieldId}`);
          return;
        }
        
        const formGroup = document.createElement("div");
        formGroup.className = "form-group";
        
        const label = document.createElement("label");
        label.textContent = field.label;
        if (field.required) {
          const required = document.createElement("span");
          required.className = "required-field";
          required.textContent = " *";
          label.appendChild(required);
        }
        formGroup.appendChild(label);
        
        if (field.type === "dropdown" || field.type === "location") {
          const dropdown = document.createElement("div");
          dropdown.className = "searchable-dropdown";
          dropdown.id = field.dropdownId;
          
          const input = document.createElement("input");
          input.type = "text";
          input.id = field.id;
          input.placeholder = field.placeholder || "W√§hlen...";
          input.autocomplete = "off";
          if (field.required) input.required = true;
          
          const list = document.createElement("div");
          list.className = "searchable-dropdown-list";
          list.id = field.dropdownId + "List";
          
          dropdown.appendChild(input);
          dropdown.appendChild(list);
          formGroup.appendChild(dropdown);
        } else if (field.type === "select") {
          const select = document.createElement("select");
          select.id = field.id;
          field.options.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });
          formGroup.appendChild(select);
        } else {
          const input = document.createElement("input");
          input.type = field.type;
          input.id = field.id;
          if (field.placeholder) input.placeholder = field.placeholder;
          if (field.readonly) input.readOnly = true;
          if (field.required) input.required = true;
          if (field.type === "date") input.lang = "de-DE";
          formGroup.appendChild(input);
        }
        
        fixedContainer.appendChild(formGroup);
      });
      
      // Dropdowns initialisieren
      if (bulkFixedFields.includes("area")) {
        setTimeout(() => {
          const input = document.getElementById('bulkAreaInput');
          if (input) {
            initSearchableDropdown('bulkArea', areaOptions);
          }
        }, 200);
      }
      if (bulkFixedFields.includes("land")) {
        setTimeout(() => {
          const input = document.getElementById('bulkLandInput');
          if (input) {
            initSearchableDropdown('bulkLand', landOptions);
          }
        }, 200);
      }
      if (bulkFixedFields.includes("location_id")) {
        setTimeout(() => {
          const input = document.getElementById('bulkLocationInput');
          const list = document.getElementById('bulkLocationDropdownList');
          if (input && list) {
            console.log("‚úÖ Initialisiere Stellplatz-Dropdown f√ºr Bulk-Modus");
            initLocationDropdown('bulkLocation');
          } else {
            console.warn("‚ö†Ô∏è Stellplatz-Elemente nicht gefunden:", { input: !!input, list: !!list });
          }
        }, 200);
      }
      
      // Defaults setzen
      if (bulkFixedFields.includes("carrier_name") && currentCarrier) {
        document.getElementById("bulkCarrierNameInput").value = currentCarrier.display_name || currentCarrier.name;
      }
      if (bulkFixedFields.includes("aufgenommen_am")) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("bulkDateInput").value = today;
      }
      if (bulkFixedFields.includes("cw")) {
        const currentWeek = getWeekNumber(new Date());
        document.getElementById("bulkCwInput").value = `CW ${currentWeek}`;
      }
    }
    
    // Variable Felder Container finden und leeren
    const variableContainer = document.querySelector("#bulkEntryForm .form-grid");
    if (variableContainer) {
      console.log("üì¶ Variable Felder Container gefunden, rendere Felder...");
      variableContainer.innerHTML = "";
      
      bulkVariableFields.forEach(fieldId => {
        const field = fieldDefinitions[fieldId];
        if (!field) {
          console.warn(`‚ö†Ô∏è Feld-Definition nicht gefunden f√ºr: ${fieldId}`);
          return;
        }
        
        const formGroup = document.createElement("div");
        formGroup.className = "form-group";
        
        const label = document.createElement("label");
        label.textContent = field.label;
        formGroup.appendChild(label);
        
        const input = document.createElement("input");
        input.type = field.type;
        input.id = field.id;
        if (field.placeholder) input.placeholder = field.placeholder;
        formGroup.appendChild(input);
        
        variableContainer.appendChild(formGroup);
      });
      
      console.log(`‚úÖ ${bulkVariableFields.length} variable Felder gerendert`);
    } else {
      console.error("‚ùå Variable Felder Container (#bulkEntryForm .form-grid) nicht gefunden!");
    }
  }

  // Globale Variable f√ºr Bulk-Tabellen-Daten
  let bulkTableData = [];
  let bulkTableNextRowId = 0;
  
  function showBulkTable() {
    console.log("üîß showBulkTable aufgerufen");
    
    if (!currentCarrier) {
      console.error("‚ùå currentCarrier ist nicht gesetzt!");
      return;
    }
    
    // Feste Felder aus Konfiguration laden
    const bulkFixedFields = currentCarrier.bulk_fixed_fields ? JSON.parse(currentCarrier.bulk_fixed_fields) : [];
    console.log("üìã Feste Felder:", bulkFixedFields);
    
    // Feste Felder sammeln
    bulkDefaults = {};
    let hasError = false;
    
    bulkFixedFields.forEach(fieldId => {
      // Spezielle Mapping f√ºr Feld-IDs
      const fieldIdMap = {
        'aufgenommen_am': 'bulkDateInput',
        'location_id': 'bulkLocationInput'
      };
      
      let inputId = fieldIdMap[fieldId];
      if (!inputId) {
        inputId = `bulk${fieldId.charAt(0).toUpperCase() + fieldId.slice(1).replace(/_/g, '')}Input`;
      }
      
      const element = document.getElementById(inputId);
      
      if (element) {
        // F√ºr location_id die ID als Integer speichern
        if (fieldId === 'location_id') {
          const locationIdAttr = element.getAttribute('data-value');
          if (locationIdAttr) {
            bulkDefaults[fieldId] = parseInt(locationIdAttr, 10);
          } else {
            bulkDefaults[fieldId] = null;
            showCustomModal("‚ùå Stellplatz ist ein Pflichtfeld! Bitte w√§hlen Sie einen Stellplatz aus.", "error");
            element.focus();
            hasError = true;
          }
        } else {
        const value = element.getAttribute('data-value') || element.value;
        bulkDefaults[fieldId] = value;
        }
      } else {
        console.warn(`‚ö†Ô∏è Element nicht gefunden f√ºr Feld ${fieldId} (ID: ${inputId})`);
      }
    });
    
    // Stellplatz ist immer Pflichtfeld, auch wenn nicht in bulkFixedFields
    if (!hasError && !bulkFixedFields.includes('location_id')) {
      const locationInput = document.getElementById("bulkLocationInput");
      if (locationInput) {
        const locationIdAttr = locationInput.getAttribute('data-value');
        if (locationIdAttr) {
          bulkDefaults['location_id'] = parseInt(locationIdAttr, 10);
          
          // Area aus Stellplatz √ºbernehmen, wenn nicht in festen Feldern
          const locationArea = locationInput.getAttribute('data-area');
          if (locationArea && !bulkFixedFields.includes('area')) {
            bulkDefaults['area'] = locationArea;
            const bulkAreaInput = document.getElementById('bulkAreaInput');
            if (bulkAreaInput) {
              bulkAreaInput.value = locationArea;
              bulkAreaInput.setAttribute('data-value', locationArea);
              console.log(`‚úÖ Area aus Stellplatz √ºbernommen: ${locationArea}`);
            }
          }
        } else {
          showCustomModal("‚ùå Stellplatz ist ein Pflichtfeld! Bitte w√§hlen Sie einen Stellplatz aus.", "error");
          locationInput.focus();
          hasError = true;
        }
      }
    }
    
    // Area aus Stellplatz √ºbernehmen, wenn Stellplatz bereits ausgew√§hlt wurde
    if (!hasError && bulkDefaults.location_id) {
      const locationInput = document.getElementById("bulkLocationInput");
      if (locationInput) {
        const locationArea = locationInput.getAttribute('data-area');
        if (locationArea && (!bulkDefaults.area || bulkDefaults.area === '')) {
          bulkDefaults['area'] = locationArea;
          const bulkAreaInput = document.getElementById('bulkAreaInput');
          if (bulkAreaInput) {
            bulkAreaInput.value = locationArea;
            bulkAreaInput.setAttribute('data-value', locationArea);
            console.log(`‚úÖ Area aus Stellplatz √ºbernommen (nachtr√§glich): ${locationArea}`);
          }
        }
      }
    }
    
    if (hasError) return;
    
    // Stelle sicher, dass carrier_name immer in bulkDefaults ist
    if (!bulkDefaults.carrier_name && !bulkDefaults.carrierName) {
      if (currentCarrier) {
        bulkDefaults.carrier_name = currentCarrier.display_name || currentCarrier.name;
        console.log("‚úÖ Carrier Name zu bulkDefaults hinzugef√ºgt:", bulkDefaults.carrier_name);
      }
    }
    
    // Tabellen-Ansicht anzeigen
    const bulkTableView = document.getElementById("bulkTableView");
    bulkTableView.style.display = "block";
    console.log("‚úÖ bulkTableView angezeigt");
    console.log("üìã bulkDefaults:", bulkDefaults);
    
    // Tabelle initialisieren
    initBulkTable();
  }
  
  function initBulkTable() {
    console.log("üîß initBulkTable aufgerufen");
    
    // Pr√ºfen ob Tabelle bereits initialisiert wurde
    const tbody = document.getElementById("bulkTableBody");
    if (tbody && tbody.children.length > 0) {
      console.log("‚ö†Ô∏è Tabelle bereits initialisiert, √ºberspringe...");
      return;
    }
    
    // Variable Felder aus Carrier-Konfiguration laden
    const bulkVariableFields = currentCarrier.bulk_variable_fields ? 
      JSON.parse(currentCarrier.bulk_variable_fields) : 
      ["carrier_tracking_nr", "olpn", "planned_carton", "actual_carton", "dn", "customer_id", "asn_ra_no", "kommentar"];
    
    console.log("‚úèÔ∏è Variable Felder f√ºr Tabelle:", bulkVariableFields);
    
    // Feld-Definitionen
    const fieldDefinitions = {
      carrier_tracking_nr: { label: "Tracking Nr.", type: "text", placeholder: "882826466627", width: "150px" },
      olpn: { label: "OLPN", type: "text", placeholder: "00050197980027746580", width: "180px" },
      planned_carton: { label: "Planned", type: "number", placeholder: "2", width: "80px" },
      actual_carton: { label: "Actual", type: "number", placeholder: "2", width: "80px" },
      dn: { label: "DN", type: "text", placeholder: "0", width: "100px" },
      shi: { label: "SHI", type: "text", placeholder: "", width: "100px" },
      customer_id: { label: "Customer ID", type: "text", placeholder: "20062673", width: "120px" },
      customer_name: { label: "Customer Name", type: "text", placeholder: "Zalando", width: "150px" },
      asn_ra_no: { label: "ASN/RA Nr.", type: "text", placeholder: "70378154", width: "120px" },
      kommentar: { label: "Kommentar", type: "text", placeholder: "Optional", width: "200px" }
    };
    
    // Tabellen-Header erstellen
    const headerRow = document.getElementById("bulkTableHeader");
    headerRow.innerHTML = '<th style="padding: 10px; text-align: left; font-weight: 600; min-width: 40px; position: sticky; left: 0; background: var(--bg-soft); z-index: 1;">#</th>';
    
    bulkVariableFields.forEach(fieldId => {
      const field = fieldDefinitions[fieldId];
      if (!field) return;
      
      const th = document.createElement("th");
      th.style.padding = "10px";
      th.style.textAlign = "left";
      th.style.fontWeight = "600";
      th.style.minWidth = field.width || "120px";
      th.style.whiteSpace = "nowrap";
      th.textContent = field.label;
      headerRow.appendChild(th);
    });
    
    // Aktionen-Spalte
    const actionTh = document.createElement("th");
    actionTh.style.padding = "10px";
    actionTh.style.textAlign = "center";
    actionTh.style.fontWeight = "600";
    actionTh.style.width = "80px";
    actionTh.style.position = "sticky";
    actionTh.style.right = "0";
    actionTh.style.background = "var(--bg-soft)";
    actionTh.style.zIndex = "1";
    actionTh.textContent = "Aktionen";
    headerRow.appendChild(actionTh);
    
    // Tabellen-Daten zur√ºcksetzen
    bulkTableData = [];
    bulkTableNextRowId = 0;
    
    // 5 leere Zeilen hinzuf√ºgen
    for (let i = 0; i < 5; i++) {
      addBulkTableRow();
    }
    
    console.log("‚úÖ Tabelle initialisiert mit 5 Zeilen");
  }
  
  function addBulkTableRow() {
    const bulkVariableFields = currentCarrier.bulk_variable_fields ? 
      JSON.parse(currentCarrier.bulk_variable_fields) : 
      ["carrier_tracking_nr", "olpn", "planned_carton", "actual_carton", "dn", "customer_id", "asn_ra_no", "kommentar"];
    
    const fieldDefinitions = {
      carrier_tracking_nr: { label: "Tracking Nr.", type: "text", placeholder: "882826466627" },
      olpn: { label: "OLPN", type: "text", placeholder: "00050197980027746580" },
      planned_carton: { label: "Planned", type: "number", placeholder: "2" },
      actual_carton: { label: "Actual", type: "number", placeholder: "2" },
      dn: { label: "DN", type: "text", placeholder: "0" },
      shi: { label: "SHI", type: "text", placeholder: "" },
      customer_id: { label: "Customer ID", type: "text", placeholder: "20062673" },
      customer_name: { label: "Customer Name", type: "text", placeholder: "Zalando" },
      asn_ra_no: { label: "ASN/RA Nr.", type: "text", placeholder: "70378154" },
      kommentar: { label: "Kommentar", type: "text", placeholder: "Optional" }
    };
    
    const tbody = document.getElementById("bulkTableBody");
    const rowIndex = bulkTableNextRowId++;
    
    // Neue Zeile erstellen
    const tr = document.createElement("tr");
    tr.id = `bulkRow_${rowIndex}`;
    tr.style.borderBottom = "1px solid var(--border-soft)";
    tr.dataset.rowIndex = rowIndex;
    
    // Hover-Effekt
    tr.addEventListener("mouseenter", () => {
      tr.style.background = "var(--bg-soft)";
    });
    tr.addEventListener("mouseleave", () => {
      tr.style.background = "";
    });
    
    // Zeilen-Nummer (visuell, nicht die rowIndex)
    const tdNum = document.createElement("td");
    tdNum.style.padding = "8px 10px";
    tdNum.style.fontWeight = "600";
    tdNum.style.color = "var(--text-muted)";
    tdNum.style.position = "sticky";
    tdNum.style.left = "0";
    tdNum.style.background = "inherit";
    tdNum.style.zIndex = "1";
    tdNum.className = "row-number";
    tr.appendChild(tdNum);
    
    // Daten-Objekt f√ºr diese Zeile
    const rowData = {};
    
    // Felder erstellen
    bulkVariableFields.forEach(fieldId => {
      const field = fieldDefinitions[fieldId];
      if (!field) return;
      
      const td = document.createElement("td");
      td.style.padding = "4px";
      
      const input = document.createElement("input");
      input.type = field.type;
      input.placeholder = field.placeholder;
      input.style.width = "100%";
      input.style.padding = "6px 8px";
      input.style.border = "1px solid var(--border-soft)";
      input.style.borderRadius = "4px";
      input.style.background = "var(--bg-main)";
      input.style.color = "var(--text-main)";
      input.style.fontSize = "13px";
      input.dataset.fieldId = fieldId;
      input.dataset.rowIndex = rowIndex;
      
      // Enter-Taste springt zur n√§chsten Zelle
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const nextInput = findNextInput(input);
          if (nextInput) {
            nextInput.focus();
            nextInput.select();
          }
        }
      });
      
      // Wert speichern bei √Ñnderung
      input.addEventListener("input", () => {
        rowData[fieldId] = input.value;
      });
      
      td.appendChild(input);
      tr.appendChild(td);
      
      rowData[fieldId] = "";
    });
    
    // Aktionen-Spalte
    const tdActions = document.createElement("td");
    tdActions.style.padding = "4px";
    tdActions.style.textAlign = "center";
    tdActions.style.position = "sticky";
    tdActions.style.right = "0";
    tdActions.style.background = "inherit";
    tdActions.style.zIndex = "1";
    
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "btn btn-ghost btn-sm";
    deleteBtn.innerHTML = "üóëÔ∏è";
    deleteBtn.style.padding = "4px 8px";
    deleteBtn.style.fontSize = "14px";
    deleteBtn.title = "Zeile l√∂schen";
    deleteBtn.onclick = () => deleteBulkTableRow(rowIndex);
    
    tdActions.appendChild(deleteBtn);
    tr.appendChild(tdActions);
    
    tbody.appendChild(tr);
    
    // In bulkTableData an der richtigen Position speichern
    bulkTableData[rowIndex] = rowData;
    
    updateBulkRowNumbers();
    updateBulkRowCount();
  }
  
  function updateBulkRowNumbers() {
    const tbody = document.getElementById("bulkTableBody");
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll("tr");
    rows.forEach((row, index) => {
      const numberCell = row.querySelector(".row-number");
      if (numberCell) {
        numberCell.textContent = index + 1;
      }
    });
  }
  
  function findNextInput(currentInput) {
    const allInputs = Array.from(document.querySelectorAll("#bulkTableBody input"));
    const currentIndex = allInputs.indexOf(currentInput);
    return allInputs[currentIndex + 1] || allInputs[0];
  }
  
  function deleteBulkTableRow(rowIndex) {
    const row = document.getElementById(`bulkRow_${rowIndex}`);
    if (row) {
      row.remove();
      bulkTableData[rowIndex] = null; // Markieren als gel√∂scht
      updateBulkRowNumbers();
      updateBulkRowCount();
    }
  }
  
  function clearBulkTable() {
    if (!confirm("M√∂chten Sie wirklich alle Zeilen l√∂schen?")) return;
    
    document.getElementById("bulkTableBody").innerHTML = "";
    bulkTableData = [];
    bulkTableNextRowId = 0;
    
    // 5 neue leere Zeilen hinzuf√ºgen
    for (let i = 0; i < 5; i++) {
      addBulkTableRow();
    }
    
    updateBulkRowCount();
    showCustomModal("‚úì Tabelle wurde geleert", "success");
  }
  
  function updateBulkRowCount() {
    const activeRows = bulkTableData.filter(row => row !== null).length;
    document.getElementById("bulkRowCount").textContent = activeRows;
  }
  
  async function saveBulkTable() {
    console.log("üíæ saveBulkTable aufgerufen");
    
    // Stellplatz-ID pr√ºfen - aus bulkDefaults oder direkt aus dem Input-Feld
    let locationId = bulkDefaults?.location_id || null;
    
    // Fallback: Wenn nicht in bulkDefaults, direkt aus dem Input-Feld lesen
    if (!locationId) {
      const locationInput = document.getElementById("bulkLocationInput");
      if (locationInput) {
        const locationIdAttr = locationInput.getAttribute('data-value');
        if (locationIdAttr) {
          locationId = parseInt(locationIdAttr, 10);
        }
      }
    }
    
    if (!locationId) {
      showCustomModal("‚ùå Bitte w√§hlen Sie einen Stellplatz in den festen Feldern!", "error");
      const locationInput = document.getElementById("bulkLocationInput");
      if (locationInput) {
        locationInput.focus();
      }
      return;
    }
    
    // Alle Zeilen mit Daten sammeln
    const rowsToSave = [];
    
    bulkTableData.forEach((rowData, index) => {
      if (rowData === null) return; // Gel√∂schte Zeile
      
      // Pr√ºfen ob Zeile Daten enth√§lt
      const hasData = Object.values(rowData).some(val => val && val.toString().trim() !== "");
      if (!hasData) return;
      
      rowsToSave.push({ index, data: rowData });
    });
    
    if (rowsToSave.length === 0) {
      showCustomModal("‚ùå Keine Daten zum Speichern vorhanden!", "error");
      return;
    }
    
    console.log(`üì¶ ${rowsToSave.length} Zeilen zum Speichern gefunden`);
    
    // Best√§tigung
    if (!confirm(`M√∂chten Sie ${rowsToSave.length} Eintr√§ge speichern?`)) return;
    
    let successCount = 0;
    let errorCount = 0;
    
    // Stellplatz-ID wurde bereits oben gepr√ºft und gesetzt
    
    for (const row of rowsToSave) {
      try {
        // Carrier Name pr√ºfen - Fallback auf currentCarrier
        let carrierName = bulkDefaults.carrier_name || bulkDefaults.carrierName;
        if (!carrierName && currentCarrier) {
          carrierName = currentCarrier.display_name || currentCarrier.name;
        }
        
        if (!carrierName || carrierName.trim() === "") {
          console.error(`‚ùå Carrier Name fehlt f√ºr Zeile ${row.index + 1}`);
          errorCount++;
          const rowElement = document.getElementById(`bulkRow_${row.index}`);
          if (rowElement) {
            rowElement.style.background = "rgba(255, 0, 0, 0.1)";
            rowElement.title = "Fehler: Carrier Name fehlt";
          }
          continue; // N√§chste Zeile
        }
        
        // Zahlenfelder konvertieren
        let plannedCarton = null;
        let actualCarton = null;
        
        if (row.data.planned_carton && row.data.planned_carton.toString().trim() !== "") {
          plannedCarton = parseInt(row.data.planned_carton, 10);
          if (isNaN(plannedCarton)) plannedCarton = null;
        }
        
        if (row.data.actual_carton && row.data.actual_carton.toString().trim() !== "") {
          actualCarton = parseInt(row.data.actual_carton, 10);
          if (isNaN(actualCarton)) actualCarton = null;
        }
        
        // Vollst√§ndiges Datenobjekt erstellen (Format f√ºr /api/inbound-simple)
        const entryData = {
          cw: bulkDefaults.cw || null,
          aufgenommenAm: bulkDefaults.aufgenommen_am || bulkDefaults.aufgenommenAm || null,
          ignoreFlag: bulkDefaults.ignore === "1" || bulkDefaults.ignore === 1 || bulkDefaults.ignore === true,
          area: bulkDefaults.area || null,
          carrierName: carrierName,
          land: bulkDefaults.land || null,
          shipStatus: bulkDefaults.ship_status || bulkDefaults.shipStatus || null,
          plannedCarton: plannedCarton,
          actualCarton: actualCarton,
          olpn: (row.data.olpn && row.data.olpn.toString().trim()) || null,
          dn: (row.data.dn && row.data.dn.toString().trim()) || null,
          shi: (row.data.shi && row.data.shi.toString().trim()) || null,
          carrierTrackingNr: (row.data.carrier_tracking_nr && row.data.carrier_tracking_nr.toString().trim()) || null,
          customerId: (row.data.customer_id && row.data.customer_id.toString().trim()) || null,
          customerName: (row.data.customer_name && row.data.customer_name.toString().trim()) || null,
          asnRaNo: (row.data.asn_ra_no && row.data.asn_ra_no.toString().trim()) || null,
          kommentar: (row.data.kommentar && row.data.kommentar.toString().trim()) || null,
          addedBy: currentWindowsUser || "System",
          locationId: locationId
        };
        
        console.log(`üíæ Speichere Zeile ${row.index + 1}:`, entryData);
        
        // An Server senden
        const response = await fetch('/api/inbound-simple', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entryData)
        });
        
        if (response.ok) {
          successCount++;
          // Zeile gr√ºn markieren
          const rowElement = document.getElementById(`bulkRow_${row.index}`);
          if (rowElement) {
            rowElement.style.background = "rgba(0, 255, 0, 0.1)";
          }
        } else {
          errorCount++;
          // Fehler-Details lesen
          let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              const errData = await response.json();
              errorMsg = errData.error || errData.message || errorMsg;
            } else {
              const text = await response.text();
              console.error("‚ùå Server antwortete mit HTML statt JSON:", text.substring(0, 200));
              errorMsg = `Server-Fehler (${response.status}). Bitte Server-Logs pr√ºfen.`;
            }
          } catch (e) {
            console.error("‚ùå Fehler beim Lesen der Fehlerantwort:", e);
            errorMsg = `Fehler beim Verarbeiten der Server-Antwort (${response.status})`;
          }
          console.error(`‚ùå Fehler beim Speichern Zeile ${row.index + 1}:`, errorMsg);
          
          // Zeile rot markieren
          const rowElement = document.getElementById(`bulkRow_${row.index}`);
          if (rowElement) {
            rowElement.style.background = "rgba(255, 0, 0, 0.1)";
            rowElement.title = `Fehler: ${errorMsg}`;
          }
        }
      } catch (err) {
        console.error(`‚ùå Fehler beim Speichern Zeile ${row.index + 1}:`, err);
        errorCount++;
        
        // Zeile rot markieren
        const rowElement = document.getElementById(`bulkRow_${row.index}`);
        if (rowElement) {
          rowElement.style.background = "rgba(255, 0, 0, 0.1)";
          rowElement.title = `Fehler: ${err.message}`;
        }
      }
    }
    
    // Ergebnis anzeigen
    if (errorCount === 0) {
      showCustomModal(`‚úÖ Alle ${successCount} Eintr√§ge erfolgreich gespeichert!`, "success");
      
      // Lagerbestand aktualisieren, wenn wir auf der Lagerbestand-Seite sind
      if (document.getElementById("view-inventory")?.style.display !== "none") {
        await loadWarehouse();
      }
      
      // Tabelle leeren und neu initialisieren
      setTimeout(() => {
        clearBulkTable();
      }, 1500);
    } else {
      showCustomModal(`‚ö†Ô∏è ${successCount} Eintr√§ge gespeichert, ${errorCount} Fehler`, "warning");
    }
  }

  async function saveBulkEntry() {
    if (!bulkDefaults.stage) {
      showCustomModal("‚ùå Bitte zuerst die festen Felder definieren!", "error");
      return;
    }
    
    // Variable Felder auslesen
    const trackingValue = document.getElementById("bulkTrackingInput").value.trim();
    const olpnValue = document.getElementById("bulkOlpnInput").value.trim();
    
    // Carrier-spezifische Validierung
    if (currentCarrier) {
      // OLPN Validierung
      if (currentCarrier.olpn_validation) {
        const olpnVal = JSON.parse(currentCarrier.olpn_validation);
        if (olpnVal.enabled && olpnVal.required && !olpnValue) {
          showCustomModal("‚ùå OLPN ist ein Pflichtfeld f√ºr " + currentCarrier.display_name, "error");
          document.getElementById("bulkOlpnInput").focus();
          return;
        }
        if (olpnVal.enabled && olpnValue && olpnVal.length && olpnValue.length !== parseInt(olpnVal.length)) {
          const msg = olpnVal.error_message || `OLPN muss genau ${olpnVal.length} Zeichen lang sein`;
          showCustomModal("‚ùå " + msg, "error");
          document.getElementById("bulkOlpnInput").focus();
          return;
        }
        if (olpnVal.enabled && olpnValue && olpnVal.regex) {
          const regex = new RegExp(olpnVal.regex);
          if (!regex.test(olpnValue)) {
            const msg = olpnVal.error_message || "OLPN entspricht nicht dem erwarteten Format";
            showCustomModal("‚ùå " + msg, "error");
            document.getElementById("bulkOlpnInput").focus();
            return;
          }
        }
      }
      
      // Tracking Number Validierung
      if (currentCarrier.tracking_validation) {
        const trackVal = JSON.parse(currentCarrier.tracking_validation);
        if (trackVal.enabled && trackVal.required && !trackingValue) {
          showCustomModal("‚ùå Carrier Tracking Number ist ein Pflichtfeld f√ºr " + currentCarrier.display_name, "error");
          document.getElementById("bulkTrackingInput").focus();
          return;
        }
        if (trackVal.enabled && trackingValue && trackVal.length && trackingValue.length !== parseInt(trackVal.length)) {
          const msg = trackVal.error_message || `Carrier Tracking Number muss genau ${trackVal.length} Zeichen lang sein`;
          showCustomModal("‚ùå " + msg, "error");
          document.getElementById("bulkTrackingInput").focus();
          return;
        }
        if (trackVal.enabled && trackingValue && trackVal.regex) {
          const regex = new RegExp(trackVal.regex);
          if (!regex.test(trackingValue)) {
            const msg = trackVal.error_message || "Carrier Tracking Number entspricht nicht dem erwarteten Format";
            showCustomModal("‚ùå " + msg, "error");
            document.getElementById("bulkTrackingInput").focus();
            return;
          }
        }
      }
    }
    
    // Payload zusammenstellen (feste + variable Felder)
    const payload = {
      cw: bulkDefaults.cw,
      aufgenommen_am: bulkDefaults.date,
      area: bulkDefaults.area,
      land: bulkDefaults.land,
      stage: bulkDefaults.stage,
      carrier_name: bulkDefaults.carrier_name,
      carrier_tracking_nr: trackingValue,
      olpn: olpnValue,
      planned_carton: document.getElementById("bulkPlannedInput").value,
      actual_carton_count: document.getElementById("bulkActualInput").value,
      dn: document.getElementById("bulkDnInput").value,
      customer_id: document.getElementById("bulkCustomerIdInput").value,
      asn_ra_nummer: document.getElementById("bulkAsnInput").value,
      kommentar: document.getElementById("bulkKommentarInput").value,
      added_by: document.getElementById("addedByInput").value,
      ignore: 0,
      last_stage: "",
      ship_status: "",
      shi: "",
      customer_name: ""
    };
    
    try {
      const response = await fetch("/api/inbound-simple", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        bulkSavedCount++;
        document.getElementById("bulkSavedCount").textContent = bulkSavedCount;
        document.getElementById("bulkEntryNumber").textContent = (bulkSavedCount + 1);
        
        // Variable Felder leeren
        clearBulkEntry();
        
        // Fokus auf erstes Feld
        document.getElementById("bulkTrackingInput").focus();
        
        showCustomModal(`‚úì Eintrag #${bulkSavedCount} erfolgreich gespeichert!`, "success");
      } else {
        const error = await response.text();
        showCustomModal("‚ùå Fehler beim Speichern: " + error, "error");
      }
    } catch (err) {
      console.error("Fehler beim Speichern:", err);
      showCustomModal("‚ùå Fehler beim Speichern: " + err.message, "error");
    }
  }

  function clearBulkEntry() {
    document.getElementById("bulkTrackingInput").value = "";
    document.getElementById("bulkOlpnInput").value = "";
    document.getElementById("bulkPlannedInput").value = "";
    document.getElementById("bulkActualInput").value = "";
    document.getElementById("bulkDnInput").value = "";
    document.getElementById("bulkCustomerIdInput").value = "";
    document.getElementById("bulkAsnInput").value = "";
    document.getElementById("bulkKommentarInput").value = "";
  }

  async function finishBulkMode() {
    if (bulkSavedCount === 0) {
      const confirmed = await showCustomConfirm("Sie haben noch keine Eintr√§ge gespeichert. M√∂chten Sie wirklich beenden?");
      if (!confirmed) return;
    }
    
    showCustomModal(`‚úì Massenerfassung abgeschlossen! ${bulkSavedCount} Eintr√§ge wurden gespeichert.`, "success");
    
    // Zur√ºck zur Einzelerfassung
    switchToSingleMode();
    
    // Liste neu laden
    await loadInboundList();
    
    // Bulk-Variablen zur√ºcksetzen
    bulkDefaults = {};
    bulkSavedCount = 0;
  }

  function clearInboundForm() {
    const ids = [
      "cwInput","aufgenommenInput","ignoreInput","areaInput","stageInput","lastStageInput",
      "carrierNameInput","landInput","shipStatusInput","plannedCartonInput","actualCartonInput",
      "olpnInput","dnInput","shiInput","carrierTrackingInput","customerIdInput","customerNameInput",
      "asnInput","kommentarInput","addedByInput"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === "SELECT") {
        el.selectedIndex = 0;
      } else {
        el.value = "";
      }
    });
    
    // CW und Datum wieder setzen
    setDefaultDateAndCW();
  }

  async function saveInboundSimple() {
    // Validierung
    const carrierName = document.getElementById("carrierNameInput")?.value || null;
    if (!carrierName || carrierName.trim() === "") {
      alert("Bitte w√§hlen Sie zuerst einen Carrier aus!");
      return;
    }

    // Stellplatz ist Pflichtfeld
    const locationInputCheck = document.getElementById("locationInput");
    const locationIdCheck = locationInputCheck?.getAttribute('data-value');
    if (!locationIdCheck) {
      showCustomModal("‚ùå Bitte w√§hlen Sie einen Stellplatz aus!", "error");
      locationInputCheck?.focus();
      return;
    }

    // Carrier-spezifische Validierung
    if (currentCarrier) {
      const olpnValue = document.getElementById("olpnInput")?.value?.trim();
      const trackingValue = document.getElementById("carrierTrackingInput")?.value?.trim();
      
      // OLPN Validierung
      if (currentCarrier.olpn_validation) {
        const olpnVal = JSON.parse(currentCarrier.olpn_validation);
        if (olpnVal.enabled) {
          if (olpnVal.required && !olpnValue) {
            alert("‚ùå OLPN ist ein Pflichtfeld f√ºr " + currentCarrier.display_name);
            document.getElementById("olpnInput")?.focus();
            return;
          }
          
          if (olpnValue && olpnVal.length && olpnValue.length !== olpnVal.length) {
            alert("‚ùå " + (olpnVal.errorMessage || `OLPN muss genau ${olpnVal.length} Stellen lang sein`));
            document.getElementById("olpnInput")?.focus();
            return;
          }
          
          if (olpnValue && olpnVal.startsWith && olpnVal.startsWith.length > 0) {
            const startsCorrect = olpnVal.startsWith.some(prefix => olpnValue.startsWith(prefix));
            if (!startsCorrect) {
              alert("‚ùå " + (olpnVal.errorMessage || `OLPN muss mit ${olpnVal.startsWith.join(" oder ")} beginnen`));
              document.getElementById("olpnInput")?.focus();
              return;
            }
          }
        }
      }
      
      // Tracking Number Validierung
      if (currentCarrier.tracking_validation) {
        const trackingVal = JSON.parse(currentCarrier.tracking_validation);
        if (trackingVal.enabled) {
          if (trackingVal.required && !trackingValue) {
            alert("‚ùå Carrier Tracking Number ist ein Pflichtfeld f√ºr " + currentCarrier.display_name);
            document.getElementById("carrierTrackingInput")?.focus();
            return;
          }
          
          if (trackingValue && trackingVal.length && trackingValue.length !== trackingVal.length) {
            alert("‚ùå " + (trackingVal.errorMessage || `Tracking Number muss genau ${trackingVal.length} Stellen lang sein`));
            document.getElementById("carrierTrackingInput")?.focus();
            return;
          }
          
          if (trackingValue && trackingVal.startsWith && trackingVal.startsWith.length > 0) {
            const startsCorrect = trackingVal.startsWith.some(prefix => trackingValue.startsWith(prefix));
            if (!startsCorrect) {
              alert("‚ùå " + (trackingVal.errorMessage || `Tracking Number muss mit ${trackingVal.startsWith.join(" oder ")} beginnen`));
              document.getElementById("carrierTrackingInput")?.focus();
              return;
            }
          }
        }
      }
    }

    const areaInput = document.getElementById("areaInput");
    const landInput = document.getElementById("landInput");
    const locationInput = document.getElementById("locationInput");
    
    // Stellplatz-ID auslesen
    let locationId = null;
    if (locationInput) {
      const locationIdAttr = locationInput.getAttribute('data-value');
      if (locationIdAttr) {
        locationId = parseInt(locationIdAttr, 10);
      }
    }
    
    const payload = {
      cw: document.getElementById("cwInput")?.value?.trim() || null,
      aufgenommenAm: document.getElementById("aufgenommenInput")?.value || null,
      ignoreFlag: document.getElementById("ignoreInput")?.value === "1",
      area: areaInput?.getAttribute('data-value') || areaInput?.value?.trim() || null,
      carrierName: carrierName ? carrierName.trim() : null,
      land: landInput?.getAttribute('data-value') || landInput?.value?.trim() || null,
      shipStatus: document.getElementById("shipStatusInput")?.value?.trim() || null,
      plannedCarton: document.getElementById("plannedCartonInput")?.value || null,
      actualCarton: document.getElementById("actualCartonInput")?.value || null,
      olpn: document.getElementById("olpnInput")?.value?.trim() || null,
      dn: document.getElementById("dnInput")?.value?.trim() || null,
      shi: document.getElementById("shiInput")?.value?.trim() || null,
      carrierTrackingNr: document.getElementById("carrierTrackingInput")?.value?.trim() || null,
      customerId: document.getElementById("customerIdInput")?.value?.trim() || null,
      customerName: document.getElementById("customerNameInput")?.value?.trim() || null,
      asnRaNo: document.getElementById("asnInput")?.value?.trim() || null,
      neueRa: document.getElementById("neueRaInput")?.value?.trim() || null,
      newReOpenRa: document.getElementById("newReOpenInput")?.value?.trim() || null,
      mhStatus: document.getElementById("mhStatusInput")?.value?.trim() || null,
      kommentar: document.getElementById("kommentarInput")?.value?.trim() || null,
      addedBy: document.getElementById("addedByInput")?.value?.trim() || null,
      locationId: locationId
    };

    console.log("Payload wird gesendet:", payload);

    try {
      const response = await fetch("/api/inbound-simple", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        try {
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            const err = await response.json();
            errorMessage = err.error || err.message || errorMessage;
          } else {
            // HTML-Antwort (z.B. Express-Fehlerseite)
            const text = await response.text();
            console.error("‚ùå Server antwortete mit HTML statt JSON:", text.substring(0, 200));
            errorMessage = `Server-Fehler (${response.status}). Bitte Server-Logs pr√ºfen.`;
          }
        } catch (parseErr) {
          console.error("‚ùå Fehler beim Parsen der Fehlerantwort:", parseErr);
          errorMessage = `Fehler beim Verarbeiten der Server-Antwort (${response.status})`;
        }
        throw new Error(errorMessage);
      }

      const result = await response.json();
      showCustomModal("‚úì Wareneingang erfolgreich gespeichert!\nID: " + result.id, "success");
      clearInboundForm();
      backToCarrierSelection();
      loadInboundList();
      
      // Lagerbestand aktualisieren, wenn wir auf der Lagerbestand-Seite sind
      if (document.getElementById("view-inventory")?.style.display !== "none") {
        await loadWarehouse();
      }
    } catch (err) {
      console.error("Fehler beim Speichern:", err);
      alert("‚ùå Fehler beim Speichern:\n" + err.message);
    }
  }

  async function loadInboundList() {
    const body = document.getElementById("inboundListBody");
    const dashboardBody = document.getElementById("dashboardInboundListBody");
    
    // Beide Tabellen aktualisieren (falls vorhanden)
    if (body) {
      body.innerHTML = '<tr><td colspan="12" class="muted">Eintr√§ge werden geladen</td></tr>';
    }
    if (dashboardBody) {
      dashboardBody.innerHTML = '<tr><td colspan="12" class="muted">Eintr√§ge werden geladen</td></tr>';
    }

    try {
      const response = await fetch("/api/inbound-simple");
      if (!response.ok) {
        throw new Error("Code " + response.status);
      }
      const data = await response.json();
      
      if (body) body.innerHTML = "";
      if (dashboardBody) dashboardBody.innerHTML = "";

      if (!data || data.length === 0) {
        if (body) body.innerHTML = '<tr><td colspan="12" class="muted">Noch keine Eintr√§ge vorhanden</td></tr>';
        if (dashboardBody) dashboardBody.innerHTML = '<tr><td colspan="12" class="muted">Noch keine Eintr√§ge vorhanden</td></tr>';
        return;
      }

      data.forEach(row => {
        const trHTML = `
          <td>${row.id}</td>
          <td>${row.cw || ""}</td>
          <td>${row.aufgenommen_am || ""}</td>
          <td>${row.carrier_name || ""}</td>
          <td>${row.area || ""}</td>
          <td>${row.stage || ""}</td>
          <td>${row.planned_carton != null ? row.planned_carton : ""}</td>
          <td>${row.actual_carton != null ? row.actual_carton : ""}</td>
          <td>${row.olpn || ""}</td>
          <td>${row.carrier_tracking_nr || ""}</td>
          <td>${row.mh_status || ""}</td>
          <td style="text-align: center;">
            <button class="btn btn-ghost btn-sm" onclick="editInboundEntry(${row.id}, ${row.location_id || 'null'})" style="padding: 4px 8px; font-size: 11px;" title="Bearbeiten">
              ‚úèÔ∏è
            </button>
          </td>
        `;
        
        // F√ºr Wareneingang-Tabelle
        if (body) {
          const tr = document.createElement("tr");
          tr.className = "data-row";
          tr.innerHTML = trHTML;
          body.appendChild(tr);
        }
        
        // F√ºr Dashboard-Tabelle
        if (dashboardBody) {
          const tr = document.createElement("tr");
          tr.className = "data-row";
          tr.innerHTML = trHTML;
          dashboardBody.appendChild(tr);
        }
      });
    } catch (err) {
      console.error("Fehler inbound liste", err);
      if (body) body.innerHTML = '<tr><td colspan="12" class="muted">Fehler beim Laden der Eintr√§ge</td></tr>';
      if (dashboardBody) dashboardBody.innerHTML = '<tr><td colspan="12" class="muted">Fehler beim Laden der Eintr√§ge</td></tr>';
    }
  }

  // Dashboard Toggle f√ºr Inbound-Liste
  const dashboardToggleHeader = document.getElementById("dashboardInboundToggleHeader");
  const dashboardToggleArrow = document.getElementById("dashboardInboundToggleArrow");
  const dashboardTableContainer = document.getElementById("dashboardInboundTableContainer");
  
  if (dashboardToggleHeader) {
    dashboardToggleHeader.addEventListener("click", () => {
      const isVisible = dashboardTableContainer.style.display !== "none";
      
      if (isVisible) {
        dashboardTableContainer.style.display = "none";
        dashboardToggleArrow.textContent = "‚ñº";
      } else {
        dashboardTableContainer.style.display = "block";
        dashboardToggleArrow.textContent = "‚ñ≤";
        // Daten laden wenn noch nicht geladen
        if (dashboardTableContainer.querySelector('td[colspan]')) {
          loadInboundList();
        }
      }
    });
  }

  // Navigation-Funktion (wird direkt aufgerufen)
  function handleNavigationClick(viewName) {
    try {
      console.log("üß≠ Navigation zu View:", viewName);
      
      if (!viewName) {
        console.warn("‚ö†Ô∏è Kein viewName √ºbergeben");
        return;
      }

      // Stelle sicher, dass Loading Screen ausgeblendet ist
      const loadingScreen = document.getElementById("loadingScreen");
      if (loadingScreen) {
        loadingScreen.style.display = "none";
        loadingScreen.style.pointerEvents = "none";
        loadingScreen.style.zIndex = "-1";
        loadingScreen.style.opacity = "0";
        loadingScreen.style.visibility = "hidden";
      }

      // Aktive Klasse setzen
      const allNavItems = document.querySelectorAll(".nav-item");
      allNavItems.forEach(n => n.classList.remove("active"));
      const clickedItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
      if (clickedItem) {
        clickedItem.classList.add("active");
        console.log("‚úÖ Navigation-Item aktiviert:", viewName);
      } else {
        console.warn("‚ö†Ô∏è Navigation-Item nicht gefunden f√ºr:", viewName);
      }

      // Views wechseln
      const allViews = document.querySelectorAll(".view");
      allViews.forEach(v => {
        v.classList.remove("active");
      });
      
      const viewElement = document.getElementById("view-" + viewName);
      if (viewElement) {
        viewElement.classList.add("active");
        console.log("‚úÖ View aktiviert:", viewName);
      } else {
        console.error("‚ùå View nicht gefunden: view-" + viewName);
        // Liste aller verf√ºgbaren Views f√ºr Debugging
        const allViewIds = Array.from(document.querySelectorAll(".view")).map(v => v.id);
        console.log("üìã Verf√ºgbare Views:", allViewIds);
        return;
      }

      // Topbar aktualisieren
      if (viewMeta && viewMeta[viewName]) {
        if (topbarTitle) topbarTitle.textContent = viewMeta[viewName].title;
        if (topbarSubtitle) topbarSubtitle.textContent = viewMeta[viewName].subtitle;
      }
      
    // Nach oben scrollen beim View-Wechsel
      setTimeout(() => {
        const mainContent = document.querySelector(".main");
        if (mainContent) {
          mainContent.scrollTop = 0;
        }
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      }, 0);

      // Settings Content nur auf der Einstellungen-Seite anzeigen
      const settingsContent = document.getElementById("settingsContent");
      if (viewName !== "settings" && settingsContent) {
        settingsContent.style.display = "none";
    }

      // Charts neu initialisieren wenn Dashboard aktiviert wird
      if (viewName === "dashboard") {
        try {
          setTimeout(() => {
            if (typeof initCharts === 'function') {
              initCharts();
            }
            // Bewegungsjournal laden
            if (typeof loadAllMovements === 'function') {
              loadAllMovements();
            }
          }, 100);
        } catch (err) {
          console.error("Fehler beim Initialisieren der Charts:", err);
        }
      }

      if (viewName === "inventory") {
        try {
          // Standard-Tab aktivieren
          if (typeof switchInventoryTab === 'function') {
            switchInventoryTab('locations');
          }
          if (typeof loadInventory === 'function') {
        loadInventory();
          }
        } catch (err) {
          console.error("Fehler beim Laden des Inventars:", err);
        }
      } else if (viewName === "settings") {
        try {
        // Settings View: Pr√ºfen ob Benutzer "paypa" ist
        const settingsContent = document.getElementById("settingsContent");
        const settingsPinCard = document.getElementById("settingsPinCard");
        
        // Carrier-Auswahl zur√ºcksetzen
        const carrierInput = document.getElementById("settingsCarrierSelect");
        if (carrierInput) {
          carrierInput.value = "";
          carrierInput.removeAttribute('data-value');
        }
        
        // Carrier-Einstellungen-Form verstecken
        const carrierForm = document.getElementById("carrierSettingsForm");
        if (carrierForm) {
          carrierForm.style.display = "none";
        }
        
        // Hinweis wieder anzeigen
        const hint = document.getElementById("carrierSelectionHint");
        if (hint) hint.style.display = "block";
        
        // Wenn Benutzer "paypa" ist, direkt Zugriff gew√§hren
        if (currentWindowsUser && currentWindowsUser.toLowerCase() === "paypa") {
          if (settingsPinCard) settingsPinCard.style.display = "none";
          if (settingsContent) settingsContent.style.display = "block";
            if (typeof loadSettingsData === 'function') {
          loadSettingsData();
            }
          // Carrier-Auswahl f√ºr Einstellungsseite laden (nur wenn auf Einstellungsseite)
            if (typeof loadCarriers === 'function') {
          loadCarriers();
            }
          console.log("‚úÖ Einstellungen f√ºr Benutzer 'paypa' geladen");
        } else if (settingsContent && settingsContent.style.display === "none") {
          // F√ºr andere Benutzer: PIN zur√ºcksetzen falls nicht authentifiziert
          if (settingsPinCard) settingsPinCard.style.display = "block";
          if (settingsContent) settingsContent.style.display = "none";
          const pinInput = document.getElementById("settingsPinInput");
          if (pinInput) pinInput.value = "";
          }
        } catch (err) {
          console.error("Fehler beim Laden der Settings:", err);
        }
      } else if (viewName === "inbound") {
        try {
        // Carrier-Auswahl beim Wareneingang anzeigen
        const carrierSelectionView = document.getElementById("carrierSelectionView");
        const inboundDetailView = document.getElementById("inboundDetailView");
        const inboundListSection = document.getElementById("inboundListSection");
        
        if (carrierSelectionView) carrierSelectionView.style.display = "block";
        if (inboundDetailView) inboundDetailView.style.display = "none";
        if (inboundListSection) inboundListSection.style.display = "block";
        
        // Carrier-Buttons laden
          if (typeof loadCarriers === 'function') {
        loadCarriers();
          }
        } catch (err) {
          console.error("Fehler beim Laden des Wareneingangs:", err);
        }
      }
    } catch (err) {
      console.error("‚ùå Kritischer Fehler in handleNavigationClick:", err);
      // Stelle sicher, dass die View trotzdem gewechselt wird
      try {
        const viewElement = document.getElementById("view-" + viewName);
        if (viewElement) {
          const allViews = document.querySelectorAll(".view");
          allViews.forEach(v => v.classList.remove("active"));
          viewElement.classList.add("active");
        }
      } catch (e) {
        console.error("‚ùå Fehler beim Notfall-View-Wechsel:", e);
      }
    }
  }
  
  // Navigation-Initialisierung - einfache, direkte L√∂sung
  function initNavigation() {
    const navItems = document.querySelectorAll(".nav-item");
    console.log("üß≠ Initialisiere Navigation, gefundene Items:", navItems.length);
    
    if (navItems.length === 0) {
      console.warn("‚ö†Ô∏è Keine Navigation-Items gefunden");
      return;
    }
    
    navItems.forEach((item) => {
      // Entferne alte Event-Handler (falls vorhanden)
      const newItem = item.cloneNode(true);
      item.parentNode.replaceChild(newItem, item);
      
      // F√ºge Event-Handler hinzu
      newItem.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const viewName = this.getAttribute("data-view");
        console.log("üñ±Ô∏è Navigation-Item geklickt:", viewName);
        if (viewName) {
          handleNavigationClick(viewName);
        } else {
          console.warn("‚ö†Ô∏è Kein data-view Attribut gefunden");
        }
      });
      
      // Mache Element klickbar (Cursor)
      newItem.style.cursor = "pointer";
      newItem.style.userSelect = "none";
    });
    
    console.log("‚úÖ Navigation initialisiert");
  }
  
  // Routing und Navigation initialisieren - mehrfach versuchen falls n√∂tig
  function setupNavigation() {
    console.log("üîß Setup Routing & Navigation, readyState:", document.readyState);
    
    function tryInit() {
      const navItems = document.querySelectorAll(".nav-item");
      if (navItems.length > 0) {
        // Zuerst Routing initialisieren (wichtig: vor Navigation!)
        if (typeof initRouting === 'function') {
          initRouting();
        } else {
          console.warn("‚ö†Ô∏è Routing-System noch nicht geladen");
        }
        
        // Dann Navigation initialisieren
        if (typeof initNavigation === 'function') {
          initNavigation();
        } else {
          console.warn("‚ö†Ô∏è Navigation-Funktion noch nicht verf√ºgbar");
        }
      } else {
        console.warn("‚ö†Ô∏è Navigation-Items noch nicht verf√ºgbar, versuche erneut...");
        setTimeout(tryInit, 100);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log("üìã DOMContentLoaded - initialisiere Routing & Navigation");
        setTimeout(tryInit, 50);
      });
    } else {
      // DOM ist bereits geladen
      console.log("üìã DOM bereits geladen - initialisiere Routing & Navigation");
      setTimeout(tryInit, 50);
    }
    
    // Fallback: Versuche erneut nach window.load
    window.addEventListener('load', () => {
      console.log("üìã window.load - pr√ºfe Routing & Navigation erneut");
      setTimeout(tryInit, 100);
    });
  }
  
  setupNavigation();
  
  // Event-Delegation Fallback f√ºr Navigation (funktioniert immer, auch wenn direkte Handler fehlschlagen)
  function setupEventDelegation() {
    const navElement = document.querySelector('.nav');
    if (navElement) {
      // Entferne alte Handler falls vorhanden
      const newNavElement = navElement.cloneNode(true);
      navElement.parentNode.replaceChild(newNavElement, navElement);
      
      newNavElement.addEventListener('click', function(e) {
        const navItem = e.target.closest('.nav-item');
        if (navItem && navItem.hasAttribute('data-view')) {
          e.preventDefault();
          e.stopPropagation();
          const viewName = navItem.getAttribute('data-view');
          console.log("üß≠ Event-Delegation: Navigation zu View:", viewName);
          if (viewName) {
            handleNavigationClick(viewName);
          }
        }
      });
      console.log("‚úÖ Event-Delegation Handler f√ºr Navigation hinzugef√ºgt");
    } else {
      console.warn("‚ö†Ô∏è .nav Element nicht gefunden f√ºr Event-Delegation");
      // Versuche sp√§ter erneut
      setTimeout(setupEventDelegation, 200);
    }
  }
  
  // Event-Delegation sofort einrichten
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupEventDelegation);
  } else {
    setupEventDelegation();
  }

  document.querySelectorAll("[data-jump]").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-jump");
      const navTarget = document.querySelector('.nav-item[data-view="' + target + '"]');
      if (navTarget) {
        navTarget.click();
      }
    });
  });

  // Chart-Initialisierungs-Counter (verhindert Endlosschleifen)
  let chartInitAttempts = 0;
  const MAX_CHART_INIT_ATTEMPTS = 10;

  // Dashboard-Daten laden
  async function loadDashboardData() {
    try {
      // KPI-Statistiken laden
      const statsResponse = await fetch("/api/dashboard/stats");
      if (statsResponse.ok) {
        const stats = await statsResponse.json();
        document.getElementById("kpiOccupiedLocations").textContent = stats.occupiedLocations || 0;
        document.getElementById("kpiTotalLocations").textContent = `von ${stats.totalLocations || 0} Stellpl√§tzen gesamt`;
        document.getElementById("kpiTotalEntries").textContent = stats.totalEntries || 0;
        document.getElementById("kpiTotalCartons").textContent = stats.totalCartons || 0;
        document.getElementById("kpiOpenRAs").textContent = stats.openRAs || 0;
        document.getElementById("kpiUnclearRAs").textContent = `davon ${stats.unclearRAs || 0} mit unklarer Nummer`;
      }
    } catch (err) {
      console.error("Fehler beim Laden der Dashboard-Statistiken:", err);
    }
  }

  // Charts mit echten Daten initialisieren
  async function initCharts() {
    console.log("üìä Initialisiere Charts... (Versuch:", chartInitAttempts + 1, ")");
    
    // Verhindere Endlosschleifen
    chartInitAttempts++;
    if (chartInitAttempts > MAX_CHART_INIT_ATTEMPTS) {
      console.error("‚ùå Chart.js konnte nach", MAX_CHART_INIT_ATTEMPTS, "Versuchen nicht geladen werden. Abbruch.");
      return;
    }
    
    // Warte auf Chart.js
    if (!window.Chart) {
      console.warn("‚ö†Ô∏è Chart.js nicht geladen, versuche erneut in 500ms...");
      setTimeout(initCharts, 500);
      return;
    }
    
    // Reset Counter wenn Chart.js geladen ist
    chartInitAttempts = 0;
    
    // Pr√ºfe ob Dashboard-View aktiv ist
    const dashboardView = document.getElementById("view-dashboard");
    if (!dashboardView || !dashboardView.classList.contains("active")) {
      console.log("üìä Dashboard-View nicht aktiv, Charts werden sp√§ter initialisiert");
      return;
    }
    
    // Dashboard-Daten laden
    await loadDashboardData();
    
    const ctxWeek = document.getElementById("chartByWeek");
    const ctxCarrier = document.getElementById("chartByCarrier");
    const ctxRaStatus = document.getElementById("chartRaStatus");
    const ctxArea = document.getElementById("chartByArea");
    const ctxLocation = document.getElementById("chartByLocation");
    
    console.log("üìä Canvas-Elemente gefunden:", {
      week: !!ctxWeek,
      carrier: !!ctxCarrier,
      raStatus: !!ctxRaStatus,
      area: !!ctxArea,
      location: !!ctxLocation
    });

    // Chart: Wareneing√§nge nach Woche
    if (ctxWeek) {
      try {
        const response = await fetch("/api/dashboard/charts/week");
        if (response.ok) {
          const chartData = await response.json();
          
          if (ctxWeek.chart) {
            ctxWeek.chart.destroy();
          }
          
          ctxWeek.chart = new Chart(ctxWeek, {
            type: "line",
            data: {
              labels: chartData.labels || [],
              datasets: [{
                label: "Wareneing√§nge",
                data: chartData.data || [],
                borderColor: "#F53B01",
                backgroundColor: "rgba(245,59,1,0.18)",
                tension: 0.25,
                pointRadius: 3
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'CW',
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: { display: false }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: {
                    color: "rgba(150,150,150,0.18)"
                  }
                }
              }
            }
          });
          console.log("‚úÖ Chart 'Wareneing√§nge nach Woche' initialisiert");
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Initialisieren des Week-Charts:", err);
      }
    }

    // Chart: Retouren nach Carrier
    if (ctxCarrier) {
      try {
        const response = await fetch("/api/dashboard/charts/carrier");
        if (response.ok) {
          const chartData = await response.json();
          
          if (ctxCarrier.chart) {
            ctxCarrier.chart.destroy();
          }
          
          const colors = chartData.labels.map((_, i) => {
            if (i === 0) return "rgba(245,59,1,0.9)";
            return `rgba(97,97,97,${0.9 - i * 0.1})`;
          });
          
          ctxCarrier.chart = new Chart(ctxCarrier, {
            type: "bar",
            data: {
              labels: chartData.labels || [],
              datasets: [{
                label: "Retouren",
                data: chartData.data || [],
                backgroundColor: colors,
                borderWidth: 0
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: { display: false }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: {
                    color: "rgba(150,150,150,0.18)"
                  }
                }
              }
            }
          });
          console.log("‚úÖ Chart 'Retouren nach Frachtf√ºhrer' initialisiert");
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Initialisieren des Carrier-Charts:", err);
      }
    }

    // Chart: RA Status
    if (ctxRaStatus) {
      try {
        const response = await fetch("/api/dashboard/charts/status");
        if (response.ok) {
          const chartData = await response.json();
          
          if (ctxRaStatus.chart) {
            ctxRaStatus.chart.destroy();
          }
          
          ctxRaStatus.chart = new Chart(ctxRaStatus, {
            type: "doughnut",
            data: {
              labels: chartData.labels || [],
              datasets: [{
                data: chartData.data || [],
                backgroundColor: [
                  "rgba(60,179,113,0.9)",
                  "rgba(97,97,97,0.7)",
                  "rgba(245,59,1,0.9)"
                ],
                borderWidth: 0
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { 
                  display: true,
                  position: "bottom",
                  labels: { padding: 12, font: { size: 11 } }
                },
              },
              cutout: "60%"
            }
          });
          console.log("‚úÖ Chart 'RA Status' initialisiert");
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Initialisieren des RA-Status-Charts:", err);
      }
    }

    // Chart: Retouren nach Area
    if (ctxArea) {
      try {
        const response = await fetch("/api/dashboard/charts/area");
        if (response.ok) {
          const chartData = await response.json();
          
          if (ctxArea.chart) {
            ctxArea.chart.destroy();
          }
          
          ctxArea.chart = new Chart(ctxArea, {
            type: "bar",
            data: {
              labels: chartData.labels || [],
              datasets: [{
                label: "Wareneing√§nge",
                data: chartData.data || [],
                backgroundColor: "rgba(245,59,1,0.7)",
                borderColor: "#F53B01",
                borderWidth: 1
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: { display: false }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: {
                    color: "rgba(150,150,150,0.18)"
                  }
                }
              }
            }
          });
          console.log("‚úÖ Chart 'Retouren nach Bereich' initialisiert");
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Initialisieren des Area-Charts:", err);
      }
    }

    // Chart: Top Stellpl√§tze
    if (ctxLocation) {
      try {
        const response = await fetch("/api/dashboard/charts/locations");
        if (response.ok) {
          const chartData = await response.json();
          
          if (ctxLocation.chart) {
            ctxLocation.chart.destroy();
          }
          
          ctxLocation.chart = new Chart(ctxLocation, {
            type: "bar",
            data: {
              labels: chartData.labels || [],
              datasets: [{
                label: "Kartons",
                data: chartData.data || [],
                backgroundColor: "rgba(245,59,1,0.7)",
                borderColor: "#F53B01",
                borderWidth: 1
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: { display: false }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue("--text-soft").trim()
                  },
                  grid: {
                    color: "rgba(150,150,150,0.18)"
                  }
                }
              }
            }
          });
          console.log("‚úÖ Chart 'Top Stellpl√§tze' initialisiert");
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Initialisieren des Location-Charts:", err);
      }
    }
    
    console.log("üìä Chart-Initialisierung abgeschlossen");
  }

  /* Settings Funktionen */
  async function authenticateSettings() {
    const pin = document.getElementById("settingsPinInput")?.value;
    
    if (!pin) {
      alert("Bitte geben Sie die PIN ein!");
      return;
    }
    
    try {
      const response = await fetch("/api/settings/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pin })
      });
      
      if (response.ok) {
        document.getElementById("settingsPinCard").style.display = "none";
        document.getElementById("settingsContent").style.display = "block";
        loadSettingsData();
      } else {
        alert("‚ùå Falsche PIN!");
      }
    } catch (err) {
      console.error("Auth Fehler:", err);
      alert("Fehler bei der Authentifizierung: " + err.message);
    }
  }

  async function loadSettingsData() {
    console.log("üìã Lade Einstellungsdaten...");
    
    // Carrier f√ºr Settings laden (Searchable Dropdown)
    // Falls noch nicht geladen, erst laden
    if (carriersData.length === 0) {
      try {
        const response = await fetch("/api/carriers");
        if (response.ok) {
          carriersData = await response.json();
          console.log("‚úÖ Carrier-Daten geladen:", carriersData.length);
        }
      } catch (err) {
        console.error("‚ùå Fehler beim Laden der Carrier-Daten:", err);
      }
    }
    
    if (carriersData.length > 0) {
      const carrierOptions = carriersData.map(car => ({
        id: car.id,
        option_value: car.id.toString(),
        option_label: car.display_name
      }));
      initSearchableDropdownSettings('settingsCarrier', carrierOptions);
      console.log("‚úÖ Carrier-Dropdown initialisiert");
    }
    
    // Dropdown Optionen laden
    loadDropdownOptionsSettings();
    
    // System Info anzeigen
    const userDisplay = document.getElementById("settingsCurrentUser");
    const computerDisplay = document.getElementById("settingsComputerName");
    
    try {
      const response = await fetch("/api/current-user");
      if (response.ok) {
        const result = await response.json();
        if (userDisplay) userDisplay.textContent = result.username;
        if (computerDisplay) computerDisplay.textContent = result.computerName || "-";
        console.log("‚úÖ System-Info geladen");
      }
    } catch (err) {
      console.error("‚ùå Fehler beim Laden der System-Info:", err);
    }
    
    console.log("‚úÖ Einstellungsdaten vollst√§ndig geladen");
    
    // Stellpl√§tze laden wenn auf Stellplatz-Tab
    const locationsTab = document.getElementById("tab-locations");
    if (locationsTab && locationsTab.style.display !== "none") {
      loadSettingsLocations();
    }
  }
  
  // Stellplatz-Verwaltung Funktionen
  let settingsLocationsData = [];
  
  async function loadSettingsLocations() {
    const area = document.getElementById("settingsLocationAreaFilter")?.value || "all";
    const status = document.getElementById("settingsLocationStatusFilter")?.value || "all";
    const search = document.getElementById("settingsLocationSearch")?.value || "";
    
    const tbody = document.getElementById("settingsLocationsBody");
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="7" class="muted">Lade Stellpl√§tze...</td></tr>';
    
    try {
      const params = new URLSearchParams();
      if (area !== "all") params.append("area", area);
      if (status !== "all") params.append("active_only", status === "active" ? "true" : "false");
      if (search) params.append("search", search);
      
      const response = await fetch(`/api/warehouse/locations?${params}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      settingsLocationsData = await response.json();
      renderSettingsLocations();
      updateSettingsLocationAreaFilter();
      
    } catch (err) {
      console.error("Fehler beim Laden der Stellpl√§tze:", err);
      tbody.innerHTML = '<tr><td colspan="7" class="muted">Fehler beim Laden der Daten</td></tr>';
    }
  }

  // Audit-Logs laden
  async function loadAuditLogs() {
    const tbody = document.getElementById("auditLogsTableBody");
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">üîÑ Lade Audit-Logs...</td></tr>';
    
    try {
      const params = new URLSearchParams();
      
      const inboundId = document.getElementById("auditFilterInboundId")?.value;
      const fieldName = document.getElementById("auditFilterField")?.value;
      const changedBy = document.getElementById("auditFilterChangedBy")?.value;
      const fromDate = document.getElementById("auditFilterFromDate")?.value;
      const toDate = document.getElementById("auditFilterToDate")?.value;
      
      if (inboundId) params.append("inbound_id", inboundId);
      if (fieldName) params.append("field_name", fieldName);
      if (changedBy) params.append("changed_by", changedBy);
      if (fromDate) params.append("from_date", fromDate);
      if (toDate) params.append("to_date", toDate);
      
      const response = await fetch(`/api/audit-logs?${params}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const logs = await response.json();
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">üìã Keine Audit-Logs gefunden</td></tr>';
        return;
      }
      
      tbody.innerHTML = logs.map(log => {
        const changedAt = log.changed_at ? new Date(log.changed_at).toLocaleString('de-DE') : '-';
        const oldValue = log.old_value !== null && log.old_value !== undefined ? String(log.old_value).substring(0, 50) : '-';
        const newValue = log.new_value !== null && log.new_value !== undefined ? String(log.new_value).substring(0, 50) : '-';
        const changeReason = log.change_reason || '-';
        
        return `
          <tr>
            <td>${log.id}</td>
            <td>
              <a href="#" onclick="showInboundEntryDetails(${log.inbound_id}); return false;" style="color: var(--gxo-orange); text-decoration: none; cursor: pointer; font-weight: 600;">
                #${log.inbound_id}
              </a>
            </td>
            <td><strong>${log.field_name}</strong></td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.old_value || ''}">${oldValue}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.new_value || ''}">${newValue}</td>
            <td>${log.changed_by || '-'}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${changeReason}">${changeReason}</td>
            <td>${changedAt}</td>
          </tr>
        `;
      }).join('');
      
    } catch (err) {
      console.error("Fehler beim Laden der Audit-Logs:", err);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--error);">‚ùå Fehler beim Laden der Daten</td></tr>';
    }
  }

  // Audit-Logs filtern
  function filterAuditLogs() {
    loadAuditLogs();
  }

  // Nach Eintrag-ID filtern (wenn auf Eintrag-ID geklickt wird)
  function filterByInboundId(inboundId) {
    const filterInput = document.getElementById("auditFilterInboundId");
    if (filterInput) {
      filterInput.value = inboundId;
      loadAuditLogs();
    }
  }
  
  // Eintrag-Details anzeigen (Popup mit allen Informationen)
  async function showInboundEntryDetails(inboundId) {
    try {
      const response = await fetch(`/api/inbound-simple/${inboundId}`);
      if (!response.ok) {
        if (response.status === 404) {
          showCustomModal("‚ùå Eintrag nicht gefunden", "error");
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
        return;
      }
      
      const entry = await response.json();
      
      // Stellplatz-Informationen abrufen, falls vorhanden
      let locationInfo = "";
      if (entry.location_id) {
        try {
          const locationResponse = await fetch(`/api/warehouse/locations`);
          if (locationResponse.ok) {
            const locations = await locationResponse.json();
            const location = locations.find(l => l.id === entry.location_id);
            if (location) {
              locationInfo = `<div><strong>üìç Stellplatz:</strong> ${location.code}${location.description ? ` (${location.description})` : ''}${location.area ? ` - ${location.area}` : ''}</div>`;
            }
          }
        } catch (e) {
          console.error("Fehler beim Laden der Stellplatz-Info:", e);
        }
      }
      
      // Formatierungs-Hilfsfunktion
      const formatValue = (value) => {
        if (value === null || value === undefined || value === '') return '<span style="color: var(--text-muted);">-</span>';
        return String(value);
      };
      
      const formatDate = (dateString) => {
        if (!dateString) return '-';
        try {
          return new Date(dateString).toLocaleString('de-DE');
        } catch (e) {
          return dateString;
        }
      };
      
      // Modal HTML erstellen - ALLE Felder schreibgesch√ºtzt
      const modalHtml = `
        <div style="max-width: 1200px; width: 100%;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
            üì¶ Eintrag #${entry.id} - Details
          </h3>
          
          <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-soft); border-radius: 8px; font-size: 13px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div><strong>üìÖ Erstellt am:</strong> ${formatDate(entry.created_at)}</div>
              <div><strong>üë§ Erstellt von:</strong> ${formatValue(entry.added_by)}</div>
              ${locationInfo}
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">CW</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.cw)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Aufgenommen am</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.aufgenommen_am)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Carrier Name</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.carrier_name)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Area</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.area)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Land</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.land)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Ship Status</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.ship_status)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Stage</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.stage)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Last Stage</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.last_stage)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Planned Carton</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.planned_carton)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Actual Carton</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.actual_carton)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">OLPN</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-family: monospace; font-size: 12px;">${formatValue(entry.olpn)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Carrier Tracking Number</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-family: monospace; font-size: 12px;">${formatValue(entry.carrier_tracking_nr)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">DN</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.dn)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">SHI</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.shi)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Customer ID</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.customer_id)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Customer Name</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.customer_name)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">ASN/RA Nummer</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.asn_ra_no)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">MH Status</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.mh_status)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Neue RA</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.neue_ra)}</div>
            </div>
            
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">New Reopen RA</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); font-size: 12px;">${formatValue(entry.new_reopen_ra)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-muted);">Kommentar</label>
              <div style="padding: 8px; background: var(--bg-soft); border-radius: 6px; color: var(--text-main); min-height: 60px; white-space: pre-wrap; font-size: 12px;">${formatValue(entry.kommentar)}</div>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding: 12px; background: var(--bg-soft); border-radius: 8px; font-size: 12px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div><strong>Ignore Flag:</strong> ${entry.ignore_flag ? 'Ja' : 'Nein'}</div>
              <div><strong>Location ID:</strong> ${formatValue(entry.location_id)}</div>
            </div>
          </div>
        </div>
      `;
      
      // Modal anzeigen mit showEditModal (aber ohne Save-Button)
      showEditModal(modalHtml, async () => {
        // Keine Save-Funktion, nur Schlie√üen
        return true;
      });
      
      // Save-Button entfernen, da es nur eine Ansicht ist
      setTimeout(() => {
        const saveBtn = document.getElementById("editModalSave");
        const cancelBtn = document.getElementById("editModalCancel");
        if (saveBtn) {
          saveBtn.style.display = "none";
        }
        if (cancelBtn) {
          cancelBtn.textContent = "Schlie√üen";
        }
      }, 100);
      
    } catch (err) {
      console.error("Fehler beim Laden der Eintrag-Details:", err);
      showCustomModal(`‚ùå Fehler beim Laden der Details: ${err.message}`, "error");
    }
  }
  
  function updateSettingsLocationAreaFilter() {
    const filter = document.getElementById("settingsLocationAreaFilter");
    if (!filter) return;
    
    // Areas aus den geladenen Daten extrahieren
    const areas = [...new Set(settingsLocationsData.map(l => l.area).filter(a => a))].sort();
    
    filter.innerHTML = '<option value="all">Alle Bereiche</option>';
    areas.forEach(area => {
      const option = document.createElement("option");
      option.value = area;
      option.textContent = area;
      filter.appendChild(option);
    });
  }
  
  function renderSettingsLocations() {
    const tbody = document.getElementById("settingsLocationsBody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    if (settingsLocationsData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="muted">Keine Stellpl√§tze gefunden</td></tr>';
      return;
    }
    
    settingsLocationsData.forEach(location => {
      const tr = document.createElement("tr");
      tr.id = `location-row-${location.id}`;
      tr.dataset.locationId = location.id;
      
      // Checkbox
      const tdCheckbox = document.createElement("td");
      tdCheckbox.innerHTML = `<input type="checkbox" class="location-checkbox" data-location-id="${location.id}" onchange="updateMultiActionToolbar()">`;
      
      // Code (inline editierbar)
      const tdCode = document.createElement("td");
      tdCode.innerHTML = `<input type="text" class="inline-edit" value="${location.code}" data-field="code" data-location-id="${location.id}" style="width: 100%; padding: 4px 8px; border: 1px solid transparent; background: transparent; color: var(--text-main); font-weight: 600; border-radius: 4px;" onblur="saveLocationField(${location.id}, 'code', this.value)" onkeydown="if(event.key==='Enter'){this.blur();}">`;
      
      // Beschreibung (inline editierbar)
      const tdDesc = document.createElement("td");
      tdDesc.innerHTML = `<input type="text" class="inline-edit" value="${location.description || ''}" data-field="description" data-location-id="${location.id}" placeholder="-" style="width: 100%; padding: 4px 8px; border: 1px solid transparent; background: transparent; color: var(--text-main); border-radius: 4px;" onblur="saveLocationField(${location.id}, 'description', this.value)" onkeydown="if(event.key==='Enter'){this.blur();}">`;
      
      // Bereich (inline editierbar mit Datalist)
      const tdArea = document.createElement("td");
      tdArea.innerHTML = `
        <input type="text" class="inline-edit" value="${location.area || ''}" data-field="area" data-location-id="${location.id}" list="locationAreaList-${location.id}" placeholder="-" style="width: 100%; padding: 4px 8px; border: 1px solid transparent; background: transparent; color: var(--text-main); border-radius: 4px;" onblur="saveLocationField(${location.id}, 'area', this.value)" onkeydown="if(event.key==='Enter'){this.blur();}">
        <datalist id="locationAreaList-${location.id}">
          <option value="Area D">
          <option value="Crack">
          <option value="Waiting">
          <option value="Waiting / Zombieland">
          <option value="G√ºltige Gasse">
          <option value="Customize">
          <option value="Oben">
          <option value="Unbekannt/ altlast">
        </datalist>
      `;
      
      // Status (Toggle-Button)
      const tdStatus = document.createElement("td");
      const statusBtn = document.createElement("button");
      statusBtn.className = "btn btn-ghost btn-sm";
      statusBtn.innerHTML = location.is_active ? '<span class="pill pill-success">Aktiv</span>' : '<span class="pill">Inaktiv</span>';
      statusBtn.title = location.is_active ? 'Deaktivieren' : 'Aktivieren';
      statusBtn.onclick = () => toggleLocationStatus(location.id, location.is_active ? 0 : 1);
      statusBtn.style.padding = "4px 8px";
      tdStatus.appendChild(statusBtn);
      
      // Kartons (nur Anzeige)
      const tdCartons = document.createElement("td");
      tdCartons.innerHTML = `<strong style="color: ${location.total_cartons > 0 ? 'var(--gxo-orange)' : 'var(--text-muted)'};">${location.total_cartons || 0}</strong>`;
      
      // Erstellt am (nur Anzeige)
      const tdCreated = document.createElement("td");
      tdCreated.textContent = location.created_at ? formatDateTime(location.created_at) : '-';
      tdCreated.style.fontSize = "12px";
      tdCreated.style.color = "var(--text-muted)";
      
      // Aktionen
      const tdActions = document.createElement("td");
      tdActions.className = "table-actions";
      tdActions.innerHTML = `
        <button class="btn btn-ghost btn-sm" onclick="deleteLocation(${location.id})" title="L√∂schen" ${location.total_cartons > 0 ? 'disabled style="opacity: 0.5;"' : ''}>üóëÔ∏è</button>
      `;
      
      tr.appendChild(tdCheckbox);
      tr.appendChild(tdCode);
      tr.appendChild(tdDesc);
      tr.appendChild(tdArea);
      tr.appendChild(tdStatus);
      tr.appendChild(tdCartons);
      tr.appendChild(tdCreated);
      tr.appendChild(tdActions);
      
      tbody.appendChild(tr);
    });
    
    updateMultiActionToolbar();
  }
  
  let locationModalEscHandler = null;
  
  function showAddLocationDialog() {
    try {
      const modal = document.getElementById("addLocationModal");
      if (!modal) {
        console.error("Modal nicht gefunden!");
        // Fallback zu prompt wenn Modal nicht existiert
        const code = prompt("Stellplatz-Code eingeben:");
        if (!code || code.trim() === "") return;
        const description = prompt("Beschreibung (optional):") || "";
        const area = prompt("Bereich (z.B. Area D, Crack, Waiting):") || "";
        createLocation(code.trim(), description.trim(), area.trim());
        return;
      }
      
      // Felder zur√ºcksetzen
      const codeInput = document.getElementById("newLocationCode");
      const descriptionInput = document.getElementById("newLocationDescription");
      const areaInput = document.getElementById("newLocationArea");
      
      if (codeInput) codeInput.value = "";
      if (descriptionInput) descriptionInput.value = "";
      if (areaInput) areaInput.value = "";
      
      // Modal anzeigen mit Flexbox-Zentrierung
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      
      // Fokus auf Code-Feld
      setTimeout(() => {
        if (codeInput) {
          codeInput.focus();
        }
      }, 100);
      
      // Klick au√üerhalb schlie√üt Modal
      const clickHandler = (e) => {
        if (e.target === modal) {
          closeAddLocationModal();
        }
      };
      modal.removeEventListener("click", clickHandler); // Entferne alten Handler falls vorhanden
      modal.addEventListener("click", clickHandler);
      
      // ESC-Taste schlie√üt Modal
      if (locationModalEscHandler) {
        document.removeEventListener("keydown", locationModalEscHandler);
      }
      locationModalEscHandler = (e) => {
        if (e.key === "Escape" && modal.style.display === "flex") {
          closeAddLocationModal();
        }
      };
      document.addEventListener("keydown", locationModalEscHandler);
      
    } catch (err) {
      console.error("Fehler in showAddLocationDialog:", err);
      showCustomModal(`‚ùå Fehler beim √ñffnen des Dialogs: ${err.message}`, "error");
    }
  }
  
  function closeAddLocationModal() {
    try {
      const modal = document.getElementById("addLocationModal");
      if (modal) {
        modal.style.display = "none";
      }
      
      // ESC-Handler entfernen
      if (locationModalEscHandler) {
        document.removeEventListener("keydown", locationModalEscHandler);
        locationModalEscHandler = null;
      }
    } catch (err) {
      console.error("Fehler beim Schlie√üen des Modals:", err);
    }
  }
  
  async function saveNewLocation() {
    try {
      const codeInput = document.getElementById("newLocationCode");
      const descriptionInput = document.getElementById("newLocationDescription");
      const areaInput = document.getElementById("newLocationArea");
      
      if (!codeInput) {
        showCustomModal("‚ùå Code-Feld nicht gefunden", "error");
        return;
      }
      
      const code = codeInput.value.trim();
      if (!code) {
        showCustomModal("‚ùå Bitte geben Sie einen Stellplatz-Code ein!", "error");
        codeInput.focus();
        return;
      }
      
      const description = descriptionInput ? descriptionInput.value.trim() : "";
      const area = areaInput ? areaInput.value.trim() : "";
      
      await createLocation(code, description, area);
      
    } catch (err) {
      console.error("Fehler in saveNewLocation:", err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
    }
  }
  
  async function createLocation(code, description, area) {
    try {
      console.log("üîß Erstelle Stellplatz:", { code, description, area });
      
      if (!code || code.trim() === "") {
        throw new Error("Stellplatz-Code ist erforderlich");
      }
      
      const url = "/api/warehouse/locations";
      const payload = {
        code: code.trim(),
        description: description || "",
        area: area || "",
        created_by: currentWindowsUser || "System"
      };
      
      console.log("üì§ Sende Request an:", url);
      console.log("üì¶ Payload:", payload);
      
      const response = await fetch(url, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload)
      });
      
      console.log("üì• Response Status:", response.status, response.statusText);
      
      if (!response.ok) {
        let errorMessage = "Unbekannter Fehler";
        let errorDetails = null;
        
        try {
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            errorDetails = await response.json();
            errorMessage = errorDetails.error || errorDetails.message || errorMessage;
          } else {
            const text = await response.text();
            errorMessage = text || `HTTP ${response.status}: ${response.statusText}`;
          }
        } catch (e) {
          console.error("Fehler beim Lesen der Fehlerantwort:", e);
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        
        console.error("‚ùå Server-Fehler:", errorMessage, errorDetails);
        throw new Error(errorMessage);
      }
      
      const result = await response.json();
      console.log("‚úÖ Stellplatz erstellt:", result);
      
      // Modal schlie√üen
      closeAddLocationModal();
      
      showCustomModal("‚úÖ Stellplatz erfolgreich erstellt!", "success");
      await loadSettingsLocations();
      
    } catch (err) {
      console.error("‚ùå Fehler beim Erstellen:", err);
      
      // Detailliertere Fehlermeldung
      let errorMsg = err.message;
      if (err.message.includes("404")) {
        errorMsg = "Server-Endpunkt nicht gefunden. Bitte stellen Sie sicher, dass der Server l√§uft und neu gestartet wurde.";
      } else if (err.message.includes("Failed to fetch") || err.message.includes("NetworkError")) {
        errorMsg = "Verbindungsfehler. Bitte pr√ºfen Sie, ob der Server l√§uft.";
      }
      
      showCustomModal(`‚ùå Fehler: ${errorMsg}`, "error");
    }
  }
  
  // Inline-Bearbeitung f√ºr einzelne Felder
  async function saveLocationField(locationId, fieldName, newValue) {
    try {
      const location = settingsLocationsData.find(l => l.id === locationId);
      if (!location) return;
      
      // Pr√ºfen ob Wert sich ge√§ndert hat
      const oldValue = location[fieldName] || '';
      if (oldValue === newValue.trim()) {
        return; // Keine √Ñnderung
      }
      
      // Aktualisiere lokale Daten
      location[fieldName] = newValue.trim();
      
      // Update auf Server
      const response = await fetch(`/api/warehouse/locations/${locationId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: fieldName === 'code' ? newValue.trim() : location.code,
          description: fieldName === 'description' ? newValue.trim() : (location.description || ''),
          area: fieldName === 'area' ? newValue.trim() : (location.area || ''),
          is_active: location.is_active
        })
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || "Fehler beim Aktualisieren");
      }
      
      // Visuelles Feedback
      const input = document.querySelector(`input[data-location-id="${locationId}"][data-field="${fieldName}"]`);
      if (input) {
        input.style.borderColor = "var(--gxo-orange)";
        setTimeout(() => {
          input.style.borderColor = "transparent";
        }, 1000);
      }
      
      console.log(`‚úÖ Feld ${fieldName} f√ºr Stellplatz ${locationId} aktualisiert`);
      
    } catch (err) {
      console.error("Fehler beim Speichern:", err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
      // Daten neu laden bei Fehler
      await loadSettingsLocations();
    }
  }
  
  async function updateLocation(id, code, description, area, isActive) {
    try {
      const response = await fetch(`/api/warehouse/locations/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code,
          description,
          area,
          is_active: isActive
        })
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || "Fehler beim Aktualisieren");
      }
      
      showCustomModal("‚úÖ Stellplatz erfolgreich aktualisiert!", "success");
      await loadSettingsLocations();
      
    } catch (err) {
      console.error("Fehler beim Aktualisieren:", err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
    }
  }
  
  async function toggleLocationStatus(locationId, newStatus) {
    const location = settingsLocationsData.find(l => l.id === locationId);
    if (!location) return;
    
    const statusText = newStatus ? "aktivieren" : "deaktivieren";
    const statusTextPast = newStatus ? "aktiviert" : "deaktiviert";
    
    // Verwende showModal mit Promise f√ºr bessere Kontrolle
    const confirmed = await showModal(
      `M√∂chten Sie den Stellplatz <strong>${location.code}</strong> wirklich ${statusText}?`,
      'question',
      'Status √§ndern'
    );
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`/api/warehouse/locations/${locationId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: location.code,
          description: location.description || "",
          area: location.area || "",
          is_active: newStatus === 1
        })
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || "Fehler beim Aktualisieren");
      }
      
      showCustomModal(`‚úÖ Stellplatz erfolgreich ${statusTextPast}!`, "success");
      await loadSettingsLocations();
      
    } catch (err) {
      console.error("Fehler beim Status √§ndern:", err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
    }
  }
  
  async function deleteLocation(locationId) {
    const location = settingsLocationsData.find(l => l.id === locationId);
    if (!location) return;
    
    // Pr√ºfe ob Stellplatz Kartons hat
    if (location.total_cartons > 0) {
      showCustomModal(
        `‚ùå Stellplatz kann nicht gel√∂scht werden!<br><br>Es sind noch <strong>${location.total_cartons} Kartons</strong> auf diesem Stellplatz gebucht.`,
        "error"
      );
      return;
    }
    
    // Warnung mit Details
    const warningMessage = `
      <div style="text-align: center; padding: 8px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;">‚ö†Ô∏è</div>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-main);">
          Stellplatz l√∂schen?
        </div>
        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
          Stellplatz: <strong>${location.code}</strong><br>
          ${location.description ? `Beschreibung: ${location.description}<br>` : ''}
          Bereich: ${location.area || 'Unbekannt'}
        </div>
        <div style="font-size: 13px; color: var(--text-muted); padding: 12px; background: var(--bg-soft); border-radius: 8px; border-left: 3px solid #ff9800;">
          <strong>Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</strong>
        </div>
      </div>
    `;
    
    const confirmed = await showModal(warningMessage, 'question', '‚ö†Ô∏è Stellplatz l√∂schen');
    
    if (!confirmed) return;
    
    try {
      const response = await fetch(`/api/warehouse/locations/${locationId}`, {
        method: "DELETE"
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || "Fehler beim L√∂schen");
      }
      
      showCustomModal("‚úÖ Stellplatz erfolgreich gel√∂scht!", "success");
      await loadSettingsLocations();
      
    } catch (err) {
      console.error("Fehler beim L√∂schen:", err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, "error");
    }
  }
  
  // Multi-Action Funktionen
  function getSelectedLocationIds() {
    const checkboxes = document.querySelectorAll('.location-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.dataset.locationId));
  }
  
  function updateMultiActionToolbar() {
    const selectedIds = getSelectedLocationIds();
    const toolbar = document.getElementById('multiActionToolbar');
    const countSpan = document.getElementById('selectedCount');
    const multiAddBtn = document.getElementById('multiAddBtn');
    
    if (selectedIds.length > 0) {
      toolbar.style.display = 'block';
      countSpan.textContent = `${selectedIds.length} ausgew√§hlt`;
    } else {
      toolbar.style.display = 'none';
    }
    
    // Multi-Add Button immer anzeigen
    if (multiAddBtn) {
      multiAddBtn.style.display = 'inline-block';
    }
  }
  
  function toggleSelectAllLocations(checked) {
    const checkboxes = document.querySelectorAll('.location-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    updateMultiActionToolbar();
  }
  
  function selectAllLocations() {
    const checkbox = document.getElementById('selectAllLocationsCheckbox');
    if (checkbox) {
      checkbox.checked = true;
      toggleSelectAllLocations(true);
    }
  }
  
  function deselectAllLocations() {
    const checkbox = document.getElementById('selectAllLocationsCheckbox');
    if (checkbox) {
      checkbox.checked = false;
      toggleSelectAllLocations(false);
    }
  }
  
  // Multi-Add Funktionen
  let multiLocationRowId = 0;
  
  function showMultiAddLocationDialog() {
    const modal = document.getElementById('multiAddLocationModal');
    if (!modal) return;
    
    modal.style.display = 'flex';
    multiLocationRowId = 0;
    
    // F√ºge erste Zeile hinzu
    addMultiLocationRow();
    
    // ESC-Handler
    const escHandler = (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeMultiAddLocationModal();
      }
    };
    document.addEventListener('keydown', escHandler);
    
    // Klick au√üerhalb schlie√üt Modal
    modal.onclick = (e) => {
      if (e.target === modal) {
        closeMultiAddLocationModal();
      }
    };
  }
  
  function closeMultiAddLocationModal() {
    const modal = document.getElementById('multiAddLocationModal');
    if (modal) {
      modal.style.display = 'none';
    }
    clearMultiLocationTable();
  }
  
  function addMultiLocationRow() {
    const tbody = document.getElementById('multiAddLocationTableBody');
    if (!tbody) return;
    
    const rowId = multiLocationRowId++;
    const tr = document.createElement('tr');
    tr.id = `multiLocationRow-${rowId}`;
    tr.innerHTML = `
      <td style="text-align: center; color: var(--text-muted);">${rowId + 1}</td>
      <td>
        <input type="text" class="multi-location-code" data-row-id="${rowId}" placeholder="z.B. D-01-01" style="width: 100%; padding: 6px 8px;" required>
      </td>
      <td>
        <input type="text" class="multi-location-description" data-row-id="${rowId}" placeholder="Optional" style="width: 100%; padding: 6px 8px;">
      </td>
      <td>
        <input type="text" class="multi-location-area" data-row-id="${rowId}" list="multiLocationAreaList" placeholder="z.B. Area D" style="width: 100%; padding: 6px 8px;">
        <datalist id="multiLocationAreaList">
          <option value="Area D">
          <option value="Crack">
          <option value="Waiting">
          <option value="Waiting / Zombieland">
          <option value="G√ºltige Gasse">
          <option value="Customize">
          <option value="Oben">
          <option value="Unbekannt/ altlast">
        </datalist>
      </td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="removeMultiLocationRow(${rowId})" title="Zeile entfernen">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
    
    // Focus auf Code-Feld
    const codeInput = tr.querySelector('.multi-location-code');
    if (codeInput) {
      setTimeout(() => codeInput.focus(), 100);
    }
  }
  
  function removeMultiLocationRow(rowId) {
    const tr = document.getElementById(`multiLocationRow-${rowId}`);
    if (tr) {
      tr.remove();
      updateMultiLocationRowNumbers();
    }
  }
  
  function updateMultiLocationRowNumbers() {
    const rows = document.querySelectorAll('#multiAddLocationTableBody tr');
    rows.forEach((row, index) => {
      const td = row.querySelector('td:first-child');
      if (td) {
        td.textContent = index + 1;
      }
    });
  }
  
  function clearMultiLocationTable() {
    const tbody = document.getElementById('multiAddLocationTableBody');
    if (tbody) {
      tbody.innerHTML = '';
    }
    multiLocationRowId = 0;
  }
  
  async function saveMultiLocations() {
    const rows = document.querySelectorAll('#multiAddLocationTableBody tr');
    if (rows.length === 0) {
      showCustomModal('‚ùå Bitte f√ºgen Sie mindestens eine Zeile hinzu!', 'error');
      return;
    }
    
    const locations = [];
    const errors = [];
    
    rows.forEach((row, index) => {
      const codeInput = row.querySelector('.multi-location-code');
      const descInput = row.querySelector('.multi-location-description');
      const areaInput = row.querySelector('.multi-location-area');
      
      const code = codeInput ? codeInput.value.trim() : '';
      const description = descInput ? descInput.value.trim() : '';
      const area = areaInput ? areaInput.value.trim() : '';
      
      if (!code) {
        errors.push(`Zeile ${index + 1}: Code fehlt`);
        return;
      }
      
      locations.push({ code, description, area });
    });
    
    if (errors.length > 0) {
      showCustomModal(`‚ùå Fehler:<br>${errors.join('<br>')}`, 'error');
      return;
    }
    
    if (locations.length === 0) {
      showCustomModal('‚ùå Keine g√ºltigen Stellpl√§tze zum Speichern!', 'error');
      return;
    }
    
    // Best√§tigung
    const confirmed = await showModal(
      `M√∂chten Sie <strong>${locations.length} Stellplatz${locations.length > 1 ? 'e' : ''}</strong> hinzuf√ºgen?`,
      'question',
      'Mehrere Stellpl√§tze speichern'
    );
    
    if (!confirmed) return;
    
    try {
      let successCount = 0;
      let errorCount = 0;
      const errorMessages = [];
      
      for (const loc of locations) {
        try {
          await createLocation(loc.code, loc.description, loc.area);
          successCount++;
        } catch (err) {
          errorCount++;
          errorMessages.push(`${loc.code}: ${err.message}`);
        }
      }
      
      if (errorCount === 0) {
        showCustomModal(`‚úÖ Alle ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} erfolgreich hinzugef√ºgt!`, 'success');
      } else {
        showCustomModal(
          `‚ö†Ô∏è ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} hinzugef√ºgt, ${errorCount} Fehler:<br><br>${errorMessages.join('<br>')}`,
          'warning'
        );
      }
      
      closeMultiAddLocationModal();
      await loadSettingsLocations();
      
    } catch (err) {
      console.error('Fehler beim Speichern:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Multi-Edit Funktion
  async function multiEditLocations() {
    const selectedIds = getSelectedLocationIds();
    if (selectedIds.length === 0) {
      showCustomModal('‚ùå Bitte w√§hlen Sie mindestens einen Stellplatz aus!', 'error');
      return;
    }
    
    const locations = selectedIds.map(id => settingsLocationsData.find(l => l.id === id)).filter(l => l);
    
    // Erstelle Modal f√ºr Multi-Edit
    const editMessage = `
      <div style="margin-bottom: 16px;">
        <p>Sie bearbeiten <strong>${locations.length} Stellplatz${locations.length > 1 ? 'e' : ''}</strong>:</p>
        <ul style="max-height: 200px; overflow-y: auto; padding-left: 20px; margin: 8px 0;">
          ${locations.map(l => `<li>${l.code}</li>`).join('')}
        </ul>
      </div>
      <div class="form-grid" style="grid-template-columns: 1fr; gap: 12px;">
        <div class="form-group">
          <label>Neue Beschreibung (leer lassen zum Beibehalten)</label>
          <input type="text" id="multiEditDescription" placeholder="Neue Beschreibung f√ºr alle" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
        </div>
        <div class="form-group">
          <label>Neuer Bereich (leer lassen zum Beibehalten)</label>
          <input type="text" id="multiEditArea" list="multiEditAreaList" placeholder="Neuer Bereich f√ºr alle" style="width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
          <datalist id="multiEditAreaList">
            <option value="Area D">
            <option value="Crack">
            <option value="Waiting">
            <option value="Waiting / Zombieland">
            <option value="G√ºltige Gasse">
            <option value="Customize">
            <option value="Oben">
            <option value="Unbekannt/ altlast">
          </datalist>
        </div>
      </div>
    `;
    
    const confirmed = await showModal(editMessage, 'question', 'Mehrere Stellpl√§tze bearbeiten');
    
    if (!confirmed) return;
    
    // Warte kurz, damit das Modal vollst√§ndig gerendert ist
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const newDescription = document.getElementById('multiEditDescription')?.value.trim() || null;
    const newArea = document.getElementById('multiEditArea')?.value.trim() || null;
    
    if (!newDescription && !newArea) {
      showCustomModal('‚ùå Bitte geben Sie mindestens eine √Ñnderung ein!', 'error');
      return;
    }
    
    try {
      let successCount = 0;
      let errorCount = 0;
      
      for (const location of locations) {
        try {
          const response = await fetch(`/api/warehouse/locations/${location.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              code: location.code,
              description: newDescription !== null ? newDescription : (location.description || ""),
              area: newArea !== null ? newArea : (location.area || ""),
              is_active: location.is_active
            })
          });
          
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Fehler beim Aktualisieren");
          }
          
          successCount++;
        } catch (err) {
          errorCount++;
          console.error(`Fehler beim Bearbeiten von ${location.code}:`, err);
        }
      }
      
      if (errorCount === 0) {
        showCustomModal(`‚úÖ Alle ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} erfolgreich bearbeitet!`, 'success');
      } else {
        showCustomModal(`‚ö†Ô∏è ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} bearbeitet, ${errorCount} Fehler`, 'warning');
      }
      
      deselectAllLocations();
      await loadSettingsLocations();
      
    } catch (err) {
      console.error('Fehler beim Multi-Edit:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Multi-Deaktivieren Funktion
  async function multiDeactivateLocations() {
    const selectedIds = getSelectedLocationIds();
    if (selectedIds.length === 0) {
      showCustomModal('‚ùå Bitte w√§hlen Sie mindestens einen Stellplatz aus!', 'error');
      return;
    }
    
    const locations = selectedIds.map(id => settingsLocationsData.find(l => l.id === id)).filter(l => l);
    const activeCount = locations.filter(l => l.is_active).length;
    const inactiveCount = locations.length - activeCount;
    
    let message = `M√∂chten Sie <strong>${locations.length} Stellplatz${locations.length > 1 ? 'e' : ''}</strong> deaktivieren?`;
    if (activeCount > 0 && inactiveCount > 0) {
      message += `<br><br>Davon sind ${activeCount} aktiv und ${inactiveCount} bereits inaktiv.`;
    }
    
    const confirmed = await showModal(message, 'question', 'Stellpl√§tze deaktivieren');
    
    if (!confirmed) return;
    
    try {
      let successCount = 0;
      let errorCount = 0;
      
      for (const location of locations) {
        try {
          const response = await fetch(`/api/warehouse/locations/${location.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              code: location.code,
              description: location.description || "",
              area: location.area || "",
              is_active: false
            })
          });
          
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Fehler beim Deaktivieren");
          }
          
          successCount++;
        } catch (err) {
          errorCount++;
          console.error(`Fehler beim Deaktivieren von ${location.code}:`, err);
        }
      }
      
      if (errorCount === 0) {
        showCustomModal(`‚úÖ Alle ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} erfolgreich deaktiviert!`, 'success');
      } else {
        showCustomModal(`‚ö†Ô∏è ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} deaktiviert, ${errorCount} Fehler`, 'warning');
      }
      
      deselectAllLocations();
      await loadSettingsLocations();
      
    } catch (err) {
      console.error('Fehler beim Multi-Deaktivieren:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Multi-L√∂schen Funktion
  async function multiDeleteLocations() {
    const selectedIds = getSelectedLocationIds();
    if (selectedIds.length === 0) {
      showCustomModal('‚ùå Bitte w√§hlen Sie mindestens einen Stellplatz aus!', 'error');
      return;
    }
    
    const locations = selectedIds.map(id => settingsLocationsData.find(l => l.id === id)).filter(l => l);
    
    // Pr√ºfe ob Stellpl√§tze Kartons haben
    const locationsWithCartons = locations.filter(l => l.total_cartons > 0);
    if (locationsWithCartons.length > 0) {
      const codes = locationsWithCartons.map(l => `${l.code} (${l.total_cartons} Kartons)`).join('<br>');
      showCustomModal(
        `‚ùå Folgende Stellpl√§tze k√∂nnen nicht gel√∂scht werden:<br><br>${codes}`,
        'error'
      );
      return;
    }
    
    // Warnung
    const warningMessage = `
      <div style="text-align: center; padding: 8px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;">‚ö†Ô∏è</div>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-main);">
          ${locations.length} Stellplatz${locations.length > 1 ? 'e' : ''} l√∂schen?
        </div>
        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px; max-height: 200px; overflow-y: auto;">
          <strong>Stellpl√§tze:</strong><br>
          ${locations.map(l => `‚Ä¢ ${l.code}${l.description ? ` (${l.description})` : ''}`).join('<br>')}
        </div>
        <div style="font-size: 13px; color: var(--text-muted); padding: 12px; background: var(--bg-soft); border-radius: 8px; border-left: 3px solid #ff9800;">
          <strong>Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</strong>
        </div>
      </div>
    `;
    
    const confirmed = await showModal(warningMessage, 'question', '‚ö†Ô∏è Stellpl√§tze l√∂schen');
    
    if (!confirmed) return;
    
    try {
      let successCount = 0;
      let errorCount = 0;
      const errorMessages = [];
      
      for (const location of locations) {
        try {
          const response = await fetch(`/api/warehouse/locations/${location.id}`, {
            method: "DELETE"
          });
          
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Fehler beim L√∂schen");
          }
          
          successCount++;
        } catch (err) {
          errorCount++;
          errorMessages.push(`${location.code}: ${err.message}`);
        }
      }
      
      if (errorCount === 0) {
        showCustomModal(`‚úÖ Alle ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} erfolgreich gel√∂scht!`, 'success');
      } else {
        showCustomModal(
          `‚ö†Ô∏è ${successCount} Stellplatz${successCount > 1 ? 'e' : ''} gel√∂scht, ${errorCount} Fehler:<br><br>${errorMessages.join('<br>')}`,
          'warning'
        );
      }
      
      deselectAllLocations();
      await loadSettingsLocations();
      
    } catch (err) {
      console.error('Fehler beim Multi-L√∂schen:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }

  function loadCarrierSettings(carrierId) {
    const carrier = carriersData.find(c => c.id == carrierId);
    if (!carrier) return;
    
    // Hinweis ausblenden
    const hint = document.getElementById("carrierSelectionHint");
    if (hint) hint.style.display = "none";
    
    document.getElementById("carrierSettingsForm").style.display = "block";
    document.getElementById("settingsDisplayName").value = carrier.display_name || "";
    document.getElementById("settingsCountry").value = carrier.country || "";
    document.getElementById("settingsDefaultArea").value = carrier.default_area || "";
    document.getElementById("settingsDefaultShipStatus").value = carrier.default_ship_status || "";
    // Label-Bilder laden (komma-separiert)
    const labelImages = carrier.label_image ? carrier.label_image.split(',').map(img => img.trim()).filter(img => img) : [];
    loadLabelImageFields(labelImages);
    document.getElementById("settingsLabelHelpText").value = carrier.label_help_text || "";
    
    console.log("üìù Carrier-Einstellungen geladen:", carrier.display_name);
    
    // OLPN Validierung laden
    const olpnVal = carrier.olpn_validation ? JSON.parse(carrier.olpn_validation) : {};
    document.getElementById("settingsOlpnEnabled").checked = olpnVal.enabled || false;
    document.getElementById("settingsOlpnRequired").checked = olpnVal.required || false;
    document.getElementById("settingsOlpnLength").value = olpnVal.length || "";
    document.getElementById("settingsOlpnStartsWith").value = (olpnVal.startsWith || []).join(",");
    document.getElementById("settingsOlpnError").value = olpnVal.errorMessage || "";
    
    // Tracking Validierung laden
    const trackingVal = carrier.tracking_validation ? JSON.parse(carrier.tracking_validation) : {};
    document.getElementById("settingsTrackingEnabled").checked = trackingVal.enabled || false;
    document.getElementById("settingsTrackingRequired").checked = trackingVal.required || false;
    document.getElementById("settingsTrackingLength").value = trackingVal.length || "";
    document.getElementById("settingsTrackingStartsWith").value = (trackingVal.startsWith || []).join(",");
    document.getElementById("settingsTrackingError").value = trackingVal.errorMessage || "";
    
    // Visible Fields Checkboxen
    const visibleFields = carrier.visible_fields ? JSON.parse(carrier.visible_fields) : [];
    const container = document.getElementById("visibleFieldsCheckboxes");
    
    const allFields = [
      { id: "cw", label: "CW" },
      { id: "aufgenommen_am", label: "Aufgenommen am" },
      { id: "ignore", label: "Ignore" },
      { id: "area", label: "Area" },
      { id: "location_id", label: "üìç Stellplatz" },
      { id: "carrier_name", label: "Carrier Name" },
      { id: "land", label: "Land" },
      { id: "ship_status", label: "Ship Status" },
      { id: "planned_carton", label: "Planned Carton" },
      { id: "actual_carton", label: "Actual Carton" },
      { id: "olpn", label: "OLPN" },
      { id: "dn", label: "DN" },
      { id: "shi", label: "SHI" },
      { id: "carrier_tracking_nr", label: "Carrier Tracking" },
      { id: "customer_id", label: "Customer ID" },
      { id: "customer_name", label: "Customer Name" },
      { id: "asn_ra_no", label: "ASN/RA Nummer" },
      { id: "kommentar", label: "Kommentar" },
      { id: "added_by", label: "Added By" }
    ];
    
    container.innerHTML = "";
    allFields.forEach(field => {
      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.gap = "6px";
      
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = "field_" + field.id;
      checkbox.value = field.id;
      checkbox.checked = visibleFields.includes(field.id);
      checkbox.style.width = "auto";
      checkbox.style.cursor = "pointer";
      
      const label = document.createElement("label");
      label.htmlFor = "field_" + field.id;
      label.textContent = field.label;
      label.style.cursor = "pointer";
      label.style.textTransform = "none";
      label.style.fontSize = "12px";
      
      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
    
    // Bulk Fields Checkboxen laden
    const bulkFixedFields = carrier.bulk_fixed_fields ? JSON.parse(carrier.bulk_fixed_fields) : ["cw", "aufgenommen_am", "area", "location_id", "land", "carrier_name"];
    const bulkVariableFields = carrier.bulk_variable_fields ? JSON.parse(carrier.bulk_variable_fields) : ["carrier_tracking_nr", "olpn", "planned_carton", "actual_carton", "dn", "customer_id", "asn_ra_no", "kommentar"];
    
    console.log("üìã Lade Bulk Fields Checkboxen...");
    console.log("Feste Felder:", bulkFixedFields);
    console.log("Variable Felder:", bulkVariableFields);
    
    const bulkFixedContainer = document.getElementById("bulkFixedFieldsCheckboxes");
    const bulkVariableContainer = document.getElementById("bulkVariableFieldsCheckboxes");
    
    if (!bulkFixedContainer) {
      console.error("‚ùå bulkFixedFieldsCheckboxes Container nicht gefunden!");
    }
    if (!bulkVariableContainer) {
      console.error("‚ùå bulkVariableFieldsCheckboxes Container nicht gefunden!");
    }
    
    bulkFixedContainer.innerHTML = "";
    bulkVariableContainer.innerHTML = "";
    
    allFields.forEach(field => {
      // Feste Felder Checkbox
      const fixedDiv = document.createElement("div");
      fixedDiv.style.display = "flex";
      fixedDiv.style.alignItems = "center";
      fixedDiv.style.gap = "6px";
      
      const fixedCheckbox = document.createElement("input");
      fixedCheckbox.type = "checkbox";
      fixedCheckbox.id = "bulk_fixed_" + field.id;
      fixedCheckbox.value = field.id;
      fixedCheckbox.checked = bulkFixedFields.includes(field.id);
      fixedCheckbox.style.width = "auto";
      fixedCheckbox.style.cursor = "pointer";
      
      const fixedLabel = document.createElement("label");
      fixedLabel.htmlFor = "bulk_fixed_" + field.id;
      fixedLabel.textContent = field.label;
      fixedLabel.style.cursor = "pointer";
      fixedLabel.style.textTransform = "none";
      fixedLabel.style.fontSize = "12px";
      
      fixedDiv.appendChild(fixedCheckbox);
      fixedDiv.appendChild(fixedLabel);
      bulkFixedContainer.appendChild(fixedDiv);
      
      // Variable Felder Checkbox
      const varDiv = document.createElement("div");
      varDiv.style.display = "flex";
      varDiv.style.alignItems = "center";
      varDiv.style.gap = "6px";
      
      const varCheckbox = document.createElement("input");
      varCheckbox.type = "checkbox";
      varCheckbox.id = "bulk_var_" + field.id;
      varCheckbox.value = field.id;
      varCheckbox.checked = bulkVariableFields.includes(field.id);
      varCheckbox.style.width = "auto";
      varCheckbox.style.cursor = "pointer";
      
      const varLabel = document.createElement("label");
      varLabel.htmlFor = "bulk_var_" + field.id;
      varLabel.textContent = field.label;
      varLabel.style.cursor = "pointer";
      varLabel.style.textTransform = "none";
      varLabel.style.fontSize = "12px";
      
      varDiv.appendChild(varCheckbox);
      varDiv.appendChild(varLabel);
      bulkVariableContainer.appendChild(varDiv);
    });
    
    console.log(`‚úÖ ${allFields.length} Felder geladen (Feste: ${bulkFixedFields.length}, Variable: ${bulkVariableFields.length})`);
  }

  async function saveCarrierSettings() {
    const carrierInput = document.getElementById("settingsCarrierSelect");
    const carrierId = carrierInput?.getAttribute('data-value') || carrierInput?.value;
    if (!carrierId) {
      alert("Bitte w√§hlen Sie einen Carrier aus!");
      return;
    }
    
    // Visible Fields sammeln
    const checkboxes = document.querySelectorAll("#visibleFieldsCheckboxes input[type=checkbox]:checked");
    const visibleFields = Array.from(checkboxes).map(cb => cb.value);
    
    // Bulk Fixed Fields sammeln
    const bulkFixedCheckboxes = document.querySelectorAll("#bulkFixedFieldsCheckboxes input[type=checkbox]:checked");
    const bulkFixedFields = Array.from(bulkFixedCheckboxes).map(cb => cb.value);
    
    // Bulk Variable Fields sammeln
    const bulkVariableCheckboxes = document.querySelectorAll("#bulkVariableFieldsCheckboxes input[type=checkbox]:checked");
    const bulkVariableFields = Array.from(bulkVariableCheckboxes).map(cb => cb.value);
    
    console.log("Speichere Carrier-Einstellungen:");
    console.log("Carrier ID:", carrierId);
    console.log("Visible Fields:", visibleFields);
    console.log("Bulk Fixed Fields:", bulkFixedFields);
    console.log("Bulk Variable Fields:", bulkVariableFields);
    
    // OLPN Validierung sammeln
    const olpnStartsWith = document.getElementById("settingsOlpnStartsWith").value
      .split(",")
      .map(s => s.trim())
      .filter(s => s.length > 0);
    
    const olpnValidation = {
      enabled: document.getElementById("settingsOlpnEnabled").checked,
      required: document.getElementById("settingsOlpnRequired").checked,
      length: parseInt(document.getElementById("settingsOlpnLength").value) || null,
      startsWith: olpnStartsWith,
      errorMessage: document.getElementById("settingsOlpnError").value || ""
    };
    
    // Tracking Validierung sammeln
    const trackingStartsWith = document.getElementById("settingsTrackingStartsWith").value
      .split(",")
      .map(s => s.trim())
      .filter(s => s.length > 0);
    
    const trackingValidation = {
      enabled: document.getElementById("settingsTrackingEnabled").checked,
      required: document.getElementById("settingsTrackingRequired").checked,
      length: parseInt(document.getElementById("settingsTrackingLength").value) || null,
      startsWith: trackingStartsWith,
      errorMessage: document.getElementById("settingsTrackingError").value || ""
    };
    
    const payload = {
      display_name: document.getElementById("settingsDisplayName").value,
      country: document.getElementById("settingsCountry").value,
      default_area: document.getElementById("settingsDefaultArea").value,
      default_ship_status: document.getElementById("settingsDefaultShipStatus").value,
      label_image: getLabelImageValues().join(','),
      label_help_text: document.getElementById("settingsLabelHelpText").value,
      visible_fields: JSON.stringify(visibleFields),
      bulk_fixed_fields: JSON.stringify(bulkFixedFields),
      bulk_variable_fields: JSON.stringify(bulkVariableFields),
      field_placeholders: "{}",
      olpn_validation: JSON.stringify(olpnValidation),
      tracking_validation: JSON.stringify(trackingValidation)
    };
    
    try {
      const response = await fetch(`/api/carriers/${carrierId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        alert("‚úì Carrier Einstellungen gespeichert!");
        // Carrier neu laden
        await loadCarriers();
        
        // Wenn dieser Carrier gerade aktiv ist, Felder sofort aktualisieren
        if (currentCarrier && currentCarrier.id == carrierId) {
          // Carrier-Daten aktualisieren
          const updatedCarrier = carriersData.find(c => c.id == carrierId);
          if (updatedCarrier) {
            currentCarrier = updatedCarrier;
            applyVisibleFields(updatedCarrier);
          }
        }
      } else {
        alert("‚ùå Fehler beim Speichern!");
      }
    } catch (err) {
      console.error("Fehler beim Speichern:", err);
      alert("Fehler: " + err.message);
    }
  }

  // Label-Bild-Felder verwalten
  function loadLabelImageFields(imagePaths) {
    const container = document.getElementById("labelImagesContainer");
    if (!container) return;
    
    container.innerHTML = '';
    
    if (imagePaths && imagePaths.length > 0) {
      imagePaths.forEach((path, index) => {
        addLabelImageField(path);
      });
    } else {
      // Mindestens ein leeres Feld anzeigen
      addLabelImageField('');
    }
  }

  function addLabelImageField(value = '') {
    const container = document.getElementById("labelImagesContainer");
    if (!container) return;
    
    const fieldId = `labelImage_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const fieldDiv = document.createElement('div');
    fieldDiv.style.display = 'flex';
    fieldDiv.style.gap = '8px';
    fieldDiv.style.alignItems = 'center';
    fieldDiv.id = fieldId;
    
    fieldDiv.innerHTML = `
      <input type="text" 
             class="label-image-input" 
             value="${value}" 
             placeholder="/images/CarrierLabels/FedEx.png" 
             style="flex: 1; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; background: var(--bg-card); color: var(--text-main);">
      <button type="button" 
              class="btn btn-ghost btn-sm" 
              onclick="removeLabelImageField('${fieldId}')" 
              style="padding: 8px 12px;">
        ‚úï
      </button>
    `;
    
    container.appendChild(fieldDiv);
  }

  function removeLabelImageField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
      field.remove();
      
      // Wenn kein Feld mehr vorhanden ist, ein leeres hinzuf√ºgen
      const container = document.getElementById("labelImagesContainer");
      if (container && container.children.length === 0) {
        addLabelImageField('');
      }
    }
  }

  function getLabelImageValues() {
    const container = document.getElementById("labelImagesContainer");
    if (!container) return [];
    
    const inputs = container.querySelectorAll('.label-image-input');
    return Array.from(inputs)
      .map(input => input.value.trim())
      .filter(value => value.length > 0);
  }

  function backToCarrierSelectionSettings() {
    // Carrier-Einstellungen ausblenden
    const carrierSettingsForm = document.getElementById("carrierSettingsForm");
    if (carrierSettingsForm) {
      carrierSettingsForm.style.display = "none";
    }
    
    // Carrier-Auswahl wieder anzeigen
    const carrierSelectionHint = document.getElementById("carrierSelectionHint");
    if (carrierSelectionHint) {
      carrierSelectionHint.style.display = "block";
    }
    
    // Carrier-Auswahl zur√ºcksetzen
    const carrierSelect = document.getElementById("settingsCarrierSelect");
    if (carrierSelect) {
      carrierSelect.value = "";
      carrierSelect.removeAttribute('data-value');
    }
    
    // Dropdown-Liste leeren
    const dropdownList = document.getElementById("settingsCarrierDropdownList");
    if (dropdownList) {
      dropdownList.innerHTML = "";
    }
  }

  async function loadDropdownOptionsSettings() {
    // Area Optionen
    try {
      const areaResponse = await fetch("/api/dropdown-options/area");
      if (areaResponse.ok) {
        const options = await areaResponse.json();
        const container = document.getElementById("areaOptionsList");
        if (container) {
          container.innerHTML = "";
          options.forEach((opt, index) => {
            const div = document.createElement("div");
            div.className = "dropdown-option-item";
            div.setAttribute("data-id", opt.id);
            div.setAttribute("draggable", "true");
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.alignItems = "center";
            div.style.padding = "4px 8px";
            div.style.background = "var(--bg-soft)";
            div.style.borderRadius = "6px";
            div.style.marginBottom = "4px";
            div.style.cursor = "move";
            div.title = "Ziehen zum Verschieben, Doppelklick zum Bearbeiten";
            
            // Drag Handle
            const dragHandle = document.createElement("span");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
            dragHandle.style.marginRight = "8px";
            
            const span = document.createElement("span");
            span.style.fontSize = "12px";
            span.style.flex = "1";
            span.textContent = opt.option_label;
            
            // Doppelklick zum Bearbeiten
            span.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              editDropdownOption(opt.id, opt.option_label, 'area', span);
            });
            
            const btn = document.createElement("button");
            btn.className = "btn btn-ghost btn-sm";
            btn.textContent = "√ó";
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              deleteDropdownOption(opt.id, 'area');
            });
            
            div.appendChild(dragHandle);
            div.appendChild(span);
            div.appendChild(btn);
            container.appendChild(div);
            
            // Drag Events
            setupDragAndDrop(div, container, 'area');
          });
        }
      }
      
      // Land Optionen
      const landResponse = await fetch("/api/dropdown-options/land");
      if (landResponse.ok) {
        const options = await landResponse.json();
        const container = document.getElementById("landOptionsList");
        if (container) {
          container.innerHTML = "";
          options.forEach((opt, index) => {
            const div = document.createElement("div");
            div.className = "dropdown-option-item";
            div.setAttribute("data-id", opt.id);
            div.setAttribute("draggable", "true");
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.alignItems = "center";
            div.style.padding = "4px 8px";
            div.style.background = "var(--bg-soft)";
            div.style.borderRadius = "6px";
            div.style.marginBottom = "4px";
            div.style.cursor = "move";
            div.title = "Ziehen zum Verschieben, Doppelklick zum Bearbeiten";
            
            // Drag Handle
            const dragHandle = document.createElement("span");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
            dragHandle.style.marginRight = "8px";
            
            const span = document.createElement("span");
            span.style.fontSize = "12px";
            span.style.flex = "1";
            span.textContent = `${opt.option_value} - ${opt.option_label}`;
            
            // Doppelklick zum Bearbeiten
            span.addEventListener("dblclick", (e) => {
              e.stopPropagation();
              editDropdownOption(opt.id, opt.option_label, 'land', span);
            });
            
            const btn = document.createElement("button");
            btn.className = "btn btn-ghost btn-sm";
            btn.textContent = "√ó";
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              deleteDropdownOption(opt.id, 'land');
            });
            
            div.appendChild(dragHandle);
            div.appendChild(span);
            div.appendChild(btn);
            container.appendChild(div);
            
            // Drag Events
            setupDragAndDrop(div, container, 'land');
          });
        }
      }
    } catch (err) {
      console.error("Fehler beim Laden Dropdown Optionen:", err);
    }
  }

  async function addDropdownOption(fieldName) {
    let value, label;
    
    if (fieldName === "area") {
      value = document.getElementById("newAreaOption").value.trim();
      label = value;
      if (!value) {
        alert("Bitte geben Sie eine Area Option ein!");
        return;
      }
    } else if (fieldName === "land") {
      value = document.getElementById("newLandValue").value.trim();
      label = document.getElementById("newLandLabel").value.trim();
      if (!value || !label) {
        alert("Bitte f√ºllen Sie beide Felder aus!");
        return;
      }
    }
    
    try {
      const response = await fetch("/api/dropdown-options", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          field_name: fieldName,
          option_value: value,
          option_label: label,
          sort_order: 999
        })
      });
      
      if (response.ok) {
        if (fieldName === "area") {
          document.getElementById("newAreaOption").value = "";
        } else {
          document.getElementById("newLandValue").value = "";
          document.getElementById("newLandLabel").value = "";
        }
        loadDropdownOptionsSettings();
        loadDropdownOptions(); // Auch die Haupt-Dropdowns aktualisieren
      } else {
        alert("‚ùå Fehler beim Hinzuf√ºgen!");
      }
    } catch (err) {
      console.error("Fehler:", err);
      alert("Fehler: " + err.message);
    }
  }

  function setupDragAndDrop(element, container, fieldName) {
    let draggedElement = null;
    
    element.addEventListener("dragstart", (e) => {
      draggedElement = element;
      element.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/html", element.innerHTML);
    });
    
    element.addEventListener("dragend", (e) => {
      element.classList.remove("dragging");
      
      // Neue Reihenfolge speichern
      const items = Array.from(container.querySelectorAll(".dropdown-option-item"));
      const orderedIds = items.map(item => parseInt(item.getAttribute("data-id")));
      saveDropdownOrder(fieldName, orderedIds);
    });
    
    element.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      
      const afterElement = getDragAfterElement(container, e.clientY);
      const dragging = container.querySelector(".dragging");
      
      if (afterElement == null) {
        container.appendChild(dragging);
      } else {
        container.insertBefore(dragging, afterElement);
      }
    });
    
    element.addEventListener("dragenter", (e) => {
      if (element !== draggedElement) {
        element.classList.add("drag-over");
      }
    });
    
    element.addEventListener("dragleave", (e) => {
      element.classList.remove("drag-over");
    });
    
    element.addEventListener("drop", (e) => {
      e.stopPropagation();
      element.classList.remove("drag-over");
      return false;
    });
  }
  
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll(".dropdown-option-item:not(.dragging)")];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
  
  async function saveDropdownOrder(fieldName, orderedIds) {
    try {
      const response = await fetch(`/api/dropdown-options/reorder/${fieldName}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderedIds })
      });
      
      if (response.ok) {
        console.log(`‚úÖ Reihenfolge f√ºr ${fieldName} gespeichert`);
        // Dropdowns im Hauptformular neu laden
        await loadDropdownOptions();
      } else {
        console.error("Fehler beim Speichern der Reihenfolge");
      }
    } catch (err) {
      console.error("Fehler beim Speichern der Reihenfolge:", err);
    }
  }

  async function editDropdownOption(id, currentLabel, fieldName, spanElement) {
    // Pr√ºfe ob bereits ein Edit l√§uft
    if (spanElement.querySelector("input")) {
      return;
    }
    
    // Erstelle ein Inline-Edit-Feld
    const input = document.createElement("input");
    input.type = "text";
    input.value = currentLabel;
    input.style.fontSize = "12px";
    input.style.padding = "2px 6px";
    input.style.border = "1px solid var(--gxo-orange)";
    input.style.borderRadius = "4px";
    input.style.background = "var(--bg-main)";
    input.style.color = "var(--text-primary)";
    input.style.width = "200px";
    input.style.outline = "none";
    
    // Ersetze den Text tempor√§r
    const originalText = spanElement.textContent;
    spanElement.textContent = "";
    spanElement.appendChild(input);
    input.focus();
    input.select();
    
    let isSaving = false;
    
    // Funktion zum Speichern
    const saveEdit = async () => {
      if (isSaving) return;
      isSaving = true;
      
      const newLabel = input.value.trim();
      
      if (!newLabel) {
        alert("‚ùå Der Wert darf nicht leer sein!");
        spanElement.textContent = originalText;
        return;
      }
      
      if (newLabel === currentLabel) {
        // Keine √Ñnderung
        spanElement.textContent = originalText;
        return;
      }
      
      try {
        const response = await fetch(`/api/dropdown-options/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ option_label: newLabel })
        });
        
        if (response.ok) {
          // Aktualisiere nur den Text, ohne die Liste neu zu laden
          if (fieldName === 'land') {
            // Bei Land: Format "value - label" beibehalten
            const parts = originalText.split(' - ');
            spanElement.textContent = parts[0] + ' - ' + newLabel;
          } else {
            spanElement.textContent = newLabel;
          }
          // Dropdowns im Hauptformular neu laden
          await loadDropdownOptions();
        } else {
          const error = await response.json().catch(() => ({}));
          alert("‚ùå Fehler beim Speichern: " + (error.error || "Unbekannter Fehler"));
          spanElement.textContent = originalText;
        }
      } catch (err) {
        console.error("Fehler beim Speichern:", err);
        alert("‚ùå Fehler: " + err.message);
        spanElement.textContent = originalText;
      }
    };
    
    // Funktion zum Abbrechen
    const cancelEdit = () => {
      spanElement.textContent = originalText;
    };
    
    // Enter zum Speichern
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveEdit();
      } else if (e.key === "Escape") {
        e.preventDefault();
        cancelEdit();
      }
    });
    
    // Blur zum Speichern
    input.addEventListener("blur", () => {
      setTimeout(saveEdit, 100);
    });
  }

  // Custom Modal Funktionen
  function showModal(message, type = 'info', title = null) {
    return new Promise((resolve) => {
      const modal = document.getElementById('customModal');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const modalOkBtn = document.getElementById('modalOkBtn');
      const modalCancelBtn = document.getElementById('modalCancelBtn');
      const modalClose = document.getElementById('modalClose');
      
      // Icon und Titel basierend auf Typ
      const types = {
        'success': { icon: '‚úÖ', title: 'Erfolg', color: '#4CAF50' },
        'error': { icon: '‚ùå', title: 'Fehler', color: '#F44336' },
        'warning': { icon: '‚ö†Ô∏è', title: 'Warnung', color: '#FF9800' },
        'info': { icon: '‚ÑπÔ∏è', title: 'Information', color: '#2196F3' },
        'question': { icon: '‚ùì', title: 'Best√§tigung', color: '#FF3A00' }
      };
      
      const config = types[type] || types.info;
      modalIcon.textContent = config.icon;
      modalTitle.textContent = title || config.title;
      modalBody.innerHTML = message;
      
      // F√ºr Fehler-Modals: H√∂chsten z-index setzen und sicherstellen, dass es ganz vorne ist
      if (type === 'error') {
        modal.classList.add('error-modal');
        modal.style.zIndex = '9999999';
        // Stelle sicher, dass alle anderen Modals/Overlays niedrigeren z-index haben
        const allModals = document.querySelectorAll('.custom-modal, #editModalOverlay, .modal-overlay');
        allModals.forEach(m => {
          if (m !== modal && m.id !== 'customModal') {
            m.style.zIndex = '10000';
          }
        });
        // Stelle sicher, dass es ganz oben im DOM ist (wird zuletzt gerendert)
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
        document.body.appendChild(modal);
      } else {
        modal.classList.remove('error-modal');
        modal.style.zIndex = '';
      }
      
      // Zeige/Verstecke Abbrechen-Button
      if (type === 'question') {
        modalCancelBtn.style.display = '';
      } else {
        modalCancelBtn.style.display = 'none';
      }
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Event Handlers
      const closeModal = (result) => {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        resolve(result);
      };
      
      modalOkBtn.onclick = () => closeModal(true);
      modalCancelBtn.onclick = () => closeModal(false);
      modalClose.onclick = () => closeModal(false);
      
      // ESC zum Schlie√üen
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          closeModal(false);
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
      
      // Klick au√üerhalb schlie√üt Modal
      modal.onclick = (e) => {
        if (e.target === modal) {
          closeModal(false);
        }
      };
    });
  }
  
  // Ersatz f√ºr alert()
  window.customAlert = (message, type = 'info') => showModal(message, type);
  
  // Ersatz f√ºr confirm()
  window.customConfirm = (message) => showModal(message, 'question', 'Best√§tigung');
  
  // Audit-Logs Funktionen global verf√ºgbar machen
  window.loadAuditLogs = loadAuditLogs;
  window.filterAuditLogs = filterAuditLogs;
  window.filterByInboundId = filterByInboundId;
  window.showInboundEntryDetails = showInboundEntryDetails;
  window.addLabelImageField = addLabelImageField;
  window.removeLabelImageField = removeLabelImageField;
  window.backToCarrierSelectionSettings = backToCarrierSelectionSettings;
  window.switchMoveMode = switchMoveMode;
  window.executeSingleMove = executeSingleMove;
  window.selectAllCartons = selectAllCartons;
  window.deselectAllCartons = deselectAllCartons;
  window.executeBulkMove = executeBulkMove;
  window.loadMovementHistory = loadMovementHistory;
  window.clearMoveForm = clearMoveForm;
  
  // √úberschreibe native alert() und confirm()
  window.alert = function(message) {
    let type = 'info';
    if (message.includes('‚úì') || message.includes('Erfolg')) type = 'success';
    else if (message.includes('‚ùå') || message.includes('Fehler')) type = 'error';
    else if (message.includes('‚ö†Ô∏è') || message.includes('Warnung')) type = 'warning';
    
    return showModal(message, type);
  };
  
  window.confirm = function(message) {
    return showModal(message, 'question', 'Best√§tigung');
  };

  function setupImageLightbox() {
    const lightbox = document.getElementById("imageLightbox");
    const lightboxImage = document.getElementById("lightboxImage");
    const closeBtn = document.querySelector(".lightbox-close");
    
    if (!lightbox || !lightboxImage) return;
    
    // Event Delegation f√ºr dynamisch erstellte Bilder
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("label-image-thumbnail")) {
        if (e.target.src && e.target.src !== "") {
          lightboxImage.src = e.target.src;
          lightbox.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }
    });
    
    // Schlie√üe Lightbox beim Klick auf X
    if (closeBtn) {
      closeBtn.addEventListener("click", closeLightbox);
    }
    
    // Schlie√üe Lightbox beim Klick auf den Hintergrund
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });
    
    // Schlie√üe Lightbox mit ESC-Taste
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && lightbox.classList.contains("active")) {
        closeLightbox();
      }
    });
    
    function closeLightbox() {
      lightbox.classList.remove("active");
      document.body.style.overflow = "";
    }
  }

  async function deleteDropdownOption(id, fieldName) {
    console.log("L√∂sche Dropdown Option:", id, fieldName);
    
    if (!confirm(`Wirklich l√∂schen?`)) return;
    
    try {
      const response = await fetch(`/api/dropdown-options/${id}`, {
        method: "DELETE"
      });
      
      if (response.ok) {
        console.log("Erfolgreich gel√∂scht");
        // Beide Listen neu laden
        await loadDropdownOptionsSettings();
        await loadDropdownOptions();
      } else {
        const error = await response.json().catch(() => ({}));
        console.error("Fehler beim L√∂schen:", error);
        alert("‚ùå Fehler beim L√∂schen: " + (error.error || "Unbekannter Fehler"));
      }
    } catch (err) {
      console.error("Fehler beim L√∂schen:", err);
      alert("‚ùå Fehler: " + err.message);
    }
  }

  // ========== Umlagerungs-System ==========
  let moveMode = 'single';
  let moveLocationsData = [];
  
  // Modus wechseln
  function switchMoveMode(mode) {
    moveMode = mode;
    const singleView = document.getElementById('moveSingleView');
    const bulkView = document.getElementById('moveBulkView');
    const btnSingle = document.getElementById('btnMoveSingle');
    const btnBulk = document.getElementById('btnMoveBulk');
    
    if (mode === 'single') {
      singleView.style.display = 'block';
      bulkView.style.display = 'none';
      // Aktiver Button: Orange Hintergrund
      btnSingle.style.background = 'var(--gxo-orange)';
      btnSingle.style.color = 'white';
      btnSingle.style.fontWeight = '600';
      // Inaktiver Button: Transparent
      btnBulk.style.background = 'transparent';
      btnBulk.style.color = 'var(--text-main)';
      btnBulk.style.fontWeight = 'normal';
    } else {
      singleView.style.display = 'none';
      bulkView.style.display = 'block';
      // Inaktiver Button: Transparent
      btnSingle.style.background = 'transparent';
      btnSingle.style.color = 'var(--text-main)';
      btnSingle.style.fontWeight = 'normal';
      // Aktiver Button: Orange Hintergrund
      btnBulk.style.background = 'var(--gxo-orange)';
      btnBulk.style.color = 'white';
      btnBulk.style.fontWeight = '600';
    }
    
    clearMoveForm();
    loadMoveLocations();
  }
  
  // Stellpl√§tze f√ºr Umlagerung laden
  async function loadMoveLocations() {
    try {
      const response = await fetch('/api/warehouse/locations?active_only=true');
      if (response.ok) {
        moveLocationsData = await response.json();
        initMoveLocationDropdowns();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Stellpl√§tze:', err);
    }
  }
  
  // Location-Dropdowns initialisieren
  function initMoveLocationDropdowns() {
    initMoveLocationDropdown('moveFromLocation', 'moveFromLocationList', (locationId) => {
      loadInboundEntriesForLocation(locationId, 'moveInboundSelect');
      updateSingleMovePreview();
    });
    initMoveLocationDropdown('moveToLocation', 'moveToLocationList', () => updateSingleMovePreview());
    initMoveLocationDropdown('moveBulkFromLocation', 'moveBulkFromLocationList', (locationId) => {
      loadBulkMovePreview(locationId);
    });
    initMoveLocationDropdown('moveBulkToLocation', 'moveBulkToLocationList', () => updateBulkMovePreview());
  }
  
  // Einzelnes Location-Dropdown initialisieren
  function initMoveLocationDropdown(inputId, listId, onSelect) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    if (!input || !list) return;
    
    const renderOptions = (filter = '') => {
      list.innerHTML = '';
      const filtered = moveLocationsData.filter(loc => 
        loc.code.toLowerCase().includes(filter.toLowerCase()) ||
        (loc.description && loc.description.toLowerCase().includes(filter.toLowerCase()))
      );
      
      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'searchable-dropdown-empty';
        empty.textContent = 'Keine Stellpl√§tze gefunden';
        list.appendChild(empty);
        return;
      }
      
      filtered.forEach(loc => {
        const item = document.createElement('div');
        item.className = 'searchable-dropdown-item';
        item.innerHTML = `<strong>${loc.code}</strong>${loc.description ? ` - ${loc.description}` : ''}`;
        item.onclick = () => {
          input.value = loc.code;
          input.setAttribute('data-value', loc.id);
          list.classList.remove('active');
          if (onSelect) onSelect(loc.id);
        };
        list.appendChild(item);
      });
    };
    
    input.addEventListener('focus', () => {
      list.classList.add('active');
      renderOptions();
    });
    
    input.addEventListener('input', (e) => {
      renderOptions(e.target.value);
      list.classList.add('active');
    });
    
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !list.contains(e.target)) {
        list.classList.remove('active');
      }
    });
  }
  
  // Kartons f√ºr einen Stellplatz laden (als Checkbox-Liste)
  async function loadInboundEntriesForLocation(locationId, selectId) {
    try {
      const container = document.getElementById('moveCartonList');
      const countDisplay = document.getElementById('moveCartonCount');
      
      if (!container) return;
      
      // Wenn locationId null ist, lade Eintr√§ge ohne Stellplatz
      let response;
      if (locationId === null || locationId === 'null') {
        response = await fetch('/api/warehouse/cartons-without-location');
      } else {
        response = await fetch(`/api/warehouse/locations/${locationId}/details`);
      }
      
      if (response.ok) {
        let cartons;
        if (locationId === null || locationId === 'null') {
          cartons = await response.json();
        } else {
          const data = await response.json();
          cartons = data.cartons || [];
        }
        
        if (!cartons || cartons.length === 0) {
          const message = locationId === null || locationId === 'null' 
            ? 'Keine Eintr√§ge ohne Stellplatz gefunden'
            : 'Keine Kartons auf diesem Stellplatz';
          container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">${message}</div>`;
          countDisplay.style.display = 'none';
          updateSingleMovePreview();
          return;
        }
        
        container.innerHTML = '';
        
        cartons.forEach(carton => {
          const item = document.createElement('div');
          item.style.cssText = 'display: flex; align-items: center; padding: 8px; margin-bottom: 4px; border-radius: 4px; transition: background 0.15s ease;';
          item.className = 'carton-select-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = carton.id;
          checkbox.id = `carton-${carton.id}`;
          checkbox.className = 'carton-checkbox';
          checkbox.style.cssText = 'margin-right: 10px; cursor: pointer; accent-color: var(--gxo-orange);';
          checkbox.addEventListener('change', () => {
            updateCartonCount();
            updateSingleMovePreview();
          });
          
          const label = document.createElement('label');
          label.htmlFor = `carton-${carton.id}`;
          label.style.cssText = 'flex: 1; cursor: pointer; font-size: 12px; color: var(--text-main);';
          label.innerHTML = `<strong>#${carton.id}</strong> - ${carton.olpn || carton.carrier_tracking_nr || carton.cw || 'Unbekannt'} <span style="color: var(--text-soft);">(${carton.actual_carton || 0} Kartons)</span>`;
          
          item.appendChild(checkbox);
          item.appendChild(label);
          
          item.addEventListener('mouseenter', () => {
            item.style.background = 'var(--bg-soft)';
          });
          item.addEventListener('mouseleave', () => {
            item.style.background = 'transparent';
          });
          
          container.appendChild(item);
        });
        
        countDisplay.style.display = 'block';
        updateCartonCount();
        updateSingleMovePreview();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Kartons:', err);
      const container = document.getElementById('moveCartonList');
      if (container) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gxo-orange); font-size: 11px;">‚ùå Fehler beim Laden</div>';
      }
    }
  }
  
  // Anzahl ausgew√§hlter Kartons aktualisieren
  function updateCartonCount() {
    const checkboxes = document.querySelectorAll('.carton-checkbox:checked');
    const count = checkboxes.length;
    const countDisplay = document.getElementById('selectedCartonCount');
    if (countDisplay) {
      countDisplay.textContent = count;
    }
  }
  
  // Alle Kartons ausw√§hlen
  function selectAllCartons() {
    const checkboxes = document.querySelectorAll('.carton-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    updateCartonCount();
    updateSingleMovePreview();
  }
  
  // Alle Kartons abw√§hlen
  function deselectAllCartons() {
    const checkboxes = document.querySelectorAll('.carton-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateCartonCount();
    updateSingleMovePreview();
  }
  
  // Vorschau f√ºr Einzelbuchung aktualisieren
  function updateSingleMovePreview() {
    const fromLocationId = document.getElementById('moveFromLocation')?.getAttribute('data-value');
    const toLocationId = document.getElementById('moveToLocation')?.getAttribute('data-value');
    const checkboxes = document.querySelectorAll('.carton-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    const preview = document.getElementById('moveSinglePreview');
    const previewContent = document.getElementById('moveSinglePreviewContent');
    const btn = document.getElementById('btnExecuteSingleMove');
    
    if (fromLocationId && toLocationId && selectedIds.length > 0) {
      const fromLocation = moveLocationsData.find(l => l.id == fromLocationId);
      const toLocation = moveLocationsData.find(l => l.id == toLocationId);
      
      previewContent.innerHTML = `
        <div><strong>Von:</strong> ${fromLocation?.code || 'Unbekannt'}</div>
        <div><strong>Nach:</strong> ${toLocation?.code || 'Unbekannt'}</div>
        <div><strong>Anzahl Kartons:</strong> ${selectedIds.length}</div>
        <div style="margin-top: 6px; font-size: 11px; color: var(--text-soft);">IDs: ${selectedIds.slice(0, 5).join(', ')}${selectedIds.length > 5 ? '...' : ''}</div>
      `;
      preview.style.display = 'block';
      btn.disabled = false;
    } else {
      preview.style.display = 'none';
      btn.disabled = true;
    }
  }
  
  // Vorschau f√ºr Massenbuchung laden
  async function loadBulkMovePreview(locationId) {
    try {
      const response = await fetch(`/api/warehouse/locations/${locationId}/details`);
      if (response.ok) {
        const data = await response.json();
        const preview = document.getElementById('moveBulkPreview');
        const previewContent = document.getElementById('moveBulkPreviewContent');
        
        previewContent.innerHTML = `
          <div><strong>Von:</strong> ${data.location.code}</div>
          <div><strong>Anzahl Eintr√§ge:</strong> ${data.cartons.length}</div>
          <div><strong>Gesamt Kartons:</strong> ${data.total_cartons}</div>
        `;
        preview.style.display = 'block';
        updateBulkMovePreview();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Vorschau:', err);
    }
  }
  
  // Vorschau f√ºr Massenbuchung aktualisieren
  function updateBulkMovePreview() {
    const fromLocationId = document.getElementById('moveBulkFromLocation')?.getAttribute('data-value');
    const toLocationId = document.getElementById('moveBulkToLocation')?.getAttribute('data-value');
    const btn = document.getElementById('btnExecuteBulkMove');
    
    if (fromLocationId && toLocationId) {
      btn.disabled = false;
    } else {
      btn.disabled = true;
    }
  }
  
  // Einzelbuchung durchf√ºhren (mehrere Kartons)
  async function executeSingleMove() {
    const noLocationCheckbox = document.getElementById('moveFromNoLocation');
    const fromLocationId = noLocationCheckbox?.checked ? null : document.getElementById('moveFromLocation')?.getAttribute('data-value');
    const toLocationId = document.getElementById('moveToLocation')?.getAttribute('data-value');
    const checkboxes = document.querySelectorAll('.carton-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    const reason = document.getElementById('moveReason')?.value;
    
    if ((!fromLocationId && !noLocationCheckbox?.checked) || !toLocationId || selectedIds.length === 0) {
      showCustomModal('‚ùå Bitte w√§hlen Sie mindestens einen Karton aus', 'error');
      return;
    }
    
    // Best√§tigung
    const confirmed = await new Promise(resolve => {
      showCustomModal(
        `‚ö†Ô∏è M√∂chten Sie wirklich ${selectedIds.length} Karton${selectedIds.length > 1 ? 's' : ''} umlagern?`,
        'question',
        'Best√§tigung',
        () => resolve(true),
        () => resolve(false)
      );
    });
    
    if (!confirmed) return;
    
    // Benutzername abrufen
    let movedBy = 'System';
    try {
      const userResponse = await fetch('/api/current-user');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        movedBy = userData.username || 'System';
      }
    } catch (e) {
      console.warn('Konnte Benutzername nicht abrufen:', e);
    }
    
    try {
      const response = await fetch('/api/movement/multiple', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          inbound_ids: selectedIds,
          from_location_id: fromLocationId === 'null' || fromLocationId === null ? null : parseInt(fromLocationId),
          to_location_id: parseInt(toLocationId),
          moved_by: movedBy,
          reason: reason || null
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        showCustomModal(`‚úÖ Umlagerung erfolgreich: ${result.moved_count} Karton${result.moved_count > 1 ? 's' : ''} verschoben!`, 'success');
        clearMoveForm();
        loadMovementHistory();
        // Stellplatz-Daten aktualisieren falls auf Lager-Seite
        if (typeof loadWarehouseData === 'function') {
          loadWarehouseData();
        }
      } else {
        showCustomModal(`‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}`, 'error');
      }
    } catch (err) {
      console.error('Fehler bei Umlagerung:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Massenbuchung durchf√ºhren
  async function executeBulkMove() {
    const fromLocationId = document.getElementById('moveBulkFromLocation')?.getAttribute('data-value');
    const toLocationId = document.getElementById('moveBulkToLocation')?.getAttribute('data-value');
    const reason = document.getElementById('moveBulkReason')?.value;
    
    if (!fromLocationId || !toLocationId) {
      showCustomModal('‚ùå Bitte w√§hlen Sie Quell- und Ziel-Stellplatz aus', 'error');
      return;
    }
    
    if (fromLocationId === toLocationId) {
      showCustomModal('‚ùå Quell- und Ziel-Stellplatz d√ºrfen nicht identisch sein', 'error');
      return;
    }
    
    // Best√§tigung
    const confirmed = await new Promise(resolve => {
      showCustomModal(
        '‚ö†Ô∏è M√∂chten Sie wirklich ALLE Kartons von diesem Stellplatz umlagern?',
        'question',
        'Best√§tigung',
        () => resolve(true),
        () => resolve(false)
      );
    });
    
    if (!confirmed) return;
    
    // Benutzername abrufen
    let movedBy = 'System';
    try {
      const userResponse = await fetch('/api/current-user');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        movedBy = userData.username || 'System';
      }
    } catch (e) {
      console.warn('Konnte Benutzername nicht abrufen:', e);
    }
    
    try {
      const response = await fetch('/api/movement/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from_location_id: parseInt(fromLocationId),
          to_location_id: parseInt(toLocationId),
          moved_by: movedBy,
          reason: reason || null
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        showCustomModal(`‚úÖ Massen-Umlagerung erfolgreich: ${result.moved_count} Eintr√§ge verschoben!`, 'success');
        clearMoveForm();
        loadMovementHistory();
        // Stellplatz-Daten aktualisieren falls auf Lager-Seite
        if (typeof loadWarehouseData === 'function') {
          loadWarehouseData();
        }
      } else {
        showCustomModal(`‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}`, 'error');
      }
    } catch (err) {
      console.error('Fehler bei Massen-Umlagerung:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Umlagerungs-Historie laden
  async function loadMovementHistory() {
    const tbody = document.getElementById('movementHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üîÑ Lade Historie...</td></tr>';
    
    try {
      const response = await fetch('/api/movement/history?limit=50');
      if (response.ok) {
        const history = await response.json();
        
        if (history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üìã Keine Umlagerungen gefunden</td></tr>';
          return;
        }
        
        tbody.innerHTML = history.map(m => {
          const movedAt = m.moved_at ? new Date(m.moved_at).toLocaleString('de-DE') : '-';
          // OLPN hat Priorit√§t, falls nicht vorhanden dann Carrier Tracking Number
          const trackingNumber = m.olpn || m.carrier_tracking_nr || '-';
          return `
            <tr style="border-bottom: 1px solid var(--border-soft);">
              <td style="padding: 6px 8px; font-size: 11px;">${movedAt}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.from_location_code || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.to_location_code || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;"><span style="color: var(--gxo-orange);">#${m.inbound_id || '-'}</span></td>
              <td style="padding: 6px 8px; font-size: 11px;">${trackingNumber}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.reason || '-'}</td>
            </tr>
          `;
        }).join('');
      }
    } catch (err) {
      console.error('Fehler beim Laden der Historie:', err);
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--gxo-orange); font-size: 11px;">‚ùå Fehler beim Laden der Daten</td></tr>';
    }
  }
  
  // ========== ALLE BEWEGUNGEN (JOURNAL) ==========
  
  async function loadAllMovements() {
    const tbody = document.getElementById('allMovementsBody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üîÑ Lade Bewegungen...</td></tr>';
    
    try {
      const response = await fetch('/api/movements/all?limit=100');
      if (response.ok) {
        const movements = await response.json();
        
        if (movements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üìã Keine Bewegungen gefunden</td></tr>';
          return;
        }
        
        tbody.innerHTML = movements.map(m => {
          const timestamp = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '-';
          const date = m.timestamp ? new Date(m.timestamp).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) : '';
          const fullTime = m.timestamp ? `${date} ${timestamp}` : '-';
          
          // Badge basierend auf Typ
          let badgeClass = 'badge badge-soft';
          if (m.type === 'Wareneingang') {
            badgeClass = 'badge badge-ok';
          }
          
          return `
            <tr class="data-row" style="border-bottom: 1px solid var(--border-soft);">
              <td style="padding: 6px 8px; font-size: 11px;">${fullTime}</td>
              <td style="padding: 6px 8px; font-size: 11px;"><span class="${badgeClass}">${m.type}</span></td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.object || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.from_location || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.to_location || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${m.user || '-'}</td>
            </tr>
          `;
        }).join('');
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (err) {
      console.error('Fehler beim Laden der Bewegungen:', err);
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--gxo-orange); font-size: 11px;">‚ùå Fehler beim Laden der Daten</td></tr>';
    }
  }
  
  // Funktion global verf√ºgbar machen
  window.loadAllMovements = loadAllMovements;
  
  // Beim ersten Laden, wenn Dashboard aktiv ist
  if (document.getElementById('view-dashboard')?.classList.contains('active')) {
    setTimeout(() => {
      loadAllMovements();
    }, 500);
  }
  
  // ========== ARCHIVIERUNG ==========
  
  // Stellpl√§tze f√ºr Archivierung laden
  let archiveLocationsCache = null;
  async function loadArchiveLocations() {
    const dropdown = document.getElementById('archiveLocationDropdown');
    const input = document.getElementById('archiveLocation');
    const list = document.getElementById('archiveLocationList');
    
    if (!dropdown || !input || !list) return;
    
    // Wenn bereits geladen, nur anzeigen
    if (archiveLocationsCache && list.querySelectorAll('.searchable-dropdown-item').length > 0) {
      list.classList.add('active');
      return;
    }
    
    try {
      const response = await fetch('/api/warehouse/locations?active_only=true');
      if (response.ok) {
        const locations = await response.json();
        archiveLocationsCache = locations;
        
        // Nur Stellpl√§tze mit Kartons anzeigen
        const locationsWithCartons = locations.filter(loc => loc.carton_count > 0);
        
        list.innerHTML = '';
        
        if (locationsWithCartons.length === 0) {
          list.innerHTML = '<div class="searchable-dropdown-empty">Keine Stellpl√§tze mit Kartons gefunden</div>';
          list.classList.add('active');
          return;
        }
        
        locationsWithCartons.forEach(loc => {
          const item = document.createElement('div');
          item.className = 'searchable-dropdown-item';
          item.textContent = `${loc.code} - ${loc.carton_count} Kartons`;
          item.setAttribute('data-value', loc.id);
          item.setAttribute('data-code', loc.code);
          item.onclick = () => {
            input.value = loc.code;
            input.setAttribute('data-value', loc.id);
            list.classList.remove('active');
            loadArchiveInbounds(loc.id);
          };
          list.appendChild(item);
        });
        
        list.classList.add('active');
      }
    } catch (err) {
      console.error('Fehler beim Laden der Stellpl√§tze:', err);
      list.innerHTML = '<div class="searchable-dropdown-empty">‚ùå Fehler beim Laden</div>';
    }
  }
  
  // Kartons f√ºr Archivierung laden
  async function loadArchiveInbounds(locationId) {
    const select = document.getElementById('archiveInboundSelect');
    if (!select || !locationId) return;
    
    select.innerHTML = '<option value="">üîÑ Lade Kartons...</option>';
    select.disabled = true;
    
    try {
      const response = await fetch(`/api/warehouse/locations/${locationId}/details`);
      if (response.ok) {
        const data = await response.json();
        const cartons = data.cartons || [];
        
        select.innerHTML = '';
        
        if (cartons.length === 0) {
          select.innerHTML = '<option value="">Keine Kartons auf diesem Stellplatz</option>';
          select.selectedIndex = 0;
          select.value = '';
          select.disabled = false;
          updateArchivePreview();
          return;
        }
        
        // Leere Option zuerst hinzuf√ºgen
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Bitte Karton ausw√§hlen --';
        select.appendChild(emptyOption);
        
        cartons.forEach(carton => {
          const option = document.createElement('option');
          option.value = carton.id;
          const displayText = `#${carton.id} - ${carton.olpn || carton.carrier_tracking_nr || 'Keine Nummer'} - ${carton.carrier_name || 'Unbekannt'}`;
          option.textContent = displayText;
          select.appendChild(option);
        });
        
        // Sicherstellen, dass nichts ausgew√§hlt ist
        select.selectedIndex = 0;
        select.value = '';
        select.disabled = false;
        updateArchivePreview();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Kartons:', err);
      select.innerHTML = '<option value="">‚ùå Fehler beim Laden</option>';
    }
  }
  
  // Vorschau aktualisieren
  function updateArchivePreview() {
    const select = document.getElementById('archiveInboundSelect');
    const reason = document.getElementById('archiveReason')?.value;
    const preview = document.getElementById('archivePreview');
    const previewContent = document.getElementById('archivePreviewContent');
    
    if (!select || !preview || !previewContent) return;
    
    // Pr√ºfen ob wirklich ein Wert ausgew√§hlt ist (nicht die leere Option)
    const hasSelection = select.value && select.value !== '' && select.selectedIndex > 0;
    const selectedOption = select.options[select.selectedIndex];
    
    if (hasSelection && reason && reason.trim() !== '') {
      previewContent.innerHTML = `
        <div><strong>Karton:</strong> ${selectedOption.textContent}</div>
        <div><strong>Grund:</strong> ${reason}</div>
      `;
      preview.style.display = 'block';
      document.getElementById('btnExecuteArchive').disabled = false;
    } else {
      preview.style.display = 'none';
      document.getElementById('btnExecuteArchive').disabled = true;
    }
  }
  
  // Archivierung durchf√ºhren
  async function executeArchive() {
    const noLocationCheckbox = document.getElementById('archiveNoLocation');
    const locationId = noLocationCheckbox?.checked ? null : document.getElementById('archiveLocation')?.getAttribute('data-value');
    const inboundId = document.getElementById('archiveInboundSelect')?.value;
    const reason = document.getElementById('archiveReason')?.value;
    const notes = document.getElementById('archiveNotes')?.value;
    
    if (!inboundId || !reason || reason.trim() === '') {
      showCustomModal('‚ùå Bitte f√ºllen Sie alle Pflichtfelder aus', 'error');
      return;
    }
    
    // Best√§tigung
    const confirmed = await new Promise(resolve => {
      showCustomModal(
        '‚ö†Ô∏è M√∂chten Sie diesen Eintrag wirklich ins Archiv lagern?',
        'question',
        'Best√§tigung',
        () => resolve(true),
        () => resolve(false)
      );
    });
    
    if (!confirmed) return;
    
    // Benutzername abrufen
    let archivedBy = 'System';
    try {
      const userResponse = await fetch('/api/current-user');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        archivedBy = userData.username || 'System';
      }
    } catch (e) {
      console.warn('Konnte Benutzername nicht abrufen:', e);
    }
    
    try {
      const response = await fetch('/api/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          inbound_id: parseInt(inboundId),
          reason: reason.trim(),
          notes: notes || null,
          archived_by: archivedBy
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        showCustomModal('‚úÖ Eintrag erfolgreich ins Archiv gelagert!', 'success');
        clearArchiveForm();
        loadArchiveList();
        // Stellplatz-Daten aktualisieren falls auf Lager-Seite
        if (typeof loadWarehouseData === 'function') {
          loadWarehouseData();
        }
      } else {
        showCustomModal(`‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}`, 'error');
      }
    } catch (err) {
      console.error('Fehler bei Archivierung:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Archiv-Liste laden
  async function loadArchiveList() {
    const tbody = document.getElementById('archiveListBody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üîÑ Lade Archiv...</td></tr>';
    
    try {
      const response = await fetch('/api/archive?limit=100');
      if (response.ok) {
        const archive = await response.json();
        
        if (archive.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 11px;">üìã Keine archivierten Eintr√§ge gefunden</td></tr>';
          return;
        }
        
        tbody.innerHTML = archive.map(a => {
          const archivedAt = a.archived_at ? new Date(a.archived_at).toLocaleString('de-DE') : '-';
          const trackingNumber = a.olpn || a.carrier_tracking_nr || '-';
          return `
            <tr style="border-bottom: 1px solid var(--border-soft);">
              <td style="padding: 6px 8px; font-size: 11px;">${archivedAt}</td>
              <td style="padding: 6px 8px; font-size: 11px;"><span style="color: var(--gxo-orange);">#${a.inbound_id || '-'}</span></td>
              <td style="padding: 6px 8px; font-size: 11px;">${a.location_code || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${trackingNumber}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${a.carrier_name || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${a.reason || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">${a.archived_by || '-'}</td>
              <td style="padding: 6px 8px; font-size: 11px;">
                <button class="btn btn-secondary btn-sm" onclick="showRestoreArchiveModal(${a.id}, ${a.inbound_id || null}, '${(a.location_code || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" style="padding: 4px 8px; font-size: 10px;">‚Ü©Ô∏è Zur√ºckbuchen</button>
              </td>
            </tr>
          `;
        }).join('');
      }
    } catch (err) {
      console.error('Fehler beim Laden der Archiv-Liste:', err);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--gxo-orange); font-size: 11px;">‚ùå Fehler beim Laden der Daten</td></tr>';
    }
  }
  
  // Modal f√ºr Zur√ºckbuchung aus Archiv anzeigen
  async function showRestoreArchiveModal(archiveId, inboundId, originalLocationCode) {
    // Modal-Body mit Stellplatz-Auswahl erstellen
    const modalBody = document.getElementById('modalBody');
    if (!modalBody) return;
    
    const htmlContent = `
      <div style="margin-bottom: 16px;">
        <div style="font-size: 12px; color: var(--text-soft); margin-bottom: 8px;">
          W√§hlen Sie den Ziel-Stellplatz f√ºr die Zur√ºckbuchung:
        </div>
        ${originalLocationCode ? `<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">
          Urspr√ºnglicher Stellplatz: <strong>${originalLocationCode}</strong>
        </div>` : ''}
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 11px; margin-bottom: 6px; display: block;">üìç Ziel-Stellplatz <span class="required-field">*</span></label>
          <div class="searchable-dropdown" id="restoreLocationDropdown">
            <input type="text" id="restoreLocationInput" placeholder="Stellplatz w√§hlen oder Code eingeben..." autocomplete="off" style="padding: 6px 9px; font-size: 12px; width: 100%;">
            <div class="searchable-dropdown-list" id="restoreLocationList"></div>
          </div>
        </div>
      </div>
    `;
    
    // HTML zuerst setzen
    modalBody.innerHTML = htmlContent;
    
    // Modal anzeigen (mit leerer message, da HTML bereits gesetzt)
    showCustomModal(
      '',
      'question',
      '‚Ü©Ô∏è Aus Archiv zur√ºckbuchen',
      async () => {
        const locationInput = document.getElementById('restoreLocationInput');
        const locationId = locationInput?.getAttribute('data-value');
        
        if (!locationId) {
          showCustomModal('‚ùå Bitte w√§hlen Sie einen Ziel-Stellplatz aus', 'error');
          return;
        }
        
        await restoreFromArchive(archiveId, locationId);
      },
      () => {
        // Abbrechen - nichts tun
      }
    );
    
    // Stellplatz-Dropdown initialisieren
    setTimeout(() => {
      initRestoreLocationDropdown();
    }, 100);
  }
  
  // Stellplatz-Dropdown f√ºr Zur√ºckbuchung initialisieren
  async function initRestoreLocationDropdown() {
    const input = document.getElementById('restoreLocationInput');
    const list = document.getElementById('restoreLocationList');
    
    if (!input || !list) return;
    
    try {
      const response = await fetch("/api/warehouse/locations?active_only=true");
      if (!response.ok) return;
      
      const locations = await response.json();
      
      const renderOptions = (filter = '') => {
        list.innerHTML = '';
        
        const filtered = locations.filter(loc => 
          loc.code.toLowerCase().includes(filter.toLowerCase()) ||
          (loc.description && loc.description.toLowerCase().includes(filter.toLowerCase()))
        );
        
        if (filtered.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'searchable-dropdown-empty';
          empty.textContent = 'Keine Stellpl√§tze gefunden';
          list.appendChild(empty);
          return;
        }
        
        filtered.forEach(loc => {
          const item = document.createElement('div');
          item.className = 'searchable-dropdown-item';
          item.innerHTML = `
            <div style="font-weight: 600;">${loc.code}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${loc.description || ''} ${loc.area ? '‚Ä¢ ' + loc.area : ''}</div>
          `;
          item.setAttribute('data-value', loc.id);
          item.setAttribute('data-label', loc.code);
          
          item.addEventListener('click', () => {
            input.value = loc.code;
            input.setAttribute('data-value', loc.id);
            list.classList.remove('active');
            input.blur();
          });
          
          list.appendChild(item);
        });
      };
      
      input.addEventListener('focus', () => {
        renderOptions();
        list.classList.add('active');
      });
      
      input.addEventListener('input', (e) => {
        renderOptions(e.target.value);
        list.classList.add('active');
      });
      
      // Au√üerhalb klicken schlie√üt Dropdown
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          list.classList.remove('active');
        }
      });
    } catch (err) {
      console.error('Fehler beim Initialisieren des Restore-Location-Dropdowns:', err);
    }
  }
  
  // Aus Archiv wiederherstellen (mit optionalem Ziel-Stellplatz)
  async function restoreFromArchive(archiveId, locationId = null) {
    // Benutzername abrufen
    let restoredBy = 'System';
    try {
      const userResponse = await fetch('/api/current-user');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        restoredBy = userData.username || 'System';
      }
    } catch (e) {
      console.warn('Konnte Benutzername nicht abrufen:', e);
    }
    
    try {
      const response = await fetch('/api/archive/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          archive_id: archiveId,
          location_id: locationId ? parseInt(locationId) : null,
          restored_by: restoredBy
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.ok) {
        showCustomModal('‚úÖ Eintrag erfolgreich zur√ºckgebucht!', 'success');
        loadArchiveList();
        // Stellplatz-Daten aktualisieren falls auf Lager-Seite
        if (typeof loadWarehouseData === 'function') {
          loadWarehouseData();
        }
      } else {
        showCustomModal(`‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}`, 'error');
      }
    } catch (err) {
      console.error('Fehler bei Zur√ºckbuchung:', err);
      showCustomModal(`‚ùå Fehler: ${err.message}`, 'error');
    }
  }
  
  // Archiv-Formular zur√ºcksetzen
  function clearArchiveForm() {
    const noLocationCheckbox = document.getElementById('archiveNoLocation');
    if (noLocationCheckbox) {
      noLocationCheckbox.checked = false;
    }
    const archiveLocationInput = document.getElementById('archiveLocation');
    if (archiveLocationInput) {
      archiveLocationInput.value = '';
      archiveLocationInput.removeAttribute('data-value');
      archiveLocationInput.disabled = false;
    }
    document.getElementById('archiveInboundSelect').innerHTML = '<option value="">-- Bitte zuerst Stellplatz w√§hlen --</option>';
    document.getElementById('archiveReason').value = '';
    document.getElementById('archiveNotes').value = '';
    document.getElementById('archivePreview').style.display = 'none';
    document.getElementById('btnExecuteArchive').disabled = true;
  }
  
  // Event-Listener f√ºr Archivierung
  document.addEventListener('DOMContentLoaded', () => {
    const archiveLocationInput = document.getElementById('archiveLocation');
    const archiveLocationList = document.getElementById('archiveLocationList');
    const archiveInboundSelect = document.getElementById('archiveInboundSelect');
    const archiveReason = document.getElementById('archiveReason');
    
    // Stellplatz-Dropdown
    if (archiveLocationInput) {
      archiveLocationInput.addEventListener('focus', () => {
        loadArchiveLocations();
      });
      archiveLocationInput.addEventListener('click', () => {
        loadArchiveLocations();
      });
      archiveLocationInput.addEventListener('input', (e) => {
        const search = e.target.value.toLowerCase();
        const items = archiveLocationList.querySelectorAll('.searchable-dropdown-item');
        if (items.length === 0) {
          // Wenn keine Items vorhanden, neu laden
          loadArchiveLocations();
        } else {
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(search)) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          });
          archiveLocationList.classList.add('active');
        }
      });
      
      archiveLocationInput.addEventListener('blur', () => {
        setTimeout(() => {
          archiveLocationList.classList.remove('active');
        }, 200);
      });
    }
    
    // Karton-Auswahl und Grund √§ndern ‚Üí Vorschau aktualisieren
    if (archiveInboundSelect) {
      archiveInboundSelect.addEventListener('change', updateArchivePreview);
    }
    if (archiveReason) {
      archiveReason.addEventListener('input', updateArchivePreview);
    }
    
    // Archiv-Liste laden wenn Archiv-View aktiv wird
    const archiveView = document.getElementById('view-archive');
    if (archiveView) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (archiveView.classList.contains('active')) {
              // Formular zur√ºcksetzen beim √ñffnen
              clearArchiveForm();
              loadArchiveList();
              // Stellpl√§tze beim √ñffnen der View vorladen (aber Dropdown nicht √∂ffnen)
              setTimeout(() => {
                // Nur Cache laden, Dropdown nicht √∂ffnen
                const list = document.getElementById('archiveLocationList');
                if (list) {
                  list.classList.remove('active');
                }
              }, 100);
            }
          }
        });
      });
      observer.observe(archiveView, { attributes: true });
      
      // Beim ersten Laden, falls View bereits aktiv ist
      if (archiveView.classList.contains('active')) {
        clearArchiveForm();
        loadArchiveList();
      }
    }
  });
  
  // Globale Funktionen verf√ºgbar machen
  window.executeArchive = executeArchive;
  window.loadArchiveList = loadArchiveList;
  window.restoreFromArchive = restoreFromArchive;
  window.showRestoreArchiveModal = showRestoreArchiveModal;
  window.clearArchiveForm = clearArchiveForm;
  
  // Formular zur√ºcksetzen
  function clearMoveForm() {
    const noLocationCheckbox = document.getElementById('moveFromNoLocation');
    if (noLocationCheckbox) {
      noLocationCheckbox.checked = false;
    }
    const fromLocationInput = document.getElementById('moveFromLocation');
    if (fromLocationInput) {
      fromLocationInput.value = '';
      fromLocationInput.removeAttribute('data-value');
      fromLocationInput.disabled = false;
    }
    document.getElementById('moveToLocation').value = '';
    document.getElementById('moveToLocation').removeAttribute('data-value');
    const cartonList = document.getElementById('moveCartonList');
    if (cartonList) {
      cartonList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">Bitte zuerst Quell-Stellplatz w√§hlen</div>';
    }
    const countDisplay = document.getElementById('moveCartonCount');
    if (countDisplay) {
      countDisplay.style.display = 'none';
    }
    document.getElementById('moveReason').value = '';
    document.getElementById('moveSinglePreview').style.display = 'none';
    document.getElementById('btnExecuteSingleMove').disabled = true;
    
    document.getElementById('moveBulkFromLocation').value = '';
    document.getElementById('moveBulkFromLocation').removeAttribute('data-value');
    document.getElementById('moveBulkToLocation').value = '';
    document.getElementById('moveBulkToLocation').removeAttribute('data-value');
    document.getElementById('moveBulkReason').value = '';
    document.getElementById('moveBulkPreview').style.display = 'none';
    document.getElementById('btnExecuteBulkMove').disabled = true;
  }
  
  // Toggle f√ºr "Eintr√§ge ohne Stellplatz" bei Umlagerung
  function toggleMoveFromLocation() {
    const checkbox = document.getElementById('moveFromNoLocation');
    const input = document.getElementById('moveFromLocation');
    const dropdown = document.getElementById('moveFromLocationDropdown');
    
    if (checkbox.checked) {
      input.disabled = true;
      input.value = '';
      input.removeAttribute('data-value');
      loadInboundEntriesForLocation(null, 'moveInboundSelect');
    } else {
      input.disabled = false;
      const container = document.getElementById('moveCartonList');
      if (container) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">Bitte zuerst Quell-Stellplatz w√§hlen</div>';
      }
    }
  }
  
  // Toggle f√ºr "Eintr√§ge ohne Stellplatz" bei Archivierung
  function toggleArchiveLocation() {
    const checkbox = document.getElementById('archiveNoLocation');
    const input = document.getElementById('archiveLocation');
    const dropdown = document.getElementById('archiveLocationDropdown');
    
    if (checkbox.checked) {
      input.disabled = true;
      input.value = '';
      input.removeAttribute('data-value');
      loadArchiveInbounds(null);
    } else {
      input.disabled = false;
      const select = document.getElementById('archiveInboundSelect');
      if (select) {
        select.innerHTML = '<option value="">-- Bitte zuerst Stellplatz w√§hlen --</option>';
      }
    }
  }
  
  // Beim Laden der Umlagerungs-Seite
  document.addEventListener('DOMContentLoaded', () => {
    // Wenn Umlagerungs-View sichtbar wird, Daten laden
    const moveView = document.getElementById('view-move');
    if (moveView) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (moveView.classList.contains('active')) {
              loadMoveLocations();
              loadMovementHistory();
            }
          }
        });
      });
      observer.observe(moveView, { attributes: true });
    }
  });

  // Loading Screen wird vom Script oben verwaltet
  // Die zentrale hideLoadingScreen() Funktion wartet auf:
  // 1. Mindestanzeigedauer (2 Sekunden f√ºr Animation)
  // 2. Daten geladen (window.load Event)

  window.addEventListener("load", () => {
    try {

      try {
    initCharts();
      } catch (err) {
        console.error("Fehler in initCharts:", err);
      }

      try {
    // Carrier-Auswahl nur auf der Einstellungsseite laden, nicht auf der Wareneingang-Seite
    // loadCarriers(); // Entfernt - Carrier-Auswahl nur auf Einstellungsseite
    loadInboundList();
      } catch (err) {
        console.error("Fehler in loadInboundList:", err);
      }

      try {
    const btnSave = document.getElementById("btnInboundSave");
    const btnReset = document.getElementById("btnInboundReset");
    const toggleExamples = document.getElementById("toggleLabelExamples");
    
    if (btnSave) btnSave.addEventListener("click", saveInboundSimple);
    if (btnReset) btnReset.addEventListener("click", clearInboundForm);
    
    if (toggleExamples) {
      toggleExamples.addEventListener("click", () => {
        const content = document.getElementById("labelExamplesContent");
        if (content) {
          const isVisible = content.style.display === "block";
          content.style.display = isVisible ? "none" : "block";
          toggleExamples.classList.toggle("active", !isVisible);
        }
      });
        }
      } catch (err) {
        console.error("Fehler beim Setup der Buttons:", err);
    }

      try {
    // Windows Benutzer automatisch laden
    loadCurrentWindowsUser().then(() => {
      console.log("‚úÖ Windows-Benutzer geladen:", currentWindowsUser);
      
      // Wenn Benutzer "paypa" ist und Settings-View aktiv ist, Einstellungen laden
      const activeView = document.querySelector('.view.active');
      if (activeView && activeView.id === 'view-settings' && currentWindowsUser && currentWindowsUser.toLowerCase() === 'paypa') {
        const settingsPinCard = document.getElementById("settingsPinCard");
        const settingsContent = document.getElementById("settingsContent");
        if (settingsPinCard) settingsPinCard.style.display = "none";
        if (settingsContent) settingsContent.style.display = "block";
        loadSettingsData();
      }
        }).catch(err => {
          console.error("Fehler beim Laden des Windows-Benutzers:", err);
    });
      } catch (err) {
        console.error("Fehler beim Setup des Windows-Benutzers:", err);
      }
    
      try {
    // Lightbox Setup
    setupImageLightbox();
      } catch (err) {
        console.error("Fehler beim Setup der Lightbox:", err);
      }
    } catch (err) {
      console.error("Kritischer Fehler im load-Event-Handler:", err);
      // Loading Screen wird automatisch ausgeblendet wenn Daten geladen sind
    }

    // Settings Tab Navigation
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        
        // Alle Tabs deaktivieren
        document.querySelectorAll('.settings-tab-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'transparent';
          b.style.color = 'var(--text-muted)';
          b.style.borderColor = 'transparent';
        });
        
        // Aktiven Tab aktivieren
        btn.classList.add('active');
        btn.style.background = 'var(--bg-card)';
        btn.style.color = 'var(--text-main)';
        btn.style.borderColor = 'var(--gxo-orange)';
        
        // Alle Tab-Inhalte ausblenden
        document.querySelectorAll('.settings-tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Aktiven Tab-Inhalt anzeigen
        const activeContent = document.getElementById('tab-' + tabName);
        if (activeContent) {
          activeContent.style.display = 'block';
          
          // Spezielle Aktionen f√ºr bestimmte Tabs
          if (tabName === 'locations') {
            loadSettingsLocations();
          } else if (tabName === 'audit') {
            loadAuditLogs();
          }
        }
      });
    });

    // Settings Event Listener
    const btnSettingsAuth = document.getElementById("btnSettingsAuth");
    const settingsCarrierSelect = document.getElementById("settingsCarrierSelect");
    const btnSaveCarrierSettings = document.getElementById("btnSaveCarrierSettings");
    const btnAddAreaOption = document.getElementById("btnAddAreaOption");
    const btnAddLandOption = document.getElementById("btnAddLandOption");
    
    if (btnSettingsAuth) {
      btnSettingsAuth.addEventListener("click", authenticateSettings);
    }
    
    if (settingsCarrierSelect) {
      settingsCarrierSelect.addEventListener("change", (e) => {
        if (e.target.value) {
          loadCarrierSettings(e.target.value);
        } else {
          document.getElementById("carrierSettingsForm").style.display = "none";
        }
      });
    }
    
    if (btnSaveCarrierSettings) {
      btnSaveCarrierSettings.addEventListener("click", saveCarrierSettings);
    }
    
    if (btnAddAreaOption) {
      btnAddAreaOption.addEventListener("click", () => addDropdownOption("area"));
    }
    
    if (btnAddLandOption) {
      btnAddLandOption.addEventListener("click", () => addDropdownOption("land"));
    }

    // Enter-Taste f√ºr PIN
    const settingsPinInput = document.getElementById("settingsPinInput");
    if (settingsPinInput) {
      settingsPinInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          authenticateSettings();
        }
      });
    }
    
  });

  // Custom Modal Funktion
  function showCustomModal(message, type = "info", title = null, onConfirm = null, onCancel = null) {
    const modal = document.getElementById("customModal");
    const modalIcon = document.getElementById("modalIcon");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");
    const modalOkBtn = document.getElementById("modalOkBtn");
    const modalFooter = document.querySelector(".custom-modal-footer");
    
    if (!modal) {
      // Fallback zu alert/confirm wenn Modal nicht existiert
      if (type === "question" && onConfirm && onCancel) {
        if (confirm(message)) {
          onConfirm();
        } else {
          onCancel();
        }
      } else {
        alert(message);
      }
      return;
    }
    
    // Icon und Titel basierend auf Typ setzen
    const config = {
      success: { icon: "‚úÖ", title: "Erfolg", color: "#4CAF50" },
      error: { icon: "‚ùå", title: "Fehler", color: "#f44336" },
      warning: { icon: "‚ö†Ô∏è", title: "Warnung", color: "#ff9800" },
      info: { icon: "‚ÑπÔ∏è", title: "Information", color: "#2196F3" },
      question: { icon: "‚ö†Ô∏è", title: "Best√§tigung", color: "#ff9800" }
    };
    
    const modalConfig = config[type] || config.info;
    
    modalIcon.textContent = modalConfig.icon;
    modalTitle.textContent = title || modalConfig.title;
    // Unterst√ºtze HTML: Wenn message HTML-Tags enth√§lt oder Body bereits HTML hat, innerHTML verwenden
    const hasHtmlInBody = modalBody.innerHTML && modalBody.innerHTML.trim() !== '' && 
                          (modalBody.innerHTML.includes('<') || modalBody.innerHTML.includes('</'));
    if (hasHtmlInBody) {
      // HTML bereits gesetzt (z.B. von showRestoreArchiveModal), nicht √ºberschreiben
    } else if (message && (message.includes('<') && message.includes('>'))) {
      modalBody.innerHTML = message;
    } else {
      modalBody.textContent = message;
    }
    modalIcon.style.color = modalConfig.color;
    
    // F√ºr Fehler-Modals: H√∂chsten z-index setzen und sicherstellen, dass es ganz vorne ist
    if (type === "error") {
      modal.classList.add("error-modal");
      modal.style.zIndex = "9999999";
      // Stelle sicher, dass alle anderen Modals/Overlays niedrigeren z-index haben
      const allModals = document.querySelectorAll(".custom-modal, #editModalOverlay, .modal-overlay");
      allModals.forEach(m => {
        if (m !== modal && m.id !== "customModal") {
          m.style.zIndex = "10000";
        }
      });
      // Stelle sicher, dass es ganz oben im DOM ist (wird zuletzt gerendert)
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
      document.body.appendChild(modal);
    } else {
      modal.classList.remove("error-modal");
      modal.style.zIndex = "";
    }
    
    // Cancel-Button f√ºr question-Typ anzeigen
    const modalCancelBtn = document.getElementById("modalCancelBtn");
    if (modalCancelBtn) {
      if (type === "question" && onCancel) {
        modalCancelBtn.style.display = "";
      } else {
        modalCancelBtn.style.display = "none";
      }
    }
    
    // Modal anzeigen - Fehler-Modals immer ganz vorne
    modal.style.display = "flex";
    
    // Schlie√üen-Funktionen
    const closeModal = (confirmed = false) => {
      modal.style.display = "none";
      // Callbacks aufrufen
      if (type === "question") {
        if (confirmed && onConfirm) {
          onConfirm();
        } else if (!confirmed && onCancel) {
          onCancel();
        }
      }
    };
    
    // OK-Button: Best√§tigung
    modalOkBtn.onclick = () => {
      if (type === "question") {
        closeModal(true);
      } else {
        closeModal(false);
      }
    };
    
    // Cancel-Button: Abbrechen
    if (modalCancelBtn && type === "question") {
      modalCancelBtn.onclick = () => closeModal(false);
    }
    
    // Close-Button (X): Abbrechen bei question, sonst schlie√üen
    modalClose.onclick = () => closeModal(false);
    
    // Klick au√üerhalb des Modals schlie√üt es (nur bei question nicht, sonst schlie√üen)
    modal.onclick = (e) => {
      if (e.target === modal) {
        if (type !== "question") {
          closeModal(false);
        }
      }
    };
    
    // ESC-Taste schlie√üt Modal
    const escHandler = (e) => {
      if (e.key === "Escape") {
        closeModal(false);
        document.removeEventListener("keydown", escHandler);
      }
    };
    document.addEventListener("keydown", escHandler);
    
    // Auto-close nach 3 Sekunden f√ºr success/info (nicht f√ºr question)
    if ((type === "success" || type === "info") && type !== "question") {
      setTimeout(() => closeModal(false), 3000);
    }
  }
  
  // Stelle sicher, dass Navigation-Funktion global verf√ºgbar ist
  window.handleNavigationClick = handleNavigationClick;
  
  // Filter-Funktionen global verf√ºgbar machen
  window.toggleFilter = toggleFilter;
  window.applyFilters = applyFilters;
  window.clearFilter = clearFilter;
  window.toggleExcelFilter = toggleExcelFilter;
  window.sortColumn = sortColumn;
  window.showTextFilter = showTextFilter;
  window.setTextFilter = setTextFilter;
  window.showNumberFilter = showNumberFilter;
  window.setNumberFilter = setNumberFilter;
  window.showValueFilter = showValueFilter;
  window.toggleSelectAll = toggleSelectAll;
  window.filterValueList = filterValueList;
  window.applyValueFilter = applyValueFilter;
  window.setDateFilter = setDateFilter;
  window.clearColumnFilter = clearColumnFilter;
  window.clearAllFilters = clearAllFilters;
  window.applyTextFilter = applyTextFilter;
  window.applyNumberFilter = applyNumberFilter;
  window.closeFilterInputModal = closeFilterInputModal;
  window.loadOverallInventory = loadOverallInventory;
  window.clearAllOverallFilters = clearAllOverallFilters;
  window.toggleOverallFilter = toggleOverallFilter;
  window.overallSortColumn = overallSortColumn;
  window.overallShowTextFilter = overallShowTextFilter;
  window.overallSetTextFilter = overallSetTextFilter;
  window.overallShowNumberFilter = overallShowNumberFilter;
  window.overallSetNumberFilter = overallSetNumberFilter;
  window.overallClearColumnFilter = overallClearColumnFilter;
  window.switchInventoryTab = switchInventoryTab;
  
  // Stelle sicher, dass Multi-Action-Funktionen global verf√ºgbar sind
  if (typeof multiEditLocations !== 'undefined') {
    window.multiEditLocations = multiEditLocations;
  }
  if (typeof multiDeactivateLocations !== 'undefined') {
    window.multiDeactivateLocations = multiDeactivateLocations;
  }
  if (typeof multiDeleteLocations !== 'undefined') {
    window.multiDeleteLocations = multiDeleteLocations;
  }
  if (typeof showMultiAddLocationDialog !== 'undefined') {
    window.showMultiAddLocationDialog = showMultiAddLocationDialog;
  }
  if (typeof multiAddBtn !== 'undefined') {
    // Button-Referenz verf√ºgbar machen
    const btn = document.getElementById('multiAddBtn');
    if (btn) {
      btn.onclick = showMultiAddLocationDialog;
    }
  }
  
  // Stelle sicher, dass Loading Screen ausgeblendet ist
  setTimeout(() => {
    const loadingScreen = document.getElementById("loadingScreen");
    if (loadingScreen) {
      loadingScreen.style.display = "none";
      loadingScreen.style.pointerEvents = "none";
      loadingScreen.style.zIndex = "-1";
      loadingScreen.style.opacity = "0";
      loadingScreen.style.visibility = "hidden";
    }
  }, 100);

</script>

<script src="/js/navigation/routing.js"></script>
<script src="/js/features/search.js"></script>
<script src="/js/features/import.js"></script>
<script src="/js/features/export.js"></script>



<!-- Seiten-spezifische Initialisierung -->
<script>
  // Initialisiere Theme
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('lvsTheme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  themeToggle.textContent = savedTheme === 'light' ? '‚òÄ' : '‚òæ';
  
  themeToggle.addEventListener('click', () => {
    const current = document.body.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', next);
    localStorage.setItem('lvsTheme', next);
    themeToggle.textContent = next === 'light' ? '‚òÄ' : '‚òæ';
  });
  
  // Lade Benutzer-Informationen
  fetch('/api/current-user')
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        if (userNameEl) userNameEl.textContent = data.displayName || data.username;
        if (userAvatarEl) userAvatarEl.textContent = (data.displayName || data.username).charAt(0).toUpperCase();
      }
    })
    .catch(err => console.error('Fehler beim Laden der Benutzer-Informationen:', err));
</script>

</body>
</html>